
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction par l'exemple à Entity Framework 5 Code First">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/ef5cf-oct-2012/etude-de-cas-avec-sql-server-express-2012.html">
      
      
        <link rel="prev" href="letude-de-cas.html">
      
      
        <link rel="next" href="etude-de-cas-avec-mysql-5528.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>3. Etude de cas avec SQL Server Express 2012 - Introduction par l'exemple à Entity Framework 5 Code First</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBZC3JVJNR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    var siteName = "Introduction par l'exemple à Entity Framework 5 Code First";
    gtag('config', 'G-EBZC3JVJNR', {
        'page_title': siteName
    });
  </script>

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-etude-de-cas-avec-sql-server-express-2012" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction par l&#39;exemple à Entity Framework 5 Code First" class="md-header__button md-logo" aria-label="Introduction par l'exemple à Entity Framework 5 Code First" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction par l'exemple à Entity Framework 5 Code First
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. Etude de cas avec SQL Server Express 2012
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/ef5cf-oct-2012" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction par l&#39;exemple à Entity Framework 5 Code First" class="md-nav__button md-logo" aria-label="Introduction par l'exemple à Entity Framework 5 Code First" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction par l'exemple à Entity Framework 5 Code First
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/ef5cf-oct-2012" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="introduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="letude-de-cas.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. L'étude de cas
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    3. Etude de cas avec SQL Server Express 2012
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="etude-de-cas-avec-sql-server-express-2012.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Etude de cas avec SQL Server Express 2012
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-installation-des-outils" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2. Installation des outils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-le-serveur-embarque-localdbv110" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3. Le serveur embarqué (localdb)\v11.0
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34-creation-de-la-base-a-partir-des-entites" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4. Création de la base à partir des entités
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4. Création de la base à partir des entités">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#341-lentite-medecin" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.1. L&#x27;entité [Medecin]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#342-lentite-creneau" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.2. L&#x27;entité [Creneau]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#343-les-entites-client-et-rv" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.3. Les entités [Client] et [Rv]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#344-fixer-le-nom-de-la-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.4. Fixer le nom de la base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#345-remplissage-de-la-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.5. Remplissage de la base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#346-modification-des-entites" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.6. Modification des entités
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#347-ajouter-des-contraintes-a-la-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.7. Ajouter des contraintes à la base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#348-la-base-definitive" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.8. La base définitive
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#35-exploitation-de-la-base-avec-entity-framework" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5. Exploitation de la base avec Entity Framework
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5. Exploitation de la base avec Entity Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#351-suppression-delements-du-contexte-de-persistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.1. Suppression d&#x27;éléments du contexte de persistance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#352-ajout-delements-au-contexte-de-persistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.2. Ajout d&#x27;éléments au contexte de persistance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#353-affichage-du-contenu-de-la-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.3. Affichage du contenu de la base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#354-apprentissage-de-linq-avec-linqpad" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.4. Apprentissage de LINQ avec LINQPad
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#355-modification-dune-entite-attachee-au-contexte-de-persistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.5. Modification d&#x27;une entité attachée au contexte de persistance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#356-gestion-des-entites-detachees" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.6. Gestion des entités détachées
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#357-lazy-et-eager-loading" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.7. Lazy et Eager Loading
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#358-concurrence-dacces-aux-entites" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.8. Concurrence d&#x27;accès aux entités
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#359-synchronisation-dans-une-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.9. Synchronisation dans une transaction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#36-etude-dune-architecture-multi-couche-sappuyant-sur-ef-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6. Etude d&#x27;une architecture multi-couche s&#x27;appuyant sur EF 5
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.6. Etude d&#39;une architecture multi-couche s&#39;appuyant sur EF 5">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#361-le-nouveau-projet" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.1. Le nouveau projet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#362-la-classe-exception" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.2. La classe Exception
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#363-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.3. La couche [DAO]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#364-test-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.4. Test de la couche [DAO]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#365-configuration-de-springnet" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.5. Configuration de Spring.net
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#366-generation-de-la-dll-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.6. Génération de la DLL de la couche [DAO]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#367-la-couche-aspnet" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6.7. La couche [ASP.NET]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#37-conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.7. Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="etude-de-cas-avec-mysql-5528.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Etude de cas avec MySQL 5.5.28
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="etude-de-cas-avec--oracle-database-express-edition-11g-release-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Etude de cas avec  Oracle Database Express Edition 11g Release 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="etude-de-cas-avec--postgresql-921.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Etude de cas avec  PostgreSQL 9.2.1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="etude-de-cas-avec--firebird-21.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Etude de cas avec  Firebird 2.1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="3-etude-de-cas-avec-sql-server-express-2012">3. Etude de cas avec SQL Server Express 2012</h1>
<h2 id="31-introduction">3.1. Introduction</h2>
<p>Les exemples trouvés sur le net pour Entity Framework sont dans leur majorité des exemples avec SQL Server. C&#x27;est assez normal. Il est probable que c&#x27;est le SGBD le plus répandu dans le monde .NET des entreprises. Nous allons suivre cette tendance. Les exemples seront ensuite étendus à toutes les bases de données citées au paragraphe 1.2.</p>
<h2 id="32-installation-des-outils">3.2. Installation des outils</h2>
<p>Nous ne décrirons pas l&#x27;installation des outils. En effet, cela nécessiterait énormément de copies d&#x27;écran qui deviennent assez vite obsolètes. C&#x27;est une tâche (pas toujours facile, il est vrai) que nous laissons au lecteur.</p>
<p>Il nous faut installer les outils suivants :</p>
<ul>
<li>le SGBD SQL Server Express 2012 : [http://www.microsoft.com/fr-fr/download/details.aspx?id=29062]. Télécharger la version &quot; With Tools &quot; qui amène avec le SGBD un outil d&#x27;administration :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002870000002B2FDCC0DB.png" style="display:inline-block; margin:4px;width:11.98cm;height:0.801cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Une fois le SGBD installé, nous le lançons :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000698000001FB14C0E587.png" style="display:inline-block; margin:4px;width:15.63cm;height:4.701cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002FB0000012A164EF0C6.png" style="display:inline-block; margin:4px;width:7.07cm;height:2.76cm;" /></td></tr></table>

<ul>
<li>[1] : dans le Menu Démarrer, lancer le &quot; Gestionnaire de configuration SQL Server &quot; ;</li>
<li>[2] : dans ce gestionnaire, lancer le serveur ;</li>
<li>[3] : il est lancé.</li>
</ul>
<p>Nous lançons maintenant l&#x27;outil d&#x27;administration de SQL Server :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006B400000166E491DD3D.png" style="display:inline-block; margin:4px;width:15.891cm;height:3.311cm;" /></td></tr></table>

<ul>
<li>[1] : dans le Menu Démarrer, lancer &quot; SQL Server Management Studio &quot; ;</li>
<li>[2] : l&#x27;outil d&#x27;administration.</li>
</ul>
<p>Nous allons nous connecter au serveur :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000068A000002DAA7D2D4EA.png" style="display:inline-block; margin:4px;width:15.499cm;height:6.759cm;" /></td></tr></table>

<ul>
<li>en [1], on connecte l&#x27;explorateur d&#x27;objets ;</li>
<li>en [2], on donne les paramètres de la connexion :</li>
<li>[3] : le serveur <strong>(local)</strong> (attention aux parenthèses nécessaires) désigne le serveur installé sur la machine,</li>
<li>[4] : on choisit l&#x27;authentification Windows. Il faut être administrateur de son poste pour que cette connexion réussisse,</li>
<li>[5] : on se connecte ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000074B0000041EC1293917.png" style="display:inline-block; margin:4px;width:17.29cm;height:9.76cm;" /></td></tr></table>

<ul>
<li>[6] : on est connecté ;</li>
<li>[7] : on veut modifier certaines propriétés du serveur ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000007EC0000049F6E1AC0D8.png" style="display:inline-block; margin:4px;width:17.999cm;height:10.499cm;" /></td></tr></table>

<ul>
<li>[8] : on demande à ce qu&#x27;il y ait deux modes d&#x27;authentification :</li>
<li>authentification Windows comme il vient d&#x27;être utilisé. Un utilisateur windows avec les bons droits peut alors se connecter,</li>
<li>authentification SQL Server. L&#x27;utilisateur doit faire partie des utilisateurs enregistrés dans le SGBD ;</li>
</ul>
<p>Ceci fait, on peut valider les propriétés du serveur ;</p>
<ul>
<li>[9] : on édite les propriétés de l&#x27;utilisateur <strong>sa</strong> (<strong>s</strong>ystem <strong>a</strong>dministrator) ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004EC000001D969BB86AF.png" style="display:inline-block; margin:4px;width:11.67cm;height:4.38cm;" /></td></tr></table>

<ul>
<li>en [10], on lui fixe un mot de passe. Dans la suite du document, celui-ci est <strong>sqlserver2012</strong> ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000007130000025C99EB49BD.png" style="display:inline-block; margin:4px;width:16.769cm;height:5.59cm;" /></td></tr></table>

<ul>
<li>en [10], on lui donne l&#x27;autorisation de se connecter ;</li>
<li>en [11], la connexion est activée. Ceci fait l&#x27;assistant peut être validé ;</li>
<li>en [12], on se déconnecte du serveur.</li>
</ul>
<p>Maintenant, nous nous reconnectons avec le login sa/sqlserver2012 :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000073C000002B5165876DB.png" style="display:inline-block; margin:4px;width:17.15cm;height:6.421cm;" /></td></tr></table>

<ul>
<li>en [1], on se reconnecte ;</li>
<li>en [2], en authentification SQL Server ;</li>
<li>en [3], l&#x27;utilisateur est sa ;</li>
<li>en [4], son mot de passe est sqlserver2012 ;</li>
<li>en [5], on se connecte ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000022C0000022C6D3F7D2A.png" style="display:inline-block; margin:4px;width:5.151cm;height:5.151cm;" /></td></tr></table>

<ul>
<li>en [6], on est connecté.</li>
</ul>
<p>Nous allons maintenant créer une base de démonstration :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006550000040729FE799B.png" style="display:inline-block; margin:4px;width:15.011cm;height:9.55cm;" /></td></tr></table>

<ul>
<li>en [1], on crée une nouvelle BD ;</li>
<li>en [2], elle s&#x27;appellera <strong>demo</strong> ;</li>
<li>en [3], on valide ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005020000026069C78F84.png" style="display:inline-block; margin:4px;width:16.96cm;height:8.043cm;" /></td></tr></table>

<ul>
<li>en [4], la base créée ;</li>
<li>en [5], on crée une nouvelle table à la base <em>demo</em> ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000564000000CDEE2B3226.png" style="display:inline-block; margin:4px;width:17.999cm;height:2.674cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005910000011088D78731.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.434cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004DA0000015D14457F53.png" style="display:inline-block; margin:4px;width:16.431cm;height:4.618cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000027C0000015A10ED80C4.png" style="display:inline-block; margin:4px;width:8.414cm;height:4.577cm;" /></td></tr></table>

<ul>
<li>en [6], on définit une table à deux colonnes ID et NOM ;</li>
<li>en [7], on fait de la colonne [ID] la clé primaire ;</li>
<li>en [8], la clé primaire est symbolisée par une clé ;</li>
<li>en [9], on sauvegarde la table ;</li>
<li>en [10], on lui donne un nom ;</li>
<li>en [11], pour que la table apparaisse dans la base [demo], il faut actualiser la base ;</li>
<li>en [12], la table [PERSONNES] a bien été créée.</li>
</ul>
<p>Nous en savons assez pour l&#x27;instant sur l&#x27;utilisation de l&#x27;outil d&#x27;administration de SQL Server.</p>
<h2 id="33-le-serveur-embarque-localdbv110">3.3. Le serveur embarqué (localdb)\v11.0</h2>
<p>VS Express 2012 vient avec un serveur SQL embarqué. On suppose ici que VS Express 2012 a été installé [http://www.microsoft.com/visualstudio/fra/downloads]. On lance VS 2012 [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000059A000001BCE4849A4C.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.572cm;" /></td></tr></table>

<p>On lance l&#x27;outil d&#x27;administration de SQL Server 2012 [2] et on se connecte [3].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005BA0000024604CF5E01.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.144cm;" /></td></tr></table>

<ul>
<li>en [4], on se connecte au serveur <strong>(localdb)\v11.0</strong> ;</li>
<li>en [5], avec une authentification Windows ;</li>
<li>en [6], la connexion réussie affiche les bases de données du serveur. On pourrait comme précédemment créer une nouvelle base.</li>
</ul>
<p>Nous n&#x27;utiliserons pas ce serveur embarqué dans VS 2012.</p>
<h2 id="34-creation-de-la-base-a-partir-des-entites">3.4. Création de la base à partir des entités</h2>
<p>Entity Framework 5 Code First permet de créer une base de données à partir des entités. C&#x27;est ce que nous voyons maintenant. Avec VS Express 2012, nous créons un premier projet console en C# :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000617000002B1E47053BB.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.953cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001B9000000D489C50F7E.png" style="display:inline-block; margin:4px;width:5.835cm;height:2.805cm;" /></td></tr></table>

<ul>
<li>en [1], la définition du projet ;</li>
<li>en [2], le projet créé.</li>
</ul>
<p>Tous nos projets vont avoir besoin de la DLL d&#x27;Entity Framework 5. Nous l&#x27;ajoutons :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003300000015BE45B3370.png" style="display:inline-block; margin:4px;width:10.795cm;height:4.591cm;" /></td></tr></table>

<ul>
<li>en [1], l&#x27;outil NuGet permet de télécharger des dépendances ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000620000001B536C6F680.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.017cm;" /></td></tr></table>

<ul>
<li>en [2], on télécharge la dépendance Entity Framework ;</li>
<li>en [3], la référence a été ajoutée au projet.</li>
</ul>
<p>On peut en savoir plus en regardant les propriétés de la référence ajoutée :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005200000026C13632CE4.png" style="display:inline-block; margin:4px;width:17.357cm;height:8.202cm;" /></td></tr></table>

<ul>
<li>en [1], la version de la DLL. Il faut la version 5 ;</li>
<li>en [2], sa place dans le système de fichiers : &lt;solution&gt;\packages\EntityFramework.5.0.0\lib\net45\EntityFramework.dll où &lt;solution&gt; est le dossier de la solution VS. Tous les packages ajoutés par NuGet iront dans le dossier &lt;solution&gt;/packages ;</li>
<li>en [3], un fichier [packages.config] a été créé. Son contenu est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">&lt;packages&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;package</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;EntityFramework&quot;</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;5.0.0&quot;</span><span class="w"> </span><span class="na">targetFramework=</span><span class="s">&quot;net45&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">&lt;/packages&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Il liste les paquetages importés par NuGet.</p>
<p>Revenons au projet VS et créons un dossier [Models] dans le projet :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005CD000001CC38E39D42.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.574cm;" /></td></tr></table>

<ul>
<li>en [1], ajout d&#x27;un dossier au projet ;</li>
<li>en [2], il s&#x27;appellera [Models].</li>
</ul>
<p>Nous garderons cette habitude par la suite de mettre la définition de nos entités dans le dossier [Models].</p>
<p>Pour construire nos entités, nous allons nous aider de la définition de la base de données MySQL 5 utilisée dans le projet NHibernate. Rappelons le rôle des entités EF :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005FB000000DB46B33DB3.png" style="display:inline-block; margin:4px;width:17.999cm;height:2.574cm;" /></td></tr></table>

<p>Les entités doivent refléter les tables de la base de données. La couche d&#x27;accès aux données utilise ces entités au lieu de travailler directement avec les tables. Commençons par la table [MEDECINS] :</p>
<h3 id="341-lentite-medecin">3.4.1. L&#x27;entité [Medecin]</h3>
<p>Elle contient des informations sur les médecins gérés par l&#x27;application [RdvMedecins].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000013B0000009140E8B0E1.png" style="display:inline-block; margin:4px;width:5.83cm;height:2.679cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001830000006A63E8B6FD.png" style="display:inline-block; margin:4px;width:7.17cm;height:1.96cm;" /></td></tr></table>

<ul>
<li>ID : n° identifiant le médecin - clé primaire de la table</li>
<li>VERSION : n° identifiant la version de la ligne dans la table. Ce nombre est incrémenté de 1 à chaque fois qu&#x27;une modification est apportée à la ligne.</li>
<li>NOM : le nom du médecin</li>
<li>PRENOM : son prénom</li>
<li>TITRE : son titre (Melle, Mme, Mr)</li>
</ul>
<p>Nous pourrions partir de la classe [Medecin] suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">[Table(&quot;MEDECINS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 3 : la classe [Medecin] est associée à la table [MEDECINS] de la base de données. Celle-ci se trouvera dans un schéma nommé &quot; dbo &quot;.</li>
</ul>
<p>Nous mettons cette classe dans un fichier [Entites.cs] [1]. C&#x27;est là que nous placerons toutes nos entités.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000019E000001514A21FEAA.png" style="display:inline-block; margin:4px;width:5.477cm;height:4.459cm;" /></td></tr></table>

<p>Toujours dans le dossier [Models], nous créons le fichier [Context.cs] suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data.Entity</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="c1">// le contexte</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsContext</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DbContext</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="c1">// les médecins</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Medecins</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="c1">// initialisation de la base</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsInitializer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DropCreateDatabaseAlways</span><span class="o">&lt;</span><span class="n">RdvMedecinsContext</span><span class="o">&gt;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 8 : la classe [RdvMedecinsContext] va représenter le contexte de persistance, c.-à-d. l&#x27;ensemble des entités gérées par l&#x27;ORM. Elle doit dériver de la classe [System.Data.Entity.DbContext] ;</li>
<li>ligne 11 : le champ [Medecins] va représenter les entités de type [Medecin] du contexte de persistance. Il est de type <em>DbSet&lt;Medecin&gt;</em>. On trouvera généralement autant de [DbSet] que de tables dans la base, un par table ;</li>
<li>ligne 15 : on définit une classe [RdvMedecinsInitializer] pour initialiser la base créée. Ici elle dérive de la classe [DropCreateDataBaseAlways] qui comme son nom l&#x27;indique supprime la base si elle existe déjà puis la recrée. C&#x27;est pratique en phase de développement de la BD. Le paramètre de la classe [DropCreateDataBaseAlways] est le type de contexte de persistance associé à la base. On peut utiliser d&#x27;autres classes mères que [DropCreateDataBaseAlways] pour la classe d&#x27;initialisation :</li>
<li>[DropCreateDatabaseIfModelChanges] : recrée la base si les entités ont changé,</li>
<li>[CreateDatabaseIfNotExists] : crée la base si elle n&#x27;existe pas ;</li>
</ul>
<p>Il nous reste à créer un programme principal. Ce sera le suivant [CreateDB_01.cs] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data.Entity</span><span class="p">;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">{</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">CreateDB_01</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="c1">// on crée la base</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">      </span><span class="n">Database</span><span class="p">.</span><span class="n">SetInitializer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsInitializer</span><span class="p">());</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 12 : [System.Data.Entity.DataBase] est une classe offrant des méthodes statiques pour gérer la base associée à un contexte de persistance. La méthode statique [SetInitializer] permet de préciser la classe d&#x27;initialisation de la base. Cela ne lance pas l&#x27;initialisation ;</li>
<li>ligne 13 : pour travailler avec un contexte de persistance, il faut instancier celui-ci. C&#x27;est ce qui est fait ici. On utilise une clause <strong>using</strong> afin que le contexte soit automatiquement fermé à la sortie de la clause. Donc ligne 17, le contexte est fermé ;</li>
<li>ligne 15 : on lance explicitement la génération de la base associée au contexte de persistance [RdvMedecinsContext]. Le paramètre <em>false</em> indique que cette opération ne doit pas être faite si elle a déjà été faite pour ce contexte. Ici, on aurait tout aussi bien pu mettre <em>true</em>.</li>
</ul>
<p>Lorsqu&#x27;on travaille avec une base de données, les paramètres de connexion sont généralement inscrits dans le fichier [App.config]. Constatons que pour l&#x27;instant, ils n&#x27;y sont pas :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">&lt;configSections&gt;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="cm">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span><span class="w"> </span><span class="na">requirePermission=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">&lt;/configSections&gt;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">&lt;startup&gt;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">&lt;supportedRuntime</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;v4.0&quot;</span><span class="w"> </span><span class="na">sku=</span><span class="s">&quot;.NETFramework,Version=v4.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nt">&lt;/startup&gt;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="nt">&lt;entityFramework&gt;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nt">&lt;defaultConnectionFactory</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="nt">&lt;/entityFramework&gt;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Les éléments ci-dessus ont été inscrits dans [App.config] lorsqu&#x27;on a ajouté la dépendance Entity Framework aux références du projet.</p>
<p>Exécutons le projet (Ctrl-F5) après avoir lancé SQL Server Express (c&#x27;est important) :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000D8000000D6B054E087.png" style="display:inline-block; margin:4px;width:4.001cm;height:3.96cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000288000000A598FA78A5.png" style="display:inline-block; margin:4px;width:12cm;height:3.06cm;" /></td></tr></table>

<p>L&#x27;exécution doit se terminer sans erreur. Ouvrons maintenant l&#x27;outil d&#x27;administration de SQL Server et rafraîchissons l&#x27;affichage :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002130000022408674EEE.png" style="display:inline-block; margin:4px;width:7.026cm;height:7.25cm;" /></td></tr></table>

<p>On constate qu&#x27;une base portant le nom complet de la classe [RdvMedecinsContext] a été créée et qu&#x27;elle contient une table [dbo.MEDECINS] (c&#x27;est le nom qu&#x27;on lui avait donné) avec des colonnes qui reprennent les noms des champs de l&#x27;entité [Medecin]. Si le code s&#x27;est bien exécuté et que la base ci-dessus n&#x27;apparaît pas, il faut regarder le serveur embarqué <strong>(localdb)\v11.0</strong> (cf. page 18). Avec VS 2012 pro, ce serveur est utilisé si SQL server n&#x27;est pas actif au moment de l&#x27;exécution du code. Avec VS 2012 Express, non.</p>
<p>Examinons la structure de la table [MEDECINS] :</p>
<ul>
<li>elle reprend les noms des champs de l&#x27;entité [Medecin] ;</li>
<li>la colonne [Id] est clé primaire. C&#x27;est une convention d&#x27;EF : si l&#x27;entité E a un champ Id ou Eid (MedecinId), alors cette colonne est clé primaire dans la table associée ;</li>
<li>les types des colonnes de la table sont ceux des champs de l&#x27;entité ;</li>
<li>pour les colonnes Titre, Nom, Prenom, un type [nvarchar(max)] a été utilisé. On pourrait être plus précis, 5 caractères pour le titre, 30 pour les nom et prénom ;</li>
<li>les colonnes Titre, Nom, Prenom peuvent avoir la valeur NULL. Nous allons changer cela.</li>
</ul>
<p>Regardons les propriétés de la clé primaire [Id] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000030F000001E4A1C4CE28.png" style="display:inline-block; margin:4px;width:10.359cm;height:6.403cm;" /></td></tr></table>

<p>En [1], on voit que la clé primaire est de type [Identité], ce qui signifie que sa valeur est automatiquement générée par SQL Server. Nous adopterons cette stratégie avec tous les SGBD.</p>
<p>Nous allons laisser moins de part aux conventions d&#x27;EF en utilisant des annotations. Le code de l&#x27;entité dans [Entites.cs] devient le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.ComponentModel.DataAnnotations.Schema</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">{</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="na">[Table(&quot;MEDECINS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">    </span><span class="na">[Column(&quot;VERSION&quot;)]</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 2 et 3 : les annotations sont trouvées dans les espaces de noms [System.ComponentModel.DataAnnotations] (Key, Required, MaxLength] et [System.ComponentModel.DataAnnotations.Schema] (Column). On trouvera d&#x27;autres annotations à l&#x27;URL [<a href="http://msdn.microsoft.com/en-us/data/gg193958.aspx">http://msdn.microsoft.com/en-us/data/gg193958.aspx</a>];</li>
<li>ligne 11 : [Key] désigne la clé primaire ;</li>
<li>ligne 12 : [Column] fixe le nom de la colonne correspondant au champ ;</li>
<li>ligne 14 : [Required] indique que le champ est obligatoire (SQL NOT NULL) ;</li>
<li>ligne 15 : [MaxLength] fixe la taille maxi de la chaîne de caractères, [MinLength] sa taille mini ;</li>
</ul>
<p>Exécutons le projet avec cette nouvelle définition de l&#x27;entité [Medecin]. La base créée est alors la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000013D000000EC14C31229.png" style="display:inline-block; margin:4px;width:5.87cm;height:4.369cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<ul>
<li>les colonnes ont le nom qu&#x27;on leur a fixé ;</li>
<li>l&#x27;annotation [Required] a été traduite par un SQL NOT NULL ;</li>
<li>l&#x27;annotation [MaxLength(N)] a été traduite par un type SQL nvarchar(N).</li>
</ul>
<p>Dans l&#x27;application NHibernate, la colonne [VERSION] était là pour prévenir les accès concurrents à une même ligne d&#x27;une table. Le principe est le suivant :</p>
<ul>
<li>un processus P1 lit une ligne L de la table [MEDECINS] au temps T1. La ligne a la version V1 ;</li>
<li>un processus P2 lit la même ligne L de la table [MEDECINS] au temps T2. La ligne a la version V1 parce que le processus P1 n&#x27;a pas encore validé sa modification ;</li>
<li>le processus P1 valide sa modification de la ligne L. La version de la ligne L passe alors à V2=V1+1 ;</li>
<li>le processus P2 valide sa modification de la ligne L. L&#x27;ORM lance alors une exception car le processus P2 a une version V1 de la ligne L différente de la version V2 trouvée en base.</li>
</ul>
<p>On appelle cela la <strong>gestion optimiste</strong> des accès concurrents. Avec EF 5, un champ jouant ce rôle doit avoir l&#x27;un des deux attributs [<strong>Timestamp</strong>] ou [<strong>ConcurrencyCheck</strong>]. SQL Server a un type [timestamp]. Une colonne ayant ce type voit sa valeur automatiquement générée par SQL Server à toute insertion / modification d&#x27;une ligne. Une telle colonne peut alors servir à gérer la concurrence d&#x27;accès. Pour reprendre l&#x27;exemple précédent, le processus P2 trouvera un t<em>imestamp</em> différent de celui qu&#x27;il a lu, car entre-temps la modification faite par le processus P1 l&#x27;aura modifié.</p>
<p>Notre entité [Medecin] évolue comme suit :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.ComponentModel.DataAnnotations.Schema</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="p">{</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="na">[Table(&quot;MEDECINS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 26-28 : la nouvelle colonne avec l&#x27;attribut [Timestamp] de la ligne 27. Le type du champ doit être <strong>byte[]</strong> (ligne 28). Le nom du champ peut être quelconque. On ne lui met pas l&#x27;attribut [Required] car ce n&#x27;est pas l&#x27;application qui fournira cette valeur mais le SGBD lui-même.</li>
</ul>
<p>Si on exécute le projet avec cette nouvelle entité, la base évolue comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000266000001A854D12094.png" style="display:inline-block; margin:4px;width:8.123cm;height:5.609cm;" /></td></tr></table>

<p>Il nous reste à régler un dernier point. Le contexte de persistance &quot; sait &quot; qu&#x27;une entité doit faire l&#x27;objet d&#x27;une insertion en base parce qu&#x27;alors elle a sa clé primaire égale à <strong>null</strong>. C&#x27;est l&#x27;insertion en base qui va donner une valeur à la clé primaire. Ici, le type <em>int</em> donné à la clé primaire [Id] ne convient pas parce que ce type n&#x27;accepte pas la valeur <em>null</em>. On lui donne alors le type <strong>int?</strong> qui accepte les valeurs <em>int</em> plus le pointeur <em>null</em>. L&#x27;entité [Medecin] utilisée sera donc la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span>
<span class="normal"><a href="#__codelineno-7-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="p">...</span>
</code></pre></div></td></tr></table></div>
<p>Il nous reste à voir comment représenter dans une entité le concept de clé étrangère entre tables.</p>
<h3 id="342-lentite-creneau">3.4.2. L&#x27;entité [Creneau]</h3>
<p>La table [CRENEAUX] liste les créneaux horaires où les RV sont possibles : </p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000170000000B33347BA3C.png" style="display:inline-block; margin:4px;width:6.819cm;height:3.311cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000064E00000180668CD311.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.281cm;" /></td></tr></table>

<ul>
<li>ID : n° identifiant le créneau horaire - clé primaire de la table</li>
<li>VERSION : n° identifiant la version de la ligne dans la table. Ce nombre est incrémenté de 1 à chaque fois qu&#x27;une modification est apportée à la ligne.</li>
<li>ID_MEDECIN : n° identifiant le médecin auquel appartient ce créneau – clé étrangère sur la colonne MEDECINS(ID).</li>
<li>HDEBUT : heure début créneau</li>
<li>MDEBUT : minutes début créneau</li>
<li>HFIN : heure fin créneau</li>
<li>MFIN : minutes fin créneau</li>
</ul>
<p>La seconde ligne de la table [CRENEAUX] (cf [1] ci-dessus) indique, par exemple, que le créneau n° 2 commence à 8 h 20 et se termine à 8 h 40 et appartient au médecin n° 1 (Mme Marie PELISSIER).</p>
<p>Avec ce que nous savons, nous pouvons définir l&#x27;entité [Creneau] comme suit dans [Entites.cs] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="na">[Table(&quot;CRENEAUX&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="na">[Column(&quot;HDEBUT&quot;)]</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Hdebut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="na">[Column(&quot;MDEBUT&quot;)]</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Mdebut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="na">[Column(&quot;HFIN&quot;)]</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Hfin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="na">[Column(&quot;MFIN&quot;)]</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Mfin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La seule nouveauté réside aux lignes 20-21. Le fait que la table [CRENEAUX] ait une clé étrangère sur la table [MEDECINS] est reflété dans l&#x27;entité [Creneau] par la présence d&#x27;une référence sur l&#x27;entité [Medecin], ligne 21. Le nom du champ importe peu, seul le type est important. La propriété <strong>doit être déclarée virtuelle</strong> avec le mot clé <em>virtual</em>. En effet, EF est amené à redéfinir toutes les propriétés dites <strong>navigationnelles</strong>, c&#x27;-a-d celles qui correspondent à une clé étrangère et qui permettent de passer d&#x27;une table à l&#x27;autre.</p>
<p>Pour tester la nouvelle entité, il nous faut faire quelques modifications dans [Context.cs] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data.Entity</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">{</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">  </span><span class="c1">// le contexte</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsContext</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DbContext</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="c1">// les entités</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Medecins</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">  </span><span class="c1">// initialisation de la base</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsInitializer</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="n">DropCreateDatabaseIfModelChanges</span><span class="o">&lt;</span><span class="n">RdvMedecinsContext</span><span class="o">&gt;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La ligne 12 reflète le fait que le contexte a une entité de plus à gérer. Lorsque nous exécutons le projet, nous obtenons la nouvelle base suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005C20000023E709E6258.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.008cm;" /></td></tr></table>

<p>La table [CRENEAUX] a bien été créée et la nouveauté est la présence d&#x27;une clé étrangère [1] et [2]. Son nom a été généré à partir du nom du champ correspondant dans l&#x27;entité (Medecin) suffixé par &quot; _Id &quot;. Pour connaître les propriétés de cette clé étrangère, on essaie de la modifier [3].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003FD000001D1E06B1768.png" style="display:inline-block; margin:4px;width:13.508cm;height:6.152cm;" /></td></tr></table>

<p>La copie d&#x27;écran ci-dessus montre que [Medecin_Id] est clé étrangère de la table [CRENEAUX] et qu&#x27;elle référence la clé primaire [ID] de la table [MEDECINS].</p>
<p>Si on crée les entités pour une base existante, la colonne clé étrangère ne s&#x27;appellera pas forcément [Medecin_Id]. Pour les autres colonnes, on avait vu que l&#x27;annotation [Column] réglait ce problème. Bizarrement c&#x27;est plus compliqué pour une clé étrangère. Il faut procéder de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="na">[Column(&quot;MEDECIN_ID&quot;)]</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MedecinId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;MedecinId&quot;)]</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 5-7 : on crée un champ du type de la clé étrangère (int). A l&#x27;aide de l&#x27;attribut [Column], on précise le nom de la colonne qui sera clé étrangère dans la table associée à l&#x27;entité ;</li>
<li>ligne 9 : on ajoute l&#x27;annotation [<strong>ForeignKey</strong>] au champ de type [Medecin]. L&#x27;argument de cette annotation est le nom du champ (pas de la colonne) qui est associé à la colonne clé étrangère de la table.</li>
</ul>
<p>L&#x27;exécution du projet crée cette fois-ci la table suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001FC0000012450090EE9.png" style="display:inline-block; margin:4px;width:6.72cm;height:3.863cm;" /></td></tr></table>

<p>Ci-dessus, la colonne clé étrangère porte bien le nom qu&#x27;on lui a donné. Il faut noter que les champs :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="na">[Column(&quot;MEDECIN_ID&quot;)]</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MedecinId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;MedecinId&quot;)]</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>n&#x27;ont donné naissance qu&#x27;à une seule colonne, la colonne [MEDECIN_ID]. Néanmoins, la présence du champ [MedecinId] est importante. Lors de la lecture d&#x27;une ligne de la table [CRENEAUX], elle recevra la valeur de la colonne [MEDECIN_ID], c&#x27;-à-d. la valeur de la clé étrangère sur la table [MEDECINS]. Cela est souvent utile.</p>
<p>Le champ [Medecin] ci-dessus reflète la relation plusieurs à un qui lie l&#x27;entité [Creneau] à l&#x27;entité [Medecin]. Plusieurs objets [Creneau] sont reliés à un même [Medecin]. La relation inverse, un objet [Medecin] est associé à plusieurs objets [Creneau] peut être modélisée par un champ supplémentaire dans l&#x27;entité [Medecin] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Ligne 8, on a rajouté le champ [Creneaux] qui est une collection d&#x27;objets [Creneau]. Ce champ nous donnera accès à tous les créneaux horaires du médecin.</p>
<p>Lorsqu&#x27;on exécute de nouveau le projet, on constate que la table [MEDECINS] n&#x27;a pas bougé :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000011A000000842C1A2CD8.png" style="display:inline-block; margin:4px;width:5.219cm;height:2.439cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Aucune colonne n&#x27;a été rajoutée. La relation de clé étrangère qui existe entre la table [CRENEAUX] et la table [MEDECINS] est suffisante pour que EF sache générer les champs liés à celle-ci :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="na">[Column(&quot;MEDECIN_ID&quot;)]</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MedecinId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;MedecinId&quot;)]</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Nous savons l&#x27;essentiel. Nous pouvons terminer avec la création des deux autres entités.</p>
<h3 id="343-les-entites-client-et-rv">3.4.3. Les entités [Client] et [Rv]</h3>
<p>Avec ce que nous avons appris, nous pouvons écrire les entités [Client] et [Rv]. L&#x27;entité [Client] contient des informations sur les clients gérés par l&#x27;application [RdvMedecins].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000015C0000009211F9EF53.png" style="display:inline-block; margin:4px;width:6.451cm;height:2.701cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001720000006D8D331F7F.png" style="display:inline-block; margin:4px;width:6.849cm;height:2.02cm;" /></td></tr></table>

<ul>
<li>ID : n° identifiant le client - clé primaire de la table</li>
<li>VERSION : n° identifiant la version de la ligne dans la table. Ce nombre est incrémenté de 1 à chaque fois qu&#x27;une modification est apportée à la ligne.</li>
<li>NOM : le nom du client</li>
<li>PRENOM : son prénom</li>
<li>TITRE : son titre (Melle, Mme, Mr)</li>
</ul>
<p>L&#x27;entité [Client] pourrait être la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="w">  </span><span class="na">[Table(&quot;CLIENTS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Client</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">    </span><span class="c1">// les Rvs du client</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La classe [Client] est quasi identique à la classe [Medecin]. On pourrait les faire dériver d&#x27;une même classe parent. La nouveauté est ligne 21. Elle reflète le fait qu&#x27;un client peut avoir plusieurs rendez-vous et dérive de la présence d&#x27;une clé étrangère de la table [RVS] vers la table [CLIENTS].</p>
<p>L&#x27;entité [Rv] représente un rendez-vous :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F80000010BE373FA2B.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.145cm;" /></td></tr></table>

<ul>
<li>ID : n° identifiant le RV de façon unique – clé primaire</li>
<li>JOUR : jour du RV</li>
<li>ID_CRENEAU : créneau horaire du RV - clé étrangère sur la colonne [ID] de la table [CRENEAUX] – fixe à la fois le créneau horaire et le médecin concerné.</li>
<li>ID_CLIENT : n° du client pour qui est faite la réservation – clé étrangère sur la colonne [ID] de la table [CLIENTS]</li>
</ul>
<p>L&#x27;entité [Rv] pourrait être la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="na">[Table(&quot;MEDECINS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rv</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="na">[Column(&quot;JOUR&quot;)]</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="na">[Column(&quot;CLIENT_ID&quot;)]</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ClientId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;ClientId&quot;)]</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">    </span><span class="na">[Column(&quot;CRENEAU_ID&quot;)]</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CreneauId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;CreneauId&quot;)]</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 5-7 : clé primaire ;</li>
<li>lignes 8-10 : date du rendez-vous ;</li>
<li>lignes 11-12 : la clé étrangère de la table [RVS] vers la table [CLIENTS] ;</li>
<li>lignes 13-15 : le client qui a rendez-vous ;</li>
<li>lignes 16-17 : la clé étrangère de la table [RVS] vers la table [CRENEAUX] ;</li>
<li>lignes 18-20 : le créneau horaire du rendez-vous ;</li>
<li>lignes 21-23 : le champ de gestion des accès concurrents.</li>
</ul>
<p>Ligne 17, on voit une relation plusieurs à un : à un créneau horaire peuvent correspondre plusieurs rendez-vous (pas le même jour). La relation inverse peut être reflétée dans l&#x27;entité [Creneau] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="c1">// les Rvs du créneau</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Ligne 4, la collection des rendez-vous pris sur ce créneau horaire.</p>
<p>Lorsqu&#x27;on exécute le projet, la base générée est la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000113000000A1D779F09B.png" style="display:inline-block; margin:4px;width:5.091cm;height:2.979cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Les tables [MEDECINS] et [CRENEAUX] n&#x27;ont pas changé. Les tables [CLIENTS] et [RVS] sont les suivantes :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001110000008332FEB4C6.png" style="display:inline-block; margin:4px;width:5.091cm;height:2.431cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000011F000000A47BB55935.png" style="display:inline-block; margin:4px;width:5.309cm;height:3.039cm;" /></td></tr></table>

<p>C&#x27;est ce qui était attendu. Il nous reste quelques détails à régler :</p>
<ul>
<li>gérer le nom de la base. Ici il a été généré par EF ;</li>
<li>remplir la base avec des données.</li>
</ul>
<h3 id="344-fixer-le-nom-de-la-base">3.4.4. Fixer le nom de la base</h3>
<p>Pour fixer le nom de la base générée par EF, nous utiliserons une chaîne de connexion définie dans [App.config]. Ce fichier de configuration évolue comme suit :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">  </span><span class="nt">&lt;configSections&gt;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="cm">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span><span class="w"> </span><span class="na">requirePermission=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">  </span><span class="nt">&lt;/configSections&gt;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">  </span><span class="nt">&lt;startup&gt;</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="nt">&lt;supportedRuntime</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;v4.0&quot;</span><span class="w"> </span><span class="na">sku=</span><span class="s">&quot;.NETFramework,Version=v4.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">  </span><span class="nt">&lt;/startup&gt;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">  </span><span class="nt">&lt;entityFramework&gt;</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="nt">&lt;defaultConnectionFactory</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">  </span><span class="nt">&lt;/entityFramework&gt;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">  </span><span class="cm">&lt;!-- chaîne de connexion sur la base --&gt;</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">  </span><span class="nt">&lt;connectionStrings&gt;</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;RdvMedecinsContext&quot;</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">         </span><span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=rdvmedecins-ef;User Id=sa;Password=sqlserver2012;&quot;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">         </span><span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">  </span><span class="nt">&lt;/connectionStrings&gt;</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">  </span><span class="cm">&lt;!-- le factory provider --&gt;</span>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">  </span><span class="nt">&lt;system.data&gt;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="nt">&lt;DbProviderFactories&gt;</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">      </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SqlClient Data Provider&quot;</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">       </span><span class="na">invariant=</span><span class="s">&quot;System.Data.SqlClient&quot;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">       </span><span class="na">description=</span><span class="s">&quot;.Net Framework Data Provider for SqlServer&quot;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">       </span><span class="na">type=</span><span class="s">&quot;System.Data.SqlClient.SqlClientFactory, System.Data,</span>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="s">     Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">    </span><span class="nt">/&gt;</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">    </span><span class="nt">&lt;/DbProviderFactories&gt;</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">  </span><span class="nt">&lt;/system.data&gt;</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 15-19 : la chaîne de connexion à la base ;</li>
<li>ligne 16 : l&#x27;attribut [name] reprend le nom de la classe [RdvMedecinsContext] utilisé pour le contexte de persistance. Il est important de s&#x27;en souvenir. Cette contrainte peut être contournée dans le constructeur du contexte :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>    // constructeur
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>    public RdvMedecinsContext()
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>      : base(&quot;monContexte&quot;)
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>    {
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>    }
</code></pre></div></td></tr></table></div>
<p>Dans ce cas, on pourra avoir <strong>name= &quot;monContexte &quot;</strong>. C&#x27;est ce que nous aurons dans la suite du document.</p>
<ul>
<li>ligne 17 : la chaîne de connexion. [Data Source] : le nom du serveur sur lequel se trouve le SGBD, [Initial Catalog] : le nom de la base de données, donc ici [rdvmedecins-ef], [User Id] : le propriétaire de la connexion, [Password] : son mot de passe. Le lecteur adaptera cette chaîne à son environnement ;</li>
<li>lignes 21-29 : définissent un [DbProviderFactory]. Je ne sais pas ce que c&#x27;est. Si j&#x27;en crois le nom, ce pourrait être une classe permettant de générer la couche [ADO.NET] qui sépare EF du SGBD :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F10000012350D8FD0D.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.443cm;" /></td></tr></table>

<p>En fait, ces lignes sont inutiles pour SQL Server mais j&#x27;ai du les ajouter pour les autres SGBD. Aussi c&#x27;est pour mémoire que je les mets là. Elles ne gênent pas. Le seul point important est la version de la ligne 27. C&#x27;est celle de la DLL [System.Data] présente dans les références du projet :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005110000029C6F889E34.png" style="display:inline-block; margin:4px;width:17.159cm;height:8.837cm;" /></td></tr></table>

<p>Voilà. Nous sommes prêts. Nous exécutons le projet et nous obtenons la base [rdvmedecins-ef] suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000E50000011159D12607.png" style="display:inline-block; margin:4px;width:4.24cm;height:5.061cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Ce sera notre base définitive. Il nous reste à mettre des données dedans.</p>
<h3 id="345-remplissage-de-la-base">3.4.5. Remplissage de la base</h3>
<p>La classe d&#x27;initialisation de la base peut être utilisée pour y insérer des données :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span>
<span class="normal"><a href="#__codelineno-20-38">38</a></span>
<span class="normal"><a href="#__codelineno-20-39">39</a></span>
<span class="normal"><a href="#__codelineno-20-40">40</a></span>
<span class="normal"><a href="#__codelineno-20-41">41</a></span>
<span class="normal"><a href="#__codelineno-20-42">42</a></span>
<span class="normal"><a href="#__codelineno-20-43">43</a></span>
<span class="normal"><a href="#__codelineno-20-44">44</a></span>
<span class="normal"><a href="#__codelineno-20-45">45</a></span>
<span class="normal"><a href="#__codelineno-20-46">46</a></span>
<span class="normal"><a href="#__codelineno-20-47">47</a></span>
<span class="normal"><a href="#__codelineno-20-48">48</a></span>
<span class="normal"><a href="#__codelineno-20-49">49</a></span>
<span class="normal"><a href="#__codelineno-20-50">50</a></span>
<span class="normal"><a href="#__codelineno-20-51">51</a></span>
<span class="normal"><a href="#__codelineno-20-52">52</a></span>
<span class="normal"><a href="#__codelineno-20-53">53</a></span>
<span class="normal"><a href="#__codelineno-20-54">54</a></span>
<span class="normal"><a href="#__codelineno-20-55">55</a></span>
<span class="normal"><a href="#__codelineno-20-56">56</a></span>
<span class="normal"><a href="#__codelineno-20-57">57</a></span>
<span class="normal"><a href="#__codelineno-20-58">58</a></span>
<span class="normal"><a href="#__codelineno-20-59">59</a></span>
<span class="normal"><a href="#__codelineno-20-60">60</a></span>
<span class="normal"><a href="#__codelineno-20-61">61</a></span>
<span class="normal"><a href="#__codelineno-20-62">62</a></span>
<span class="normal"><a href="#__codelineno-20-63">63</a></span>
<span class="normal"><a href="#__codelineno-20-64">64</a></span>
<span class="normal"><a href="#__codelineno-20-65">65</a></span>
<span class="normal"><a href="#__codelineno-20-66">66</a></span>
<span class="normal"><a href="#__codelineno-20-67">67</a></span>
<span class="normal"><a href="#__codelineno-20-68">68</a></span>
<span class="normal"><a href="#__codelineno-20-69">69</a></span>
<span class="normal"><a href="#__codelineno-20-70">70</a></span>
<span class="normal"><a href="#__codelineno-20-71">71</a></span>
<span class="normal"><a href="#__codelineno-20-72">72</a></span>
<span class="normal"><a href="#__codelineno-20-73">73</a></span>
<span class="normal"><a href="#__codelineno-20-74">74</a></span>
<span class="normal"><a href="#__codelineno-20-75">75</a></span>
<span class="normal"><a href="#__codelineno-20-76">76</a></span>
<span class="normal"><a href="#__codelineno-20-77">77</a></span>
<span class="normal"><a href="#__codelineno-20-78">78</a></span>
<span class="normal"><a href="#__codelineno-20-79">79</a></span>
<span class="normal"><a href="#__codelineno-20-80">80</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsInitializer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DropCreateDatabaseIfModelChanges</span><span class="o">&lt;</span><span class="n">RdvMedecinsContext</span><span class="o">&gt;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="c1">// initialisation de la base</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsInitializer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DropCreateDatabaseAlways</span><span class="o">&lt;</span><span class="n">RdvMedecinsContext</span><span class="o">&gt;</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">      </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Seed</span><span class="p">(</span><span class="n">RdvMedecinsContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">        </span><span class="k">base</span><span class="p">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">        </span><span class="c1">// on initialise la base</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span><span class="n">Client</span><span class="p">[]</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Martin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mme&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;German&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Christine&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacquard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Melle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bistrou&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Brigitte&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">     </span><span class="p">};</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="w">        </span><span class="c1">// les médecins</span>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a><span class="w">        </span><span class="n">Medecin</span><span class="p">[]</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mme&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Pelissier&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Marie&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-24" name="__codelineno-20-24"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bromard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacques&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-25" name="__codelineno-20-25"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jandot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Philippe&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-20-26" name="__codelineno-20-26"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Melle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacquemot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Justine&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-20-27" name="__codelineno-20-27"></a><span class="w">     </span><span class="p">};</span>
<a id="__codelineno-20-28" name="__codelineno-20-28"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">medecins</span><span class="p">)</span>
<a id="__codelineno-20-29" name="__codelineno-20-29"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-20-31" name="__codelineno-20-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-32" name="__codelineno-20-32"></a><span class="w">        </span><span class="c1">// les créneaux horaires</span>
<a id="__codelineno-20-33" name="__codelineno-20-33"></a><span class="w">        </span><span class="n">Creneau</span><span class="p">[]</span><span class="w"> </span><span class="n">creneaux</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-20-34" name="__codelineno-20-34"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-35" name="__codelineno-20-35"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-36" name="__codelineno-20-36"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-37" name="__codelineno-20-37"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-38" name="__codelineno-20-38"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-39" name="__codelineno-20-39"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-40" name="__codelineno-20-40"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-41" name="__codelineno-20-41"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-42" name="__codelineno-20-42"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-43" name="__codelineno-20-43"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-44" name="__codelineno-20-44"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-45" name="__codelineno-20-45"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-46" name="__codelineno-20-46"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-47" name="__codelineno-20-47"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-48" name="__codelineno-20-48"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-49" name="__codelineno-20-49"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-50" name="__codelineno-20-50"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-51" name="__codelineno-20-51"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-52" name="__codelineno-20-52"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-53" name="__codelineno-20-53"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-54" name="__codelineno-20-54"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-55" name="__codelineno-20-55"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-56" name="__codelineno-20-56"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-57" name="__codelineno-20-57"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-20-58" name="__codelineno-20-58"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-59" name="__codelineno-20-59"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-60" name="__codelineno-20-60"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-61" name="__codelineno-20-61"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-62" name="__codelineno-20-62"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-63" name="__codelineno-20-63"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-64" name="__codelineno-20-64"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-65" name="__codelineno-20-65"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-66" name="__codelineno-20-66"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-67" name="__codelineno-20-67"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-68" name="__codelineno-20-68"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-69" name="__codelineno-20-69"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-20-70" name="__codelineno-20-70"></a><span class="w">      </span><span class="p">};</span>
<a id="__codelineno-20-71" name="__codelineno-20-71"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">creneaux</span><span class="p">)</span>
<a id="__codelineno-20-72" name="__codelineno-20-72"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-20-73" name="__codelineno-20-73"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">creneau</span><span class="p">);</span>
<a id="__codelineno-20-74" name="__codelineno-20-74"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-75" name="__codelineno-20-75"></a><span class="w">        </span><span class="c1">// les Rdv</span>
<a id="__codelineno-20-76" name="__codelineno-20-76"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-20-77" name="__codelineno-20-77"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-20-78" name="__codelineno-20-78"></a>
<a id="__codelineno-20-79" name="__codelineno-20-79"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-80" name="__codelineno-20-80"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 6 : l&#x27;initialisation se passe dans la méthode [Seed]. Celle-ci existe dans la classe mère. Elle est ici redéfinie. L&#x27;argument est le contexte de persistance [RdvMedecinsContext] de l&#x27;application ;</li>
<li>ligne 8 : l&#x27;argument est passé à la classe mère ; il est probable que celle-ci ouvre le contexte de persistance qu&#x27;on lui a passé car cette ouverture n&#x27;est plus nécessaire par la suite ;</li>
<li>lignes 11-16 : création de 4 clients ;</li>
<li>lignes 17-20 : ceux-ci sont ajoutés au contexte de persistance, plus exactement aux médecins de celui-ci. On notera la méthode [Add] qui permet cela. Il faut se rappeler ici la définition du contexte :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsContext</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">DbContext</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="c1">// les entités</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Medecins</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Clients</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="k">public</span><span class="w"> </span><span class="n">DbSet</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="p">...</span>
</code></pre></div></td></tr></table></div>
<p>On dit aussi que les clients ont été <strong>attachés</strong> au contexte, c&#x27;-à-d. qu&#x27;ils sont désormais gérés par EF. Avant ils en étaient <strong>détachés</strong>. Ils existaient en tant qu&#x27;objets mais n&#x27;étaient pas gérés par EF ;</p>
<ul>
<li>lignes 21-27 : création de 4 médecins ;</li>
<li>lignes 28-31 : on les met dans le contexte de persistance ;</li>
<li>lignes 33-70 : création de créneaux horaires. Lignes 34-57, pour le médecin <strong>medecins[0]</strong>, lignes 58-69,  pour le médecin <strong>medecins[1]</strong>. Les autres médecins sont sans créneaux horaires ;</li>
<li>lignes 71-74 : on met ces créneaux dans le contexte de persistance ;</li>
<li>ligne 76 : création d&#x27;un rendez-vous pour le 1er client avec le 1er créneau horaire et sa mise dans le contexte de persistance.</li>
</ul>
<p>Lorsqu&#x27;on exécute le projet, on obtient la base suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000012A000000DA3895344A.png" style="display:inline-block; margin:4px;width:5.519cm;height:4.039cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001600000007D0E112EB2.png" style="display:inline-block; margin:4px;width:6.519cm;height:2.311cm;" /></td></tr></table>

<p>Ci-dessus, on voit la table [CLIENTS] remplie.</p>
<h3 id="346-modification-des-entites">3.4.6. Modification des entités</h3>
<p>Actuellement, les classes [Medecin] et [Client] sont quasi identiques. En fait si on enlève les champs ajoutés pour la gestion de la persistance avec EF 5, elles sont identiques. Nous allons les faire dériver d&#x27;une classe [Personne]. Ces deux entités deviennent alors les suivantes :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span>
<span class="normal"><a href="#__codelineno-22-35">35</a></span>
<span class="normal"><a href="#__codelineno-22-36">36</a></span>
<span class="normal"><a href="#__codelineno-22-37">37</a></span>
<span class="normal"><a href="#__codelineno-22-38">38</a></span>
<span class="normal"><a href="#__codelineno-22-39">39</a></span>
<span class="normal"><a href="#__codelineno-22-40">40</a></span>
<span class="normal"><a href="#__codelineno-22-41">41</a></span>
<span class="normal"><a href="#__codelineno-22-42">42</a></span>
<span class="normal"><a href="#__codelineno-22-43">43</a></span>
<span class="normal"><a href="#__codelineno-22-44">44</a></span>
<span class="normal"><a href="#__codelineno-22-45">45</a></span>
<span class="normal"><a href="#__codelineno-22-46">46</a></span>
<span class="normal"><a href="#__codelineno-22-47">47</a></span>
<span class="normal"><a href="#__codelineno-22-48">48</a></span>
<span class="normal"><a href="#__codelineno-22-49">49</a></span>
<span class="normal"><a href="#__codelineno-22-50">50</a></span>
<span class="normal"><a href="#__codelineno-22-51">51</a></span>
<span class="normal"><a href="#__codelineno-22-52">52</a></span>
<span class="normal"><a href="#__codelineno-22-53">53</a></span>
<span class="normal"><a href="#__codelineno-22-54">54</a></span>
<span class="normal"><a href="#__codelineno-22-55">55</a></span>
<span class="normal"><a href="#__codelineno-22-56">56</a></span>
<span class="normal"><a href="#__codelineno-22-57">57</a></span>
<span class="normal"><a href="#__codelineno-22-58">58</a></span>
<span class="normal"><a href="#__codelineno-22-59">59</a></span>
<span class="normal"><a href="#__codelineno-22-60">60</a></span>
<span class="normal"><a href="#__codelineno-22-61">61</a></span>
<span class="normal"><a href="#__codelineno-22-62">62</a></span>
<span class="normal"><a href="#__codelineno-22-63">63</a></span>
<span class="normal"><a href="#__codelineno-22-64">64</a></span>
<span class="normal"><a href="#__codelineno-22-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1">// une personne</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Personne</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">      </span><span class="p">...</span>
<a id="__codelineno-22-33" name="__codelineno-22-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-34" name="__codelineno-22-34"></a>
<a id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="w">    </span><span class="c1">// utilitaire</span>
<a id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-22-37" name="__codelineno-22-37"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-38" name="__codelineno-22-38"></a><span class="w">      </span><span class="p">...</span>
<a id="__codelineno-22-39" name="__codelineno-22-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-40" name="__codelineno-22-40"></a>
<a id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-22-42" name="__codelineno-22-42"></a>
<a id="__codelineno-22-43" name="__codelineno-22-43"></a><span class="w">  </span><span class="na">[Table(&quot;MEDECINS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-22-44" name="__codelineno-22-44"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Personne</span>
<a id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="w">    </span><span class="c1">// les créneaux horaires du médecin</span>
<a id="__codelineno-22-47" name="__codelineno-22-47"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-48" name="__codelineno-22-48"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-22-50" name="__codelineno-22-50"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-51" name="__codelineno-22-51"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Medecin {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">base</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<a id="__codelineno-22-52" name="__codelineno-22-52"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-53" name="__codelineno-22-53"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-22-54" name="__codelineno-22-54"></a>
<a id="__codelineno-22-55" name="__codelineno-22-55"></a><span class="na">[Table(&quot;CLIENTS&quot;, Schema = &quot;dbo&quot;)]</span>
<a id="__codelineno-22-56" name="__codelineno-22-56"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Client</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Personne</span>
<a id="__codelineno-22-57" name="__codelineno-22-57"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-22-58" name="__codelineno-22-58"></a><span class="w">    </span><span class="c1">// les Rvs du client</span>
<a id="__codelineno-22-59" name="__codelineno-22-59"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-22-60" name="__codelineno-22-60"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-22-61" name="__codelineno-22-61"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-22-62" name="__codelineno-22-62"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-63" name="__codelineno-22-63"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Client {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">base</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<a id="__codelineno-22-64" name="__codelineno-22-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-65" name="__codelineno-22-65"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Lorsqu&#x27;on exécute le projet, on obtient la même base. EF 5 a mappé les classes les plus basses de l&#x27;héritage chacune dans une table. En fait, EF 5 a différentes stratégies de génération de tables pour représenter l&#x27;héritage d&#x27;entités. Nous ne les présenterons pas ici. On pourra lire par exemple &quot; Entity Framework Code First Inheritance : Table Per Hierarchy and Table Per Type &quot;, à l&#x27;URL [<a href="http://www.codeproject.com/Articles/393228/Entity-Framework-Code-First-Inheritance-Table-Per">http://www.codeproject.com/Articles/393228/Entity-Framework-Code-First-Inheritance-Table-Per</a>].</p>
<p>Nous utiliserons désormais cette version des entités.</p>
<h3 id="347-ajouter-des-contraintes-a-la-base">3.4.7. Ajouter des contraintes à la base</h3>
<p>Il nous reste un détail à régler. La table [RVS] des rendez-vous est la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000011C000000812CB8798B.png" style="display:inline-block; margin:4px;width:5.26cm;height:2.39cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Cette table doit avoir une contrainte d&#x27;unicité : pour un jour donné, un créneau horaire d&#x27;un médecin ne peut être réservé qu&#x27;une fois pour un rendez-vous. En termes de table, cela signifie que le couple (JOUR,CRENEAU_ID) doit être unique. Je ne sais pas si cette contrainte peut être exprimée directement dans le code, soit sur les entités soit sur le contexte. C&#x27;est probable mais je n&#x27;ai pas vérifié. Nous allons prendre une autre démarche. Nous allons utiliser un client d&#x27;administration de SQL Server pour ajouter cette contrainte.</p>
<p>Avec &quot; SQL Server Management Studio &quot;, je n&#x27;ai pas trouvé de méthode simple pour ajouter cette contrainte hormis exécuter l&#x27;ordre SQL qui la crée :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000061B0000015A88CFC6F0.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.983cm;" /></td></tr></table>

<ul>
<li>en [1] on crée une requête SQL pour la base [rdvmedecins-ef] ;</li>
<li>en [2], la requête SQL qui crée la contrainte d&#x27;unicité ;</li>
<li>en [3], l&#x27;exécution de cette requête a créé un nouvel index dans la table [RVS].</li>
</ul>
<p>Il existe d&#x27;autres outils d&#x27;administration de SQL Server. Nous allons utiliser ici l&#x27;outil EMS SQL Manager for SQL Server Freeware [http://www.sqlmanager.net/fr/products/mssql/manager/download]. Une fois installé, nous le lançons :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000054F00000262284E9044.png" style="display:inline-block; margin:4px;width:17.979cm;height:8.07cm;" /></td></tr></table>

<ul>
<li>en [1], on enregistre une base de données ;</li>
<li>en [2], on se connecte au serveur <strong>(local)</strong> ;</li>
<li>en [3], avec une authentification SQL Server ;</li>
<li>en [4], sous l&#x27;identité <strong>sa</strong> ;</li>
<li>en [5], et le mot de passe <strong>sqlserver2012</strong> ;</li>
<li>en [6], on passe à l&#x27;étape suivante ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005A3000002AE41AAAC87.png" style="display:inline-block; margin:4px;width:17.999cm;height:8.555cm;" /></td></tr></table>

<ul>
<li>en [7], on choisit la base [rdvmedecins-ef] ;</li>
<li>en [8], on termine l&#x27;assistant ;</li>
<li>en [9], la base apparaît dans l&#x27;arborescence des bases. On s&#x27;y connecte [10] ;</li>
<li>en [11], on est connecté.</li>
</ul>
<p>&quot; SQL Manager Lite for SQL Server &quot; permet de créer la contrainte d&#x27;unicité sur la table [RVS].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F200000211FE7CFAC5.png" style="display:inline-block; margin:4px;width:17.999cm;height:6.257cm;" /></td></tr></table>

<ul>
<li>en [1], on voit la contrainte d&#x27;unicité que nous avons créée précédemment ;</li>
<li>en [2], on la supprime ;</li>
<li>en [3], l&#x27;indice correspondant à cette contrainte d&#x27;unicité a disparu.</li>
</ul>
<p>On recrée la contrainte supprimée :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000587000003579F3E33FB.png" style="display:inline-block; margin:4px;width:17.999cm;height:10.874cm;" /></td></tr></table>

<ul>
<li>en [1], on crée un nouvel index pour la table [RVS] ;</li>
<li>en [2], on lui donne un nom ;</li>
<li>en [3], c&#x27;est une contrainte d&#x27;unicité ;</li>
<li>en [4], sur les colonnes JOUR et CRENEAU_ID ;</li>
</ul>
<p>L&#x27;onglet DDL nous donne le code SQL qui va être exécuté :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005C4000001716F932A9B.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.5cm;" /></td></tr></table>

<ul>
<li>en [6], on compile l&#x27;ordre SQL ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000053B000002254FA5068A.png" style="display:inline-block; margin:4px;width:17.715cm;height:7.264cm;" /></td></tr></table>

<ul>
<li>en [7], on confirme ;</li>
<li>en [8], le nouvel indice est apparu.</li>
</ul>
<p>L&#x27;interface offerte par &quot; SQL Manager Lite for SQL server &quot; est analogue à celle offerte par &quot; SQL Server Management Studio &quot;. On peut trouver des interfaces analogues pour les SGBD Oracle, PostgreSQL, Firebird, MySQL. Aussi continueron-nous désormais avec cette famille d&#x27;outils d&#x27;administration de SGBD.</p>
<p>Pour avoir accès aux informations d&#x27;une table, il suffit de double-cliquer dessus :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000051A000000FB753169D6.png" style="display:inline-block; margin:4px;width:17.277cm;height:3.321cm;" /></td></tr></table>

<p>Les informations sur la table sélectionnée sont disponibles dans des onglets. Ci-dessus, on voit l&#x27;onglet [Fields] de la table [CLIENTS]. L&#x27;onglet [Data] affiche le contenu de la table :</p>
<p><img src="images/1000000000000235000000C462845E7A.png" style="width:10.46cm;height:3.63cm;" alt="Image" /></p>
<h3 id="348-la-base-definitive">3.4.8. La base définitive</h3>
<p>Nous avons notre base définitive. Nous exportons son script SQL afin de pouvoir la régénérer si besoin est.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000056E000001C30E28ACA6.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.84cm;" /></td></tr></table>

<ul>
<li>en [1], début de l&#x27;assistant ;</li>
<li>en [2], le serveur ;</li>
<li>en [3], la base de données qui va être exportée ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000586000000F6D9257696.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.131cm;" /></td></tr></table>

<ul>
<li>en [4], précisez le nom du fichier où sera enregistré le script SQL ;</li>
<li>en [5], précisez son encodage ;</li>
<li>en [6], précisez ce que vous voulez extraire (tables, contraintes, données) ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005CB0000023A0020B9AA.png" style="display:inline-block; margin:4px;width:17.999cm;height:6.916cm;" /></td></tr></table>

<ul>
<li>en [7], vous pouvez affiner le script qui va être généré ;</li>
<li>en [8], terminez l&#x27;assistant.</li>
</ul>
<p>Le script a été généré et chargé dans l&#x27;éditeur de script. Vous pouvez consulter le code SQL généré. Nous allons reconstruire la base de données à partir de ce script.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005BA000001C35F829765.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.537cm;" /></td></tr></table>

<ul>
<li>en [1], on supprime la base ;</li>
<li>en [2] et [3], on la recrée ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005D5000002475CD30CE7.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.027cm;" /></td></tr></table>

<ul>
<li>en [4], on s&#x27;authentifie ;</li>
<li>en [5], on exécute le script SQL de création de la base ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000055B0000019C033BA813.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.408cm;" /></td></tr></table>

<ul>
<li>en [6], on l&#x27;enregistre dans &quot; SQL Manager &quot; ;</li>
<li>en [7], on se connecte à la base qui vient d&#x27;être créée ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004D000000177363512EE.png" style="display:inline-block; margin:4px;width:16.298cm;height:4.962cm;" /></td></tr></table>

<ul>
<li>en [8], la base n&#x27;a pour l&#x27;instant pas de tables ;</li>
<li>en [9a], on ouvre un éditeur de script SQL ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000533000001AA3F901582.png" style="display:inline-block; margin:4px;width:17.609cm;height:5.636cm;" /></td></tr></table>

<ul>
<li>en [9b], on ouvre le script SQL créé précédemment ;</li>
<li>en [10], on l&#x27;exécute ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000630000001B0687D7191.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.907cm;" /></td></tr></table>

<ul>
<li>en [11], les tables ont été créées ;</li>
<li>en [12], elles sont remplies ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000016F000001573762DAEF.png" style="display:inline-block; margin:4px;width:4.856cm;height:4.538cm;" /></td></tr></table>

<ul>
<li>en [14], nous retrouvons la contrainte d&#x27;unicité que nous avions créée pour la table [RVS].</li>
</ul>
<p>Nous allons désormais travailler avec cette base existante. Si elle est détruite ou détériorée, nous savons la régénérer.</p>
<h2 id="35-exploitation-de-la-base-avec-entity-framework">3.5. Exploitation de la base avec Entity Framework</h2>
<p>Nous allons :</p>
<ul>
<li>ajouter, supprimer, modifier des éléments de la base ;</li>
<li>requêter la base avec LINQ to Entities ;</li>
<li>gérer les accès concurrents à un même élément de la base ;</li>
<li>comprendre les notions de Lazy Loading / Eager Loading ;</li>
<li>découvrir que la mise à jour de la base par le contexte de persistance se fait dans une transaction.</li>
</ul>
<h3 id="351-suppression-delements-du-contexte-de-persistance">3.5.1. Suppression d&#x27;éléments du contexte de persistance</h3>
<p>Nous avons une base remplie. Nous allons la vider. Nous créons une nouvelle classe [Erase.cs] dans le projet actuel [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001D2000001D988DFA895.png" style="display:inline-block; margin:4px;width:6.165cm;height:6.258cm;" /></td></tr></table>

<p>La classe [Erase] est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="p">{</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Erase</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="w">        </span><span class="c1">// les médecins</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">        </span><span class="c1">// on sauve le contexte de persistance</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : les opérations sur un contexte de persistance se font toujours dans une clause [using]. Cela assure qu&#x27;à la sortie du [using], le contexte a été fermé ;</li>
<li>ligne 13 : on parcourt le contexte des clients [context.Clients]. Tous les clients de la base vont être mis dans le contexte de persistance ;</li>
<li>ligne 15 : pour chacun d&#x27;eux on fait l&#x27;opération [Remove] qui les supprime du contexte. En fait, ils sont toujours dans le contexte mais dans un état &quot; supprimé &quot; ;</li>
<li>lignes 18-21 : on fait la même chose pour les médecins ;</li>
<li>ligne 23 : on sauvegarde le contexte de persistance en base.</li>
</ul>
<p>Lors de la sauvegarde du contexte en base, les entités du contexte qui :</p>
<ul>
<li>ont une clé primaire <strong>null</strong> font l&#x27;objet d&#x27;une opération SQL INSERT ;</li>
<li>sont dans un état &quot; supprimé &quot; font l&#x27;objet d&#x27;une opération SQL DELETE ;</li>
<li>sont dans un état &quot; modifié &quot; font l&#x27;objet d&#x27;une opération SQL UPDATE ;</li>
</ul>
<p>Comme nous le constaterons ultérieurement, ces opérations SQL se font à l&#x27;intérieur d&#x27;une transaction. Si l&#x27;une d&#x27;elles échoue, tout ce qui a été fait précédemment est défait.</p>
<p>Faisons du programme [Erase] le nouvel objet de démarrage du projet [1] puis exécutons le projet.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006430000013457DC4F63.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.457cm;" /></td></tr></table>

<p>Vérifions la base. On constatera que toutes les tables sont vides [2]. C&#x27;est étonnant, car nous avions demandé simplement la suppression des médecins et des clients. C&#x27;est par le jeu des clés étrangères que les autres tables ont été vidées en cascade.</p>
<p>La définition de la clé étrangère de la table [CRENEAUX] vers la table [MEDECINS] a été définie comme suit par le provider d&#x27;EF 5 :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002E700000153CB0BBEA7.png" style="display:inline-block; margin:4px;width:9.83cm;height:4.486cm;" /></td></tr></table>

<ul>
<li>en [1], on sélectionne la table [CRENEAUX] ;</li>
<li>en [2], on sélectionne l&#x27;onglet des clés étrangères ;</li>
<li>en [3], on édite l&#x27;unique clé étrangère ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004E9000000F83E2F0EA4.png" style="display:inline-block; margin:4px;width:16.63cm;height:3.281cm;" /></td></tr></table>

<ul>
<li>en [4], dans l&#x27;onglet DDL , la définition SQL de la contrainte de clé étrangère ;</li>
<li>en [5], la clause ON DELETE CASCADE fait que la suppression d&#x27;un médecin entraîne la suppression des créneaux qui lui sont associés.</li>
</ul>
<p>Les contraintes de clé étrangères de la table [RVS] sont définies de façon analogue :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span>
<span class="normal"><a href="#__codelineno-24-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">RVS</span><span class="p">]</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_dbo</span><span class="p">.</span><span class="n">RVS_dbo</span><span class="p">.</span><span class="n">CLIENTS_CLIENT_ID</span><span class="p">]</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">([</span><span class="n">CLIENT_ID</span><span class="p">])</span><span class="w"> </span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">  </span><span class="k">REFERENCES</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CLIENTS</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">ID</span><span class="p">])</span><span class="w"> </span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="k">GO</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-6 : supprimer un client supprimera là également les rendez-vous qui lui sont associés ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">RVS</span><span class="p">]</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_dbo</span><span class="p">.</span><span class="n">RVS_dbo</span><span class="p">.</span><span class="n">CRENEAUX_CRENEAU_ID</span><span class="p">]</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">([</span><span class="n">CRENEAU_ID</span><span class="p">])</span><span class="w"> </span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">  </span><span class="k">REFERENCES</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">ID</span><span class="p">])</span><span class="w"> </span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="k">GO</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-6 :  supprimer un créneau supprimera également tous les rendez-vous qui lui sont associés.</li>
</ul>
<h3 id="352-ajout-delements-au-contexte-de-persistance">3.5.2. Ajout d&#x27;éléments au contexte de persistance</h3>
<p>Maintenant que nous avons vidé la base, nous allons la remplir de nouveau. Nous ajoutons au projet le programme [Fill.cs] [1].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000187000001A6E3176501.png" style="display:inline-block; margin:4px;width:5.173cm;height:5.583cm;" /></td></tr></table>

<p>Le programme [Fill.cs] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span>
<span class="normal"><a href="#__codelineno-26-33">33</a></span>
<span class="normal"><a href="#__codelineno-26-34">34</a></span>
<span class="normal"><a href="#__codelineno-26-35">35</a></span>
<span class="normal"><a href="#__codelineno-26-36">36</a></span>
<span class="normal"><a href="#__codelineno-26-37">37</a></span>
<span class="normal"><a href="#__codelineno-26-38">38</a></span>
<span class="normal"><a href="#__codelineno-26-39">39</a></span>
<span class="normal"><a href="#__codelineno-26-40">40</a></span>
<span class="normal"><a href="#__codelineno-26-41">41</a></span>
<span class="normal"><a href="#__codelineno-26-42">42</a></span>
<span class="normal"><a href="#__codelineno-26-43">43</a></span>
<span class="normal"><a href="#__codelineno-26-44">44</a></span>
<span class="normal"><a href="#__codelineno-26-45">45</a></span>
<span class="normal"><a href="#__codelineno-26-46">46</a></span>
<span class="normal"><a href="#__codelineno-26-47">47</a></span>
<span class="normal"><a href="#__codelineno-26-48">48</a></span>
<span class="normal"><a href="#__codelineno-26-49">49</a></span>
<span class="normal"><a href="#__codelineno-26-50">50</a></span>
<span class="normal"><a href="#__codelineno-26-51">51</a></span>
<span class="normal"><a href="#__codelineno-26-52">52</a></span>
<span class="normal"><a href="#__codelineno-26-53">53</a></span>
<span class="normal"><a href="#__codelineno-26-54">54</a></span>
<span class="normal"><a href="#__codelineno-26-55">55</a></span>
<span class="normal"><a href="#__codelineno-26-56">56</a></span>
<span class="normal"><a href="#__codelineno-26-57">57</a></span>
<span class="normal"><a href="#__codelineno-26-58">58</a></span>
<span class="normal"><a href="#__codelineno-26-59">59</a></span>
<span class="normal"><a href="#__codelineno-26-60">60</a></span>
<span class="normal"><a href="#__codelineno-26-61">61</a></span>
<span class="normal"><a href="#__codelineno-26-62">62</a></span>
<span class="normal"><a href="#__codelineno-26-63">63</a></span>
<span class="normal"><a href="#__codelineno-26-64">64</a></span>
<span class="normal"><a href="#__codelineno-26-65">65</a></span>
<span class="normal"><a href="#__codelineno-26-66">66</a></span>
<span class="normal"><a href="#__codelineno-26-67">67</a></span>
<span class="normal"><a href="#__codelineno-26-68">68</a></span>
<span class="normal"><a href="#__codelineno-26-69">69</a></span>
<span class="normal"><a href="#__codelineno-26-70">70</a></span>
<span class="normal"><a href="#__codelineno-26-71">71</a></span>
<span class="normal"><a href="#__codelineno-26-72">72</a></span>
<span class="normal"><a href="#__codelineno-26-73">73</a></span>
<span class="normal"><a href="#__codelineno-26-74">74</a></span>
<span class="normal"><a href="#__codelineno-26-75">75</a></span>
<span class="normal"><a href="#__codelineno-26-76">76</a></span>
<span class="normal"><a href="#__codelineno-26-77">77</a></span>
<span class="normal"><a href="#__codelineno-26-78">78</a></span>
<span class="normal"><a href="#__codelineno-26-79">79</a></span>
<span class="normal"><a href="#__codelineno-26-80">80</a></span>
<span class="normal"><a href="#__codelineno-26-81">81</a></span>
<span class="normal"><a href="#__codelineno-26-82">82</a></span>
<span class="normal"><a href="#__codelineno-26-83">83</a></span>
<span class="normal"><a href="#__codelineno-26-84">84</a></span>
<span class="normal"><a href="#__codelineno-26-85">85</a></span>
<span class="normal"><a href="#__codelineno-26-86">86</a></span>
<span class="normal"><a href="#__codelineno-26-87">87</a></span>
<span class="normal"><a href="#__codelineno-26-88">88</a></span>
<span class="normal"><a href="#__codelineno-26-89">89</a></span>
<span class="normal"><a href="#__codelineno-26-90">90</a></span>
<span class="normal"><a href="#__codelineno-26-91">91</a></span>
<span class="normal"><a href="#__codelineno-26-92">92</a></span>
<span class="normal"><a href="#__codelineno-26-93">93</a></span>
<span class="normal"><a href="#__codelineno-26-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="p">{</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Fill</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">        </span><span class="c1">// on la réinitialise</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">        </span><span class="n">Client</span><span class="p">[]</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Martin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mme&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;German&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Christine&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacquard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Melle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bistrou&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Brigitte&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">     </span><span class="p">};</span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="w">        </span><span class="c1">// les médecins</span>
<a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="w">        </span><span class="n">Medecin</span><span class="p">[]</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-26-35" name="__codelineno-26-35"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mme&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Pelissier&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Marie&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bromard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacques&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-37" name="__codelineno-26-37"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jandot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Philippe&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Melle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacquemot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Justine&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="w">     </span><span class="p">};</span>
<a id="__codelineno-26-40" name="__codelineno-26-40"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">medecins</span><span class="p">)</span>
<a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-26-42" name="__codelineno-26-42"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-26-43" name="__codelineno-26-43"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-44" name="__codelineno-26-44"></a><span class="w">        </span><span class="c1">// les créneaux horaires</span>
<a id="__codelineno-26-45" name="__codelineno-26-45"></a><span class="w">        </span><span class="n">Creneau</span><span class="p">[]</span><span class="w"> </span><span class="n">creneaux</span><span class="w"> </span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-26-46" name="__codelineno-26-46"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-47" name="__codelineno-26-47"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-48" name="__codelineno-26-48"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-49" name="__codelineno-26-49"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-50" name="__codelineno-26-50"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-51" name="__codelineno-26-51"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-52" name="__codelineno-26-52"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-53" name="__codelineno-26-53"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-54" name="__codelineno-26-54"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-55" name="__codelineno-26-55"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-56" name="__codelineno-26-56"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-57" name="__codelineno-26-57"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-59" name="__codelineno-26-59"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-60" name="__codelineno-26-60"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-61" name="__codelineno-26-61"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-62" name="__codelineno-26-62"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-63" name="__codelineno-26-63"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-64" name="__codelineno-26-64"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-67" name="__codelineno-26-67"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-68" name="__codelineno-26-68"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-69" name="__codelineno-26-69"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
<a id="__codelineno-26-70" name="__codelineno-26-70"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-71" name="__codelineno-26-71"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-72" name="__codelineno-26-72"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-73" name="__codelineno-26-73"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-74" name="__codelineno-26-74"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-75" name="__codelineno-26-75"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-76" name="__codelineno-26-76"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-77" name="__codelineno-26-77"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-78" name="__codelineno-26-78"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-79" name="__codelineno-26-79"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-80" name="__codelineno-26-80"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-81" name="__codelineno-26-81"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">Mdebut</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Hfin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">Mfin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Medecin</span><span class="o">=</span><span class="n">medecins</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-26-82" name="__codelineno-26-82"></a><span class="w">      </span><span class="p">};</span>
<a id="__codelineno-26-83" name="__codelineno-26-83"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">creneaux</span><span class="p">)</span>
<a id="__codelineno-26-84" name="__codelineno-26-84"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-26-85" name="__codelineno-26-85"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">creneau</span><span class="p">);</span>
<a id="__codelineno-26-86" name="__codelineno-26-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-87" name="__codelineno-26-87"></a><span class="w">        </span><span class="c1">// les Rdv</span>
<a id="__codelineno-26-88" name="__codelineno-26-88"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-26-89" name="__codelineno-26-89"></a><span class="w">        </span><span class="c1">// on sauve le contexte de persistance</span>
<a id="__codelineno-26-90" name="__codelineno-26-90"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-26-91" name="__codelineno-26-91"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-26-92" name="__codelineno-26-92"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-93" name="__codelineno-26-93"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-94" name="__codelineno-26-94"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 10 : on ouvre le contexte de persistance ;</li>
<li>lignes 13-20 : les lignes des tables [CLIENTS] et [MEDECINS] sont mises dans le contexte puis supprimées de celui-ci. Nous venons de voir que cela vidait totalement la base ;</li>
<li>lignes 22-88 : des éléments sont ajoutés au contexte de persistance. Ils ont tous leur clé primaire à <strong>null</strong>. Ils seront donc insérés dans la base ;</li>
<li>ligne 90 : les changements opérés sur le contexte sont synchronisés avec la base. Celle-ci va faire l&#x27;objet d&#x27;une série d&#x27;opérations SQL DELETE suivie d&#x27;une série d&#x27;opérations SQL INSERT ;</li>
</ul>
<p>On fait du programme [Fill], le nouvel objet de démarrage du projet [1] puis on exécute ce dernier.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000060E00000139041C6C34.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.634cm;" /></td></tr></table>

<p>On constate en [2] que les tables ont été remplies.</p>
<h3 id="353-affichage-du-contenu-de-la-base">3.5.3. Affichage du contenu de la base</h3>
<p>Nous allons maintenant afficher le contenu de la base à l&#x27;aide de requêtes <strong>LINQ to Entity</strong>. LINQ (<strong>L</strong>anguage <strong>IN</strong>tegrated <strong>Q</strong>uery) est apparu avec le framework .NET 3.5 en 2007. Il apparaît comme une extension des langages .NET, c.a.d qu&#x27;il est intégré au langage et sa syntaxe est vérifiée par le compilateur. Il permet de requêter différentes collections avec une syntaxe présentant des similitudes avec le langage SQL (Structured Query Language) de requêtage des bases de données. Il existe différentes moutures de LINQ :</p>
<ul>
<li>LINQ to Object, pour requêter des collections en mémoire ;</li>
<li>LINQ to XML, pour requêter du XML ;</li>
<li>LINQ to Entity, pour requêter des bases de données ;</li>
</ul>
<p>Pour exister, LINQ s&#x27;appuie sur de nombreuses extensions faites aux langages .NET. Celles-ci peuvent être utilisées en-dehors de LINQ. Nous n&#x27;allons pas les présenter mais simplement donner deux références où le lecteur trouvera une description approfondie de LINQ :</p>
<ul>
<li><strong>LINQ in Action</strong>, Fabrice Marguerie, Steve Eichert, Jim Wooley aux éditions Manning ;</li>
<li><strong>LINQ pocket reference</strong>, Joseph et Ben Albahari aux éditions O&#x27;Reilly.</li>
</ul>
<p>J&#x27;ai lu le premier et l&#x27;ai trouvé excellent. Je n&#x27;ai pas lu le second mais ai lu des mêmes auteurs &quot; <strong>C# 3.0 in a nutshell</strong> &quot; à la sortie de LINQ. J&#x27;ai trouvé ce livre très au-dessus de la moyenne des livres que j&#x27;ai l&#x27;habitude de lire. Il semble que les autres livres de ces deux auteurs soient du même niveau. Nous allons par ailleurs utiliser <strong>LINQPad</strong>, un outil d&#x27;apprentissage de LINQ écrit par Joseph Albahari.</p>
<p>Nous allons afficher les entités présentes dans la base. Pour cela, nous ajoutons à leurs classes deux méthodes d&#x27;affichage. Commençons par l&#x27;entité [Medecin] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span>
<span class="normal"><a href="#__codelineno-27-35">35</a></span>
<span class="normal"><a href="#__codelineno-27-36">36</a></span>
<span class="normal"><a href="#__codelineno-27-37">37</a></span>
<span class="normal"><a href="#__codelineno-27-38">38</a></span>
<span class="normal"><a href="#__codelineno-27-39">39</a></span>
<span class="normal"><a href="#__codelineno-27-40">40</a></span>
<span class="normal"><a href="#__codelineno-27-41">41</a></span>
<span class="normal"><a href="#__codelineno-27-42">42</a></span>
<span class="normal"><a href="#__codelineno-27-43">43</a></span>
<span class="normal"><a href="#__codelineno-27-44">44</a></span>
<span class="normal"><a href="#__codelineno-27-45">45</a></span>
<span class="normal"><a href="#__codelineno-27-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1">// un médecin</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Medecin</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">    </span><span class="c1">// les créneaux horaires du médecin</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Medecin[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-27-32" name="__codelineno-27-32"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-27-33" name="__codelineno-27-33"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-27-34" name="__codelineno-27-34"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nf">ToString</span><span class="p">();</span>
<a id="__codelineno-27-35" name="__codelineno-27-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-36" name="__codelineno-27-36"></a>
<a id="__codelineno-27-37" name="__codelineno-27-37"></a><span class="w">    </span><span class="c1">// utilitaire</span>
<a id="__codelineno-27-38" name="__codelineno-27-38"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">timestamp</span><span class="p">){</span>
<a id="__codelineno-27-39" name="__codelineno-27-39"></a><span class="w">      </span><span class="kt">string</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<a id="__codelineno-27-40" name="__codelineno-27-40"></a><span class="w">      </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-27-41" name="__codelineno-27-41"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-27-42" name="__codelineno-27-42"></a><span class="w">        </span><span class="n">str</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-27-43" name="__codelineno-27-43"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-27-44" name="__codelineno-27-44"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">str</span><span class="p">;</span>
<a id="__codelineno-27-45" name="__codelineno-27-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-46" name="__codelineno-27-46"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 27-30 : la méthode <strong>ToString</strong> de la classe. On notera qu&#x27;elle n&#x27;affiche pas la collection de la ligne 21 ;</li>
<li>lignes 32-37 : la méthode <strong>ShortIdentity</strong> qui fait la même chose.</li>
</ul>
<p>Il nous faut ici expliquer les notions de <strong>Lazy et Eager Loading</strong> pour mesurer l&#x27;impact des deux méthodes précédentes. Nous avons vu qu&#x27;une entité pouvait avoir des dépendances sur une autre entité. Elles sont de deux natures :</p>
<ul>
<li>de <strong>un à plusieurs</strong>, comme ci-dessus où un médecin est relié à plusieurs créneaux horaires ;</li>
<li>de <strong>plusieurs à un</strong>, comme dans l&#x27;entité [Creneau] ci-dessous où un plusieurs créneaux sont reliés au même médecin ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="na">[Column(&quot;MEDECIN_ID&quot;)]</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MedecinId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;MedecinId&quot;)]</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Lorsque les dépendances sont chargées en même temps que les entités auxquelles elles sont attachées, on parle d&#x27;<strong>Eager Loading</strong>. Sinon, on parle de <strong>Lazy Loading</strong> : les dépendances ne sont chargées que lorsqu&#x27;elles sont référencées la première fois. Par défaut, EF 5 utilise le <strong>Lazy Loading</strong> : les dépendances ne sont pas chargées en même temps que l&#x27;entité.</p>
<p>Voyons notre méthode [ToString] ci-dessus :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="w">    </span><span class="c1">// les créneaux horaires du médecin</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Creneaux</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Medecin[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nf">ToString</span><span class="p">();</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La méthode [ToString] n&#x27;affiche pas la dépendance [Creneaux] de la ligne 2. Si elle l&#x27;avait fait, elle aurait alors forcé le chargement de tous les créneaux du médecin avant son exécution. C&#x27;est pour éviter ce chargement coûteux que la dépendance n&#x27;a pas été incluse dans la signature de l&#x27;entité. De façon générale, nous allons inclure deux signatures dans chaque entité :</p>
<ul>
<li>une méthode <strong>ToString</strong> qui affichera l&#x27;entité et ses éventuelles dépendances <strong>plusieurs à un</strong>. Comme il vient d&#x27;être expliqué cela provoquera le chargement de la dépendance ;</li>
<li>une méthode <strong>ShortIdentity</strong> qui ne référencera aucune dépendance. Il n&#x27;y aura donc aucun chargement de dépendance ;</li>
</ul>
<p>Les méthodes d&#x27;affichage des autres entités seront les suivantes :</p>
<p>L&#x27;entité [Client] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Client</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">    </span><span class="c1">// les Rvs du client</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Client[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nf">ToString</span><span class="p">();</span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 9-12 : la méthode [ToString] n&#x27;affiche pas la dépendance de la ligne 6 ;</li>
</ul>
<p>L&#x27;entité [Creneau] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Creneau</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="na">[Column(&quot;MEDECIN_ID&quot;)]</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MedecinId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;MedecinId&quot;)]</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="c1">// les Rvs du créneau</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Creneau[{0},{1},{2},{3},{4}, {5}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Hdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Mdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Hfin</span><span class="p">,</span><span class="w"> </span><span class="n">Mfin</span><span class="p">,</span><span class="w"> </span><span class="n">Medecin</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Creneau[{0},{1},{2},{3},{4}, {5}, {6}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Hdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Mdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Hfin</span><span class="p">,</span><span class="w"> </span><span class="n">Mfin</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">MedecinId</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 16 : la méthode [ToString] référence la dépendance de la ligne 9. Cela va forcer son chargement ;</li>
<li>ligne 11 : la dépendance [Rvs] n&#x27;est pas référencée. Elle ne sera pas chargée ;</li>
<li>lignes 21-22 : la méthode [ShortIdentity] ne référence plus la référence [Medecin] de la ligne 9. Celle-ci ne sera donc pas chargée.</li>
</ul>
<p>L&#x27;entité [Rv] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span>
<span class="normal"><a href="#__codelineno-32-21">21</a></span>
<span class="normal"><a href="#__codelineno-32-22">22</a></span>
<span class="normal"><a href="#__codelineno-32-23">23</a></span>
<span class="normal"><a href="#__codelineno-32-24">24</a></span>
<span class="normal"><a href="#__codelineno-32-25">25</a></span>
<span class="normal"><a href="#__codelineno-32-26">26</a></span>
<span class="normal"><a href="#__codelineno-32-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Rv</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="na">[Column(&quot;CLIENT_ID&quot;)]</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ClientId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;ClientId&quot;)]</span>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">    </span><span class="na">[Column(&quot;CRENEAU_ID&quot;)]</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CreneauId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="w">    </span><span class="na">[ForeignKey(&quot;CreneauId&quot;)]</span>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">virtual</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-15" name="__codelineno-32-15"></a>
<a id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-32-17" name="__codelineno-32-17"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-32-18" name="__codelineno-32-18"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-19" name="__codelineno-32-19"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Rv[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Jour</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Creneau</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-32-20" name="__codelineno-32-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-21" name="__codelineno-32-21"></a><span class="w">    </span><span class="c1">// signature courte</span>
<a id="__codelineno-32-22" name="__codelineno-32-22"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-32-23" name="__codelineno-32-23"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-24" name="__codelineno-32-24"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Rv[{0},{1},{2},{3},{4}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Jour</span><span class="p">,</span><span class="w"> </span><span class="n">ClientId</span><span class="p">,</span><span class="w"> </span><span class="n">CreneauId</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-32-25" name="__codelineno-32-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-26" name="__codelineno-32-26"></a>
<a id="__codelineno-32-27" name="__codelineno-32-27"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 17-20 : la méthode [ToString] référence les dépendances des lignes 9 et 14. Cela va forcer leur chargement ;</li>
<li>lignes 17-20 : la méthode [ShortIdentity] évite cela et donc les dépendances ne seront pas chargées.</li>
</ul>
<p>En conclusion, on prêtera attention aux méthodes [ToString] des entités. Si on n&#x27;y prête pas attention, afficher une table peut charger la moitié de la base si la table a de nombreuses dépendances.</p>
<p>Ceci expliqué, on écrit le nouveau code [Dump.cs] suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span>
<span class="normal"><a href="#__codelineno-33-34">34</a></span>
<span class="normal"><a href="#__codelineno-33-35">35</a></span>
<span class="normal"><a href="#__codelineno-33-36">36</a></span>
<span class="normal"><a href="#__codelineno-33-37">37</a></span>
<span class="normal"><a href="#__codelineno-33-38">38</a></span>
<span class="normal"><a href="#__codelineno-33-39">39</a></span>
<span class="normal"><a href="#__codelineno-33-40">40</a></span>
<span class="normal"><a href="#__codelineno-33-41">41</a></span>
<span class="normal"><a href="#__codelineno-33-42">42</a></span>
<span class="normal"><a href="#__codelineno-33-43">43</a></span>
<span class="normal"><a href="#__codelineno-33-44">44</a></span>
<span class="normal"><a href="#__codelineno-33-45">45</a></span>
<span class="normal"><a href="#__codelineno-33-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="p">{</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Dump</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">      </span><span class="c1">// dump de la base</span>
<a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Clients--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-33-18" name="__codelineno-33-18"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-33-19" name="__codelineno-33-19"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-20" name="__codelineno-33-20"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-33-21" name="__codelineno-33-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-22" name="__codelineno-33-22"></a><span class="w">        </span><span class="c1">// les médecins</span>
<a id="__codelineno-33-23" name="__codelineno-33-23"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Médecins--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-33-24" name="__codelineno-33-24"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">medecin</span><span class="p">;</span>
<a id="__codelineno-33-25" name="__codelineno-33-25"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">medecins</span><span class="p">)</span>
<a id="__codelineno-33-26" name="__codelineno-33-26"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-27" name="__codelineno-33-27"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-33-28" name="__codelineno-33-28"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-29" name="__codelineno-33-29"></a><span class="w">        </span><span class="c1">// les créneaux horaires</span>
<a id="__codelineno-33-30" name="__codelineno-33-30"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Créneaux horaires--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-33-31" name="__codelineno-33-31"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">creneaux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">creneau</span><span class="p">;</span>
<a id="__codelineno-33-32" name="__codelineno-33-32"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">creneaux</span><span class="p">)</span>
<a id="__codelineno-33-33" name="__codelineno-33-33"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-34" name="__codelineno-33-34"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">creneau</span><span class="p">);</span>
<a id="__codelineno-33-35" name="__codelineno-33-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-36" name="__codelineno-33-36"></a><span class="w">        </span><span class="c1">// les Rdvs</span>
<a id="__codelineno-33-37" name="__codelineno-33-37"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Rendez-vous--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-33-38" name="__codelineno-33-38"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">rvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">rv</span><span class="p">;</span>
<a id="__codelineno-33-39" name="__codelineno-33-39"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Rv</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rvs</span><span class="p">)</span>
<a id="__codelineno-33-40" name="__codelineno-33-40"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-41" name="__codelineno-33-41"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
<a id="__codelineno-33-42" name="__codelineno-33-42"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-43" name="__codelineno-33-43"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-33-44" name="__codelineno-33-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-45" name="__codelineno-33-45"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-33-46" name="__codelineno-33-46"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons expliquer les lignes 17-21 qui affiche les entités [Client]. L&#x27;explication donnée vaudra pour les autres entités.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span>
<span class="normal"><a href="#__codelineno-34-5">5</a></span>
<span class="normal"><a href="#__codelineno-34-6">6</a></span>
<span class="normal"><a href="#__codelineno-34-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Clients--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 3 : le mot clé <strong>var</strong> a été introduit avec C# 3.0. Il permet d&#x27;éviter d&#x27;indiquer le type précis d&#x27;une variable. Le compilateur déduit alors celui-ci du type de l&#x27;expression affectée à la variable ;</li>
<li>ligne 3 : l&#x27;expression affectée à la variable <em>clients</em> est une requête <strong>LINQ to Entity</strong>. On y reconnaît des mots clés du langage SQL portés dans LINQ. La syntaxe utilisée ici est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">from</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">DbSet</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">variable</span>
</code></pre></div></td></tr></table></div>
<p>Une syntaxe plus générale de LINQ est</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">variable</span> <span class="ow">in</span> <span class="n">collection</span> <span class="n">select</span> <span class="n">variable</span>
</code></pre></div></td></tr></table></div>
<p>La collection va être parcourue et pour chaque élément de celle-ci, la variable va être évaluée. Ceci n&#x27;est fait que lorsque la variable [clients] de la ligne 3 va être énumérée par le for / each des lignes 4-7. Tant que ceci n&#x27;est pas fait, la variable [clients] n&#x27;est qu&#x27;une requête non évaluée ;</p>
<ul>
<li>ligne 4 : la requête [clients] est énumérée. Cela va forcer l&#x27;évaluation de la requête. Les lignes de la table [CLIENTS] vont être amenées tour à tour dans le contexte de persistance ;</li>
<li>ligne 6 : la méthode [ToString] de l&#x27;entité [Client] est utilisée pour l&#x27;affichage. Il n&#x27;y a aucun chargement de dépendances ;</li>
</ul>
<p>Passons aux lignes suivantes du code :</p>
<ul>
<li>lignes 24-28 : les lignes de la table [MEDECINS] sont amenées dans le contexte de persistance et affichées. Il n&#x27;y a aucun chargement de dépendances ;</li>
<li>lignes 31-35 : les lignes de la table [CRENEAUX] sont amenées dans le contexte de persistance et affichées. Nous avons vu que la méthode [ToString] de cette entité affichait la dépendance [Medecin]. Or celle-ci est déjà chargée. Il n&#x27;y aura donc pas de nouveau chargement ;</li>
<li>lignes 38-42 : les lignes de la table [RVS] sont amenées dans le contexte de persistance et affichées. Nous avons vu que la méthode [ToString] de cette entité affichait les dépendances [Client] et [Creneau]. Or celles-ci sont déjà chargées. Il n&#x27;y aura donc pas de nouveaux chargements.</li>
</ul>
<p>On notera que l&#x27;ordre d&#x27;affichage n&#x27;est pas neutre. Si on avait voulu afficher d&#x27;abord les entités [Rv], la méthode [ToString] de celle-ci aurait provoqué le chargement des entités [Client] et [Creneau] liées à ces rendez-vous. Les autres n&#x27;auraient pas été chargées. Elles l&#x27;auraient été plus tard dans un autre affichage. Cela a un impact sur les performances. Le code précédent a besoin de quatre ordres SQL pour faire afficher toutes les entités. Supposons maintenant qu&#x27;on exploite d&#x27;abord la tables [RVS] des rendez-vous. Une première requête SQL est nécessaire pour la table [RVS]. Ensuite, la méthode [ToString] de l&#x27;entité [Rv] va provoquer le chargement éventuel des entités [Client] et [Creneau] associées. Il faut une requête SQL pour chacune. En supposant qu&#x27;il y ait N2 clients et N3 créneaux et que toutes ces entités soient référencées dans la table [RVS], l&#x27;affichage de celle-ci nécessitera 1+N2+N3 requêtes SQL. Donc, on n&#x27;est moins performant que dans la version étudiée. Pour afficher la table [RVS] avec ses dépendances, une jointure entre tables serait nécessaire. Il est possible de la réaliser avec LINQ. Nous y reviendrons sur un exemple. Pour l&#x27;instant, nous nous rappellerons que nous devons prêter attention aux requêtes SQL sous-jacentes à notre code LINQ.</p>
<p>On paramètre le projet pour exécuter ce nouveau code [1] et [2] puis on l&#x27;exécute :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000397000001DEA3F83582.png" style="display:inline-block; margin:4px;width:12.158cm;height:6.324cm;" /></td></tr></table>

<p>L&#x27;affichage console est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span>
<span class="normal"><a href="#__codelineno-37-27">27</a></span>
<span class="normal"><a href="#__codelineno-37-28">28</a></span>
<span class="normal"><a href="#__codelineno-37-29">29</a></span>
<span class="normal"><a href="#__codelineno-37-30">30</a></span>
<span class="normal"><a href="#__codelineno-37-31">31</a></span>
<span class="normal"><a href="#__codelineno-37-32">32</a></span>
<span class="normal"><a href="#__codelineno-37-33">33</a></span>
<span class="normal"><a href="#__codelineno-37-34">34</a></span>
<span class="normal"><a href="#__codelineno-37-35">35</a></span>
<span class="normal"><a href="#__codelineno-37-36">36</a></span>
<span class="normal"><a href="#__codelineno-37-37">37</a></span>
<span class="normal"><a href="#__codelineno-37-38">38</a></span>
<span class="normal"><a href="#__codelineno-37-39">39</a></span>
<span class="normal"><a href="#__codelineno-37-40">40</a></span>
<span class="normal"><a href="#__codelineno-37-41">41</a></span>
<span class="normal"><a href="#__codelineno-37-42">42</a></span>
<span class="normal"><a href="#__codelineno-37-43">43</a></span>
<span class="normal"><a href="#__codelineno-37-44">44</a></span>
<span class="normal"><a href="#__codelineno-37-45">45</a></span>
<span class="normal"><a href="#__codelineno-37-46">46</a></span>
<span class="normal"><a href="#__codelineno-37-47">47</a></span>
<span class="normal"><a href="#__codelineno-37-48">48</a></span>
<span class="normal"><a href="#__codelineno-37-49">49</a></span>
<span class="normal"><a href="#__codelineno-37-50">50</a></span>
<span class="normal"><a href="#__codelineno-37-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a>Clients--------------------------------------
<a id="__codelineno-37-2" name="__codelineno-37-2"></a>Client[9,Mr,Jules,Martin,000000844]
<a id="__codelineno-37-3" name="__codelineno-37-3"></a>Client[10,Mme,Christine,German,000000845]
<a id="__codelineno-37-4" name="__codelineno-37-4"></a>Client[11,Mr,Jules,Jacquard,000000846]
<a id="__codelineno-37-5" name="__codelineno-37-5"></a>Client[12,Melle,Brigitte,Bistrou,000000847]
<a id="__codelineno-37-6" name="__codelineno-37-6"></a>Médecins--------------------------------------
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>Medecin[9,Mme,Marie,Pelissier,000000848]
<a id="__codelineno-37-8" name="__codelineno-37-8"></a>Medecin[10,Mr,Jacques,Bromard,000000873]
<a id="__codelineno-37-9" name="__codelineno-37-9"></a>Medecin[11,Mr,Philippe,Jandot,000000886]
<a id="__codelineno-37-10" name="__codelineno-37-10"></a>Medecin[12,Melle,Justine,Jacquemot,000000887]
<a id="__codelineno-37-11" name="__codelineno-37-11"></a>Créneaux horaires--------------------------------------
<a id="__codelineno-37-12" name="__codelineno-37-12"></a>Creneau[73,8,0,8,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000849]
<a id="__codelineno-37-13" name="__codelineno-37-13"></a>Creneau[74,8,20,8,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000850]
<a id="__codelineno-37-14" name="__codelineno-37-14"></a>Creneau[75,8,40,9,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000851]
<a id="__codelineno-37-15" name="__codelineno-37-15"></a>Creneau[76,9,0,9,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000852]
<a id="__codelineno-37-16" name="__codelineno-37-16"></a>Creneau[77,9,20,9,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000853]
<a id="__codelineno-37-17" name="__codelineno-37-17"></a>Creneau[78,9,40,10,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000854]
<a id="__codelineno-37-18" name="__codelineno-37-18"></a>Creneau[79,10,0,10,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000855]
<a id="__codelineno-37-19" name="__codelineno-37-19"></a>Creneau[80,10,20,10,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000856]
<a id="__codelineno-37-20" name="__codelineno-37-20"></a>Creneau[81,10,40,11,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000857]
<a id="__codelineno-37-21" name="__codelineno-37-21"></a>Creneau[82,11,0,11,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000858]
<a id="__codelineno-37-22" name="__codelineno-37-22"></a>Creneau[83,11,20,11,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000859]
<a id="__codelineno-37-23" name="__codelineno-37-23"></a>Creneau[84,11,40,12,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000860]
<a id="__codelineno-37-24" name="__codelineno-37-24"></a>Creneau[85,14,0,14,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000861]
<a id="__codelineno-37-25" name="__codelineno-37-25"></a>Creneau[86,14,20,14,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000862]
<a id="__codelineno-37-26" name="__codelineno-37-26"></a>Creneau[87,14,40,15,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000863]
<a id="__codelineno-37-27" name="__codelineno-37-27"></a>Creneau[88,15,0,15,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000864]
<a id="__codelineno-37-28" name="__codelineno-37-28"></a>Creneau[89,15,20,15,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000865]
<a id="__codelineno-37-29" name="__codelineno-37-29"></a>Creneau[90,15,40,16,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000866]
<a id="__codelineno-37-30" name="__codelineno-37-30"></a>Creneau[91,16,0,16,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000867]
<a id="__codelineno-37-31" name="__codelineno-37-31"></a>Creneau[92,16,20,16,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000868]
<a id="__codelineno-37-32" name="__codelineno-37-32"></a>Creneau[93,16,40,17,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000869]
<a id="__codelineno-37-33" name="__codelineno-37-33"></a>Creneau[94,17,0,17,20, Medecin[9,Mme,Marie,Pelissier,000000848],000000870]
<a id="__codelineno-37-34" name="__codelineno-37-34"></a>Creneau[95,17,20,17,40, Medecin[9,Mme,Marie,Pelissier,000000848],000000871]
<a id="__codelineno-37-35" name="__codelineno-37-35"></a>Creneau[96,17,40,18,0, Medecin[9,Mme,Marie,Pelissier,000000848],000000872]
<a id="__codelineno-37-36" name="__codelineno-37-36"></a>Creneau[97,8,0,8,20, Medecin[10,Mr,Jacques,Bromard,000000873],000000874]
<a id="__codelineno-37-37" name="__codelineno-37-37"></a>Creneau[98,8,20,8,40, Medecin[10,Mr,Jacques,Bromard,000000873],000000875]
<a id="__codelineno-37-38" name="__codelineno-37-38"></a>Creneau[99,8,40,9,0, Medecin[10,Mr,Jacques,Bromard,000000873],000000876]
<a id="__codelineno-37-39" name="__codelineno-37-39"></a>Creneau[100,9,0,9,20, Medecin[10,Mr,Jacques,Bromard,000000873],000000877]
<a id="__codelineno-37-40" name="__codelineno-37-40"></a>Creneau[101,9,20,9,40, Medecin[10,Mr,Jacques,Bromard,000000873],000000878]
<a id="__codelineno-37-41" name="__codelineno-37-41"></a>Creneau[102,9,40,10,0, Medecin[10,Mr,Jacques,Bromard,000000873],000000879]
<a id="__codelineno-37-42" name="__codelineno-37-42"></a>Creneau[103,10,0,10,20, Medecin[10,Mr,Jacques,Bromard,000000873],000000880]
<a id="__codelineno-37-43" name="__codelineno-37-43"></a>Creneau[104,10,20,10,40, Medecin[10,Mr,Jacques,Bromard,000000873],000000881]
<a id="__codelineno-37-44" name="__codelineno-37-44"></a>Creneau[105,10,40,11,0, Medecin[10,Mr,Jacques,Bromard,000000873],000000882]
<a id="__codelineno-37-45" name="__codelineno-37-45"></a>Creneau[106,11,0,11,20, Medecin[10,Mr,Jacques,Bromard,000000873],000000883]
<a id="__codelineno-37-46" name="__codelineno-37-46"></a>Creneau[107,11,20,11,40, Medecin[10,Mr,Jacques,Bromard,000000873],000000884]
<a id="__codelineno-37-47" name="__codelineno-37-47"></a>Creneau[108,11,40,12,0, Medecin[10,Mr,Jacques,Bromard,000000873],000000885]
<a id="__codelineno-37-48" name="__codelineno-37-48"></a>Rendez-vous--------------------------------------
<a id="__codelineno-37-49" name="__codelineno-37-49"></a>Rv[3,08/10/2012 00:00:00,Client[9,Mr,Jules,Martin,000000844],Creneau[73,8,0,8,20
<a id="__codelineno-37-50" name="__codelineno-37-50"></a>, Medecin[9,Mme,Marie,Pelissier,000000848],000000849],000000888]
<a id="__codelineno-37-51" name="__codelineno-37-51"></a>Appuyez sur une touche pour continuer...
</code></pre></div></td></tr></table></div>
<h3 id="354-apprentissage-de-linq-avec-linqpad">3.5.4. Apprentissage de LINQ avec LINQPad</h3>
<p>Nous avons utilisé ci-dessus, des requêtes LINQ to Entity pour afficher le contenu des tables de la base de données. Joseph Albahari a écrit un programme d&#x27;apprentissage des différentes formes de LINQ. Nous le présentons maintenant.</p>
<p>LINQPad est disponible à l&#x27;URL suivante [<a href="http://www.linqpad.net/">http://www.linqpad.net/</a>]. Une fois installé, nous le lançons [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006470000012ED9EC5A63.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.381cm;" /></td></tr></table>

<p>Le débutant LINQ pourra s&#x27;initier avec les exemples de l&#x27;onglet [Samples] [2] qui montrent de très nombreux exemples. Sélectionnons l&#x27;exemple [3] qui s&#x27;affiche alors dans une autre fenêtre [4]. Le code complet de l&#x27;exemple est celui-ci :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="o">//</span> <span class="n">Now</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">LINQ</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">objects</span> <span class="n">query</span> <span class="n">expression</span> <span class="p">(</span><span class="n">notice</span> <span class="n">no</span> <span class="n">semicolon</span><span class="p">):</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">word</span> <span class="ow">in</span> <span class="s2">&quot;The quick brown fox jumps over the lazy dog&quot;</span><span class="o">.</span><span class="n">Split</span><span class="p">()</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="n">orderby</span> <span class="n">word</span><span class="o">.</span><span class="n">Length</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="n">select</span> <span class="n">word</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="o">//</span> <span class="n">Feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">edit</span> <span class="n">this</span><span class="o">...</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">one</span><span class="s1">&#39;s watching!) You&#39;</span><span class="n">ll</span> <span class="n">be</span> <span class="n">prompted</span> <span class="n">to</span> <span class="n">save</span> <span class="nb">any</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="o">//</span> <span class="n">changes</span> <span class="n">to</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">file</span><span class="o">.</span>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="o">//</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="o">//</span> <span class="n">Tip</span><span class="p">:</span>  <span class="n">You</span> <span class="n">can</span> <span class="n">execute</span> <span class="n">part</span> <span class="n">of</span> <span class="n">a</span> <span class="n">query</span> <span class="n">by</span> <span class="n">highlighting</span> <span class="n">it</span><span class="p">,</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">pressing</span> <span class="n">F5</span><span class="o">.</span>
</code></pre></div></td></tr></table></div>
<p>Les lignes 3-5 sont un exemple de requête LINQ to Object. La requête LINQ suit la syntaxe :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">variable</span> <span class="ow">in</span> <span class="n">collection</span> <span class="n">orderby</span> <span class="n">élément1</span> <span class="n">select</span> <span class="n">élément2</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><strong>variable</strong> désigne l&#x27;élément courant de la collection. Dans notre exemple, cette collection est la liste de mots résultats de la chaîne splittée ;</li>
<li>la collection est ordonnée selon le paramètre <em>élément1</em> de <strong>orderby</strong>. Dans notre exemple, la collection de mots sera ordonnée selon leur longueur ;</li>
<li>le mot clé <strong>select</strong> désigne ce qu&#x27;on veut retirer de l&#x27;élément courant <em>variable</em> de la collection. Dans notre exemple, ce sera le mot.</li>
</ul>
<p>Exécutons cette requête LINQ :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000557000001F4AFF26824.png" style="display:inline-block; margin:4px;width:17.999cm;height:6.583cm;" /></td></tr></table>

<ul>
<li>en [1] : une expression LINQ est exécutée par [F5] ou bien via le bouton d&#x27;exécution ;</li>
<li>en [2] : l&#x27;affichage. Les mots sont affichés dans l&#x27;ordre de leur longueur. Ce simple exemple montre la puissance de LINQ ;</li>
<li>en [3], il est possible de télécharger d&#x27;autres exemples, notamment ceux du livre &quot; LINQ in action &quot; [4] ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005CB00000259CA570793.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.294cm;" /></td></tr></table>

<ul>
<li>en [5], nous choisissons un exemple du livre ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wonderful&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;linq&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;beautiful&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;world&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="c1">// Group words by length</span>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="kt">var</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">words</span>
<a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w">  </span><span class="k">orderby</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="k">ascending</span>
<a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">word</span><span class="p">.</span><span class="n">Length</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">lengthGroups</span>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">  </span><span class="k">orderby</span><span class="w"> </span><span class="n">lengthGroups</span><span class="p">.</span><span class="n">Key</span><span class="w"> </span><span class="k">descending</span>
<a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lengthGroups</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lengthGroups</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="c1">// Print each group out</span>
<a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="p">{</span>
<a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">  </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Words of length &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">group</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
<a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w">  </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">group</span><span class="p">.</span><span class="n">Words</span><span class="p">)</span>
<a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">    </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">word</span><span class="p">);</span>
<a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 4 : une nouvelle requête LINQ avec de nouveaux mots clés ;</li>
<li>ligne 5 : la collection requêtée est le tableau de mots de la ligne 1 ;</li>
<li>ligne 6 : la collection est triée dans l&#x27;ordre alphabétique des mots ;</li>
<li>ligne 7 : la collection est regroupée dans (mot clé <strong>into</strong>) une nouvelle collection <em>lengthGroups</em>. <em>lengthGroups.Key</em> représente le facteur de regroupement (mot clé <strong>by</strong>), ici la longueur des mots.  <em>lengthGroups</em> rassemble les mots ayant le même facteur de regroupement donc la même longueur ;</li>
<li>ligne 8 : la collection <em>lengthGroups</em> est ordonnée par clé de regroupement descendant, donc ici par taille décroissante des mots ;</li>
<li>ligne 9 : de cette collection, on produit de nouveaux objets (classes anonymes) ayant deux champs :</li>
<li><strong>Length</strong> : la longueur des mots,</li>
<li><strong>Words</strong> : les mots ayant cette longueur ;</li>
</ul>
<p>Ici, on voit particulièrement l&#x27;intérêt du mot clé <strong>var</strong> de la ligne 4. Parce qu&#x27;on a utilisé une classe anonyme ligne 9, on ne sait pas désigner le type de la variable <em>groups</em>. Le compilateur lui, va donner un nom interne à la classe anonyme et va typer avec, la variable <em>groups</em>. Il sera capable ensuite de dire si la variable <em>groups</em> est utilisée correctement </p>
<ul>
<li>ligne 12 : parcours de la requête de la ligne 4. Ce n&#x27;est qu&#x27;à ce moment qu&#x27;elle est évaluée. On se rappelle que son exécution va produire une collection d&#x27;objets, précisés ligne 9 ;</li>
<li>ligne 14 : on affiche la propriété <em>Length</em> de l&#x27;élément courant, donc une longueur de mots ;</li>
<li>lignes 15-17 : on affiche chaque élément de la collection de la propriété <em>Words</em>, donc l&#x27;ensemble des mots ayant la longueur affichée précédemment.</li>
</ul>
<p>Lorsque nous exécutons cette requête, nous obtenons le résultat suivant dans LINQPad :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000A6000000BEE32C6F01.png" style="display:inline-block; margin:4px;width:3.069cm;height:3.521cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Maintenant que nous avons vu quelques exemples de requêtes [LINQ to Object], voyons des requêtes [LINQ to Entity] qui vont nous permettre de requêter des bases de données. Nous allons tout d&#x27;abord nous connecter à la base de données SQL Server que nous avons créée et remplie :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000062A000003059D1DE040.png" style="display:inline-block; margin:4px;width:17.999cm;height:8.816cm;" /></td></tr></table>

<ul>
<li>en [1], on ajoute une connexion à une base de données ;</li>
<li>en [2], les moyens d&#x27;accès à la source de données. Pour accéder à la base SQL Server, nous utiliserons [LINQPad Driver] ;</li>
<li>en [3], il est également possible de récupérer un contexte de persistance [DbContext] défini dans un <em>assembly</em> <strong>.exe</strong> ou <strong>.dll</strong> (option 3). Malheureusement, à ce jour (8 octobre 2012), Entity Framework 5 n&#x27;est pas supporté ;</li>
<li>en [4], il est possible de télécharger des pilotes pour d&#x27;autres SGBD que SQL Server ;</li>
<li>en [5], on téléchargera le driver pour les SGBD MySQL et Oracle ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F40000032CDABB65B5.png" style="display:inline-block; margin:4px;width:17.999cm;height:9.589cm;" /></td></tr></table>

<ul>
<li>en [6], le pilote téléchargé ;</li>
<li>en [7], nous nous connectons à une base SQL Server ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005BC000004575603A256.png" style="display:inline-block; margin:4px;width:17.999cm;height:13.621cm;" /></td></tr></table>

<ul>
<li>en [8], la base est sur le serveur de nom (local) ;</li>
<li>en [9], on se connecte avec l&#x27;authentification sa / sqlserver2012 ;</li>
<li>en [10], à la base [rdvmedecins-ef] que nous avons créée ;</li>
<li>en [11], on peut tester la connexion ;</li>
<li>en [12], on termine l&#x27;assistant ;</li>
<li>en [13], la connexion apparaît dans LINQPad.</li>
</ul>
<p>Les entités ont été créées à partir de la table [rdvmedecins-ef]. Ce sont les suivantes :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004E5000002E9903637EA.png" style="display:inline-block; margin:4px;width:16.577cm;height:9.857cm;" /></td></tr></table>

<ul>
<li>en [1], [CLIENTS] représente l&#x27;ensemble des entités [Client]. Chaque entité a : </li>
<li>les propriétés (ID, TITRE, NOM, PRENOM, TIMESTAMP),</li>
<li>une relation 1 à plusieurs [CLIENTRVS] ;</li>
<li>en [2], [CRENEAUXes] représente l&#x27;ensemble des entités [Creneau]. Chaque entité a : </li>
<li>les propriétés (ID, HDEBUT, MDEBUT, HFIN, MFIN, MEDECIN_ID, TIMESTAMP),</li>
<li>une relation 1 à plusieurs [CRENEAURVS],</li>
<li>une relation plusieurs à 1 [MEDECIN] ;</li>
<li>en [3], l&#x27;entité [MEDECINS] représente l&#x27;ensemble des entités [Medecin]. Chaque entité a : </li>
<li>les propriétés (ID, TITRE, NOM, PRENOM, TIMESTAMP),</li>
<li>une relation 1 à plusieurs [MEDECINCRENEAUXes] ;</li>
<li>en [4], l&#x27;entité [RVS] représente l&#x27;ensemble des entités [Rv]. Chaque entité a : </li>
<li>les propriétés (ID, JOUR, CLIET_ID, CRENEAU_ID, TIMESTAMP),</li>
<li>une relation plusieurs à 1 [CLIENT],</li>
<li>une relation plusieurs à 1 [CRENEAU].</li>
</ul>
<p>On notera que les noms des propriétés ci-dessus sont différentes des noms que nous avons utilisés jusqu&#x27;à maintenant. Cela importe peu. Nous voulons juste apprendre les principes de base du requêtage sur base de données.</p>
<p>Voyons comment nous pouvons requêter cette base d&#x27;entités. Par exemple, nous voulons la liste des médecins ordonnée par leur TITRE et NOM :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000409000000D0B758E517.png" style="display:inline-block; margin:4px;width:13.667cm;height:2.752cm;" /></td></tr></table>

<ul>
<li>en [1], on crée une nouvelle requête ;</li>
<li>en [2], le texte de la requête ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004040000014B32E1DAB6.png" style="display:inline-block; margin:4px;width:13.6cm;height:4.38cm;" /></td></tr></table>

<ul>
<li>en [3], le résultat de la requête ;</li>
<li>en [4], la même requête avec des <strong>expressions lambda</strong>. Une requête avec des expressions lambda est moins lisible qu&#x27;une requête texte et on pourrait vouloir s&#x27;en passer. Elles sont cependant parfois indispensables car elles permettent certaines choses que les requêtes texte ne permettent pas. Une expression lambda désigne une fonction à un paramètre d&#x27;entrée <em>a</em> et un paramètre de sortie <em>b</em>, sous la forme <em>a=&gt;b</em>. La méthode <strong>OrderBy</strong> ci-dessus admet une fonction lambda comme unique paramètre. Celle-ci lui fournit le paramètre selon lequel doit être ordonnée une collection. Ainsi <em>MEDECINS.OrderBy(m=&gt;m.TITRE)</em> est la liste des médecins ordonnée par les titres. Il faut lire l&#x27;instruction comme un pipe-line sur une collection. La collection des médecins est fournie en entrée à la méthode <em>OrderBy</em>. Celle-ci va exploiter les entités [Medecin] une par une. Dans l&#x27;expression lambda m=&gt;m.TITRE, m représente l&#x27;entrée de la fonction lambda. On peut la nommer comme on veut. Ici, l&#x27;entrée de la fonction lambda sera une entité [Medecin]. La fonction m=&gt;m.TITRE se lit comme suit : si j&#x27;appelle <em>m</em> mon entrée (une entité [Medecin]) alors ma sortie est <em>m.TITRE</em>, donc le titre du médecin. <em>MEDECINS.OrderBy(m=&gt;m.TITRE)</em> est a son tour une collection, la collection des médecins ordonnée par les titres. Cette nouvelle collection peut alimenter une autre méthode, dans l&#x27;exemple la méthode <em>ThenBy</em>. Celle-ci fonctionne sur le même principe. Elle sert à indiquer des paramètres supplémentaires pour le tri de la collection.</li>
</ul>
<p>Lire le code lambda équivalent au code texte que nous tapons habituellement est une bonne façon de l&#x27;apprendre ;</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003B7000000BE3FE74288.png" style="display:inline-block; margin:4px;width:12.582cm;height:2.514cm;" /></td></tr></table>

<ul>
<li>en [5], l&#x27;ordre SQL émis sur la base. Là encore, on lira attentivement ce code. Il permet d&#x27;évaluer le coût réel d&#x27;une requête LINQ.</li>
</ul>
<p>Dans la suite, nous présentons quelques exemples de requête LINQ. A chaque fois, nous montrons les résultats affichés et les codes lambda et SQL équivalents. Pour comprendre ces requêtes, il faut rappeler les relations plusieurs à un qui relient les entités les unes aux autres. C&#x27;est par elles qu&#x27;on navigue d&#x27;une entité à l&#x27;autre. On les appelle des <strong>propriétés navigationnelles</strong>.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003930000016A1C1E9EE3.png" style="display:inline-block; margin:4px;width:12.106cm;height:4.789cm;" /></td></tr></table>

<p>// <strong>les clients dont le titre est Mr classés par ordre décroissant des noms</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001780000008D7ED838D3.png" style="display:inline-block; margin:4px;width:6.96cm;height:2.611cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">client</span> <span class="ow">in</span> <span class="n">CLIENTS</span> <span class="n">where</span> <span class="n">client</span><span class="o">.</span><span class="n">TITRE</span><span class="o">==</span><span class="s2">&quot;Mr&quot;</span> <span class="n">orderby</span> <span class="n">client</span><span class="o">.</span><span class="n">NOM</span> <span class="n">descending</span>  <span class="n">select</span> <span class="n">client</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span>
<span class="normal"><a href="#__codelineno-42-2">2</a></span>
<span class="normal"><a href="#__codelineno-42-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a>CLIENTS
<a id="__codelineno-42-2" name="__codelineno-42-2"></a>.Where (client =&gt; (client.TITRE == &quot;Mr&quot;))
<a id="__codelineno-42-3" name="__codelineno-42-3"></a>.OrderByDescending (client =&gt; client.NOM)
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span>
<span class="normal"><a href="#__codelineno-43-3">3</a></span>
<span class="normal"><a href="#__codelineno-43-4">4</a></span>
<span class="normal"><a href="#__codelineno-43-5">5</a></span>
<span class="normal"><a href="#__codelineno-43-6">6</a></span>
<span class="normal"><a href="#__codelineno-43-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="c1">-- Region Parameters</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="w"> </span><span class="n">NVarChar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Mr&#39;</span>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="c1">-- EndRegion</span>
<a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">NOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">CLIENTS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span>
<a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="k">DESC</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p><strong>// tous les créneaux horaires avec le médecin associé</strong></p>
<p><strong>Résultats (partiels) </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001AC00000253611DFB15.png" style="display:inline-block; margin:4px;width:7.93cm;height:11.021cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">creneau</span> <span class="ow">in</span> <span class="n">CRENEAUXes</span> <span class="n">select</span> <span class="n">new</span> <span class="p">{</span> <span class="n">hd</span><span class="o">=</span><span class="n">creneau</span><span class="o">.</span><span class="n">HDEBUT</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="n">creneau</span><span class="o">.</span><span class="n">MDEBUT</span><span class="p">,</span> <span class="n">hf</span><span class="o">=</span><span class="n">creneau</span><span class="o">.</span><span class="n">HFIN</span><span class="p">,</span> <span class="n">mf</span><span class="o">=</span><span class="n">creneau</span><span class="o">.</span><span class="n">MFIN</span><span class="p">,</span> <span class="n">medecin</span><span class="o">=</span><span class="n">creneau</span><span class="o">.</span><span class="n">MEDECIN</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000103000000EC9C847D64.png" style="display:inline-block; margin:4px;width:4.8cm;height:4.369cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">HDEBUT</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">hd</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MDEBUT</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">md</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">HFIN</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">hf</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MFIN</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">mf</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">NOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p><strong>// tous les rv avec le client et le médecin associés</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000221000000F08A4F9E2E.png" style="display:inline-block; margin:4px;width:10.089cm;height:4.45cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rv</span> <span class="ow">in</span> <span class="n">RVS</span> <span class="n">select</span> <span class="n">new</span> <span class="p">{</span> <span class="n">rv</span><span class="o">=</span><span class="n">rv</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">,</span> <span class="n">medecin</span><span class="o">=</span><span class="n">rv</span><span class="o">.</span><span class="n">CRENEAU</span><span class="o">.</span><span class="n">MEDECIN</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000011D000000BF5A04B09D.png" style="display:inline-block; margin:4px;width:5.279cm;height:3.54cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">NOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">ID2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">TITRE2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">NOM2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">PRENOM2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">TIMESTAMP2</span><span class="p">]</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">RVS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CLIENTS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">CLIENT_ID</span><span class="p">]</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">CRENEAU_ID</span><span class="p">]</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p>// <strong>les médecins n&#x27;ayant pas de Rdv</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000184000000939FBA5A7B.png" style="display:inline-block; margin:4px;width:7.19cm;height:2.72cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000019800000099D1496E11.png" style="display:inline-block; margin:4px;width:7.519cm;height:2.829cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span>
<span class="normal"><a href="#__codelineno-48-3">3</a></span>
<span class="normal"><a href="#__codelineno-48-4">4</a></span>
<span class="normal"><a href="#__codelineno-48-5">5</a></span>
<span class="normal"><a href="#__codelineno-48-6">6</a></span>
<span class="normal"><a href="#__codelineno-48-7">7</a></span>
<span class="normal"><a href="#__codelineno-48-8">8</a></span>
<span class="normal"><a href="#__codelineno-48-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">NOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="p">(</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">EMPTY</span><span class="p">]</span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">RVS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">CRENEAU_ID</span><span class="p">]</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span>
<a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">    </span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p>Il n&#x27;y a pas de requête LINQ pour cette demande. Il faut passer par des expressions lambda. Celle-ci se lit de la façon suivante : je prends la collection des médecins (MEDECINS) et je ne garde (Where) que les médecins (m) tels que je ne suis pas capable de trouver dans la collection des rendez-vous (RVS) un rendez-vous (rv) avec ce médecin (m).</p>
<p><strong>// créneaux horaires de Mme Pélissier</strong></p>
<p><strong>Résultats (partiels) </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000021100000129B47F116A.png" style="display:inline-block; margin:4px;width:9.8cm;height:5.5cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">creneau</span> <span class="ow">in</span> <span class="n">CRENEAUXes</span> <span class="n">where</span> <span class="n">creneau</span><span class="o">.</span><span class="n">MEDECIN</span><span class="o">.</span><span class="n">NOM</span><span class="o">==</span><span class="s2">&quot;Pelissier&quot;</span> <span class="n">select</span> <span class="n">creneau</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001A5000000512A66799E.png" style="display:inline-block; margin:4px;width:7.8cm;height:1.499cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span>
<span class="normal"><a href="#__codelineno-50-5">5</a></span>
<span class="normal"><a href="#__codelineno-50-6">6</a></span>
<span class="normal"><a href="#__codelineno-50-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="c1">-- Region Parameters</span>
<a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="w"> </span><span class="n">NVarChar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Pelissier&#39;</span>
<a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="c1">-- EndRegion</span>
<a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">HDEBUT</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MDEBUT</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">HFIN</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MFIN</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span>
<a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p>// <strong>nombre de Rdv de Mme Pélissier le 08/10/2012</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000A80000004CE8E6D420.png" style="display:inline-block; margin:4px;width:3.11cm;height:1.409cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">rv</span> <span class="ow">in</span> <span class="n">RVS</span> <span class="n">where</span> <span class="n">rv</span><span class="o">.</span><span class="n">CRENEAU</span><span class="o">.</span><span class="n">MEDECIN</span><span class="o">.</span><span class="n">NOM</span><span class="o">==</span><span class="s2">&quot;Pelissier&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">rv</span><span class="o">.</span><span class="n">JOUR</span><span class="o">==</span><span class="n">new</span> <span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">08</span><span class="p">)</span>  <span class="n">select</span> <span class="n">rv</span><span class="p">)</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span>
<span class="normal"><a href="#__codelineno-52-2">2</a></span>
<span class="normal"><a href="#__codelineno-52-3">3</a></span>
<span class="normal"><a href="#__codelineno-52-4">4</a></span>
<span class="normal"><a href="#__codelineno-52-5">5</a></span>
<span class="normal"><a href="#__codelineno-52-6">6</a></span>
<span class="normal"><a href="#__codelineno-52-7">7</a></span>
<span class="normal"><a href="#__codelineno-52-8">8</a></span>
<span class="normal"><a href="#__codelineno-52-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="c1">-- Region Parameters</span>
<a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="w"> </span><span class="n">NVarChar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Pelissier&#39;</span>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p1</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2012-10-08 00:00:00.000&#39;</span>
<a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="c1">-- EndRegion</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">RVS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">CRENEAU_ID</span><span class="p">]</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">([</span><span class="n">t2</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">([</span><span class="n">t0</span><span class="p">].[</span><span class="n">JOUR</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p><strong>// liste des clients ayant pris Rdv avec Mme Pélissier le 08/10/2012</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001640000007DDD327C16.png" style="display:inline-block; margin:4px;width:6.59cm;height:2.311cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rv</span> <span class="ow">in</span> <span class="n">RVS</span> <span class="n">where</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">JOUR</span><span class="o">==</span><span class="n">new</span> <span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rv</span><span class="o">.</span><span class="n">CRENEAU</span><span class="o">.</span><span class="n">MEDECIN</span><span class="o">.</span><span class="n">NOM</span><span class="o">==</span><span class="s2">&quot;Pelissier&quot;</span><span class="p">)</span> <span class="n">select</span> <span class="n">rv</span><span class="o">.</span><span class="n">CLIENT</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002DA0000006078010C52.png" style="display:inline-block; margin:4px;width:13.52cm;height:1.78cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="c1">-- Region Parameters</span>
<a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2012-10-08 00:00:00.000&#39;</span>
<a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">p1</span><span class="w"> </span><span class="n">NVarChar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Pelissier&#39;</span>
<a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="c1">-- EndRegion</span>
<a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">TITRE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">NOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="k">TIMESTAMP</span><span class="p">]</span>
<a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">RVS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">CRENEAU_ID</span><span class="p">]</span>
<a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">CLIENTS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t3</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">CLIENT_ID</span><span class="p">]</span>
<a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">([</span><span class="n">t0</span><span class="p">].[</span><span class="n">JOUR</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p0</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">([</span><span class="n">t2</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">p1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<p><strong>// nombre de créneaux horaires par médecin</strong></p>
<p><strong>Résultats </strong>:</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000E8000000A3C98A0ADB.png" style="display:inline-block; margin:4px;width:4.3cm;height:3.02cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>LINQ</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span>
<span class="normal"><a href="#__codelineno-55-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">creneau</span> <span class="ow">in</span> <span class="n">CRENEAUXes</span> 
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="n">group</span> <span class="n">creneau</span> <span class="n">by</span> <span class="n">creneau</span><span class="o">.</span><span class="n">MEDECIN</span> <span class="n">into</span> <span class="n">creneauxMedecin</span> 
<a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="n">select</span> <span class="n">new</span> <span class="p">{</span> <span class="n">nom</span><span class="o">=</span><span class="n">creneauxMedecin</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">NOM</span><span class="p">,</span> <span class="n">prenom</span><span class="o">=</span><span class="n">creneauxMedecin</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">PRENOM</span><span class="p">,</span> <span class="n">nbRv</span><span class="o">=</span><span class="n">creneauxMedecin</span><span class="o">.</span><span class="n">Count</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
</div></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Lambda</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000151000000E1EDC0C3ED.png" style="display:inline-block; margin:4px;width:6.241cm;height:4.17cm;" /></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>SQL</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><div markdown="block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1">1</a></span>
<span class="normal"><a href="#__codelineno-56-2">2</a></span>
<span class="normal"><a href="#__codelineno-56-3">3</a></span>
<span class="normal"><a href="#__codelineno-56-4">4</a></span>
<span class="normal"><a href="#__codelineno-56-5">5</a></span>
<span class="normal"><a href="#__codelineno-56-6">6</a></span>
<span class="normal"><a href="#__codelineno-56-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">NOM</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">nom</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">PRENOM</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">prenom</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">value</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">nbRv</span><span class="p">]</span>
<a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">CRENEAUX</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">[</span><span class="n">t0</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
<a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
<a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">[</span><span class="n">MEDECINS</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">t2</span><span class="p">].[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">t1</span><span class="p">].[</span><span class="n">MEDECIN_ID</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</div></td></tr></table>

<h3 id="355-modification-dune-entite-attachee-au-contexte-de-persistance">3.5.5. Modification d&#x27;une entité attachée au contexte de persistance</h3>
<p>Nous avons vu les opérations suivantes sur le contexte de persistance :</p>
<ul>
<li>ajouter un élément au contexte (<strong>[dbContext].[DbSet].Add</strong>) ;</li>
<li>supprimer un élément du contexte (<strong>[dbContext].[DbSet].Remove</strong>) ;</li>
<li>requêter un contexte avec des <strong>requêtes LINQ</strong>.</li>
</ul>
<p>Lorsqu&#x27;on veut synchroniser le contexte avec la base, on écrit <strong>[dbContext].SaveChanges()</strong>.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000CE00000105234A7B98.png" style="display:inline-block; margin:4px;width:3.821cm;height:4.83cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000138000000A3325211D3.png" style="display:inline-block; margin:4px;width:5.78cm;height:3.02cm;" /></td></tr></table>

<p>Le code [ModifyAttachedEntity] illustre la modification d&#x27;une entité attachée au contexte :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span>
<span class="normal"><a href="#__codelineno-57-22">22</a></span>
<span class="normal"><a href="#__codelineno-57-23">23</a></span>
<span class="normal"><a href="#__codelineno-57-24">24</a></span>
<span class="normal"><a href="#__codelineno-57-25">25</a></span>
<span class="normal"><a href="#__codelineno-57-26">26</a></span>
<span class="normal"><a href="#__codelineno-57-27">27</a></span>
<span class="normal"><a href="#__codelineno-57-28">28</a></span>
<span class="normal"><a href="#__codelineno-57-29">29</a></span>
<span class="normal"><a href="#__codelineno-57-30">30</a></span>
<span class="normal"><a href="#__codelineno-57-31">31</a></span>
<span class="normal"><a href="#__codelineno-57-32">32</a></span>
<span class="normal"><a href="#__codelineno-57-33">33</a></span>
<span class="normal"><a href="#__codelineno-57-34">34</a></span>
<span class="normal"><a href="#__codelineno-57-35">35</a></span>
<span class="normal"><a href="#__codelineno-57-36">36</a></span>
<span class="normal"><a href="#__codelineno-57-37">37</a></span>
<span class="normal"><a href="#__codelineno-57-38">38</a></span>
<span class="normal"><a href="#__codelineno-57-39">39</a></span>
<span class="normal"><a href="#__codelineno-57-40">40</a></span>
<span class="normal"><a href="#__codelineno-57-41">41</a></span>
<span class="normal"><a href="#__codelineno-57-42">42</a></span>
<span class="normal"><a href="#__codelineno-57-43">43</a></span>
<span class="normal"><a href="#__codelineno-57-44">44</a></span>
<span class="normal"><a href="#__codelineno-57-45">45</a></span>
<span class="normal"><a href="#__codelineno-57-46">46</a></span>
<span class="normal"><a href="#__codelineno-57-47">47</a></span>
<span class="normal"><a href="#__codelineno-57-48">48</a></span>
<span class="normal"><a href="#__codelineno-57-49">49</a></span>
<span class="normal"><a href="#__codelineno-57-50">50</a></span>
<span class="normal"><a href="#__codelineno-57-51">51</a></span>
<span class="normal"><a href="#__codelineno-57-52">52</a></span>
<span class="normal"><a href="#__codelineno-57-53">53</a></span>
<span class="normal"><a href="#__codelineno-57-54">54</a></span>
<span class="normal"><a href="#__codelineno-57-55">55</a></span>
<span class="normal"><a href="#__codelineno-57-56">56</a></span>
<span class="normal"><a href="#__codelineno-57-57">57</a></span>
<span class="normal"><a href="#__codelineno-57-58">58</a></span>
<span class="normal"><a href="#__codelineno-57-59">59</a></span>
<span class="normal"><a href="#__codelineno-57-60">60</a></span>
<span class="normal"><a href="#__codelineno-57-61">61</a></span>
<span class="normal"><a href="#__codelineno-57-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data</span><span class="p">;</span>
<a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-57-6" name="__codelineno-57-6"></a>
<a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="p">{</span>
<a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">ModifyAttachedEntity</span>
<a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="w">      </span><span class="n">Client</span><span class="w"> </span><span class="n">client1</span><span class="p">,</span><span class="w"> </span><span class="n">client2</span><span class="p">,</span><span class="w"> </span><span class="n">client3</span><span class="p">;</span>
<a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="w">      </span><span class="c1">// 1er contexte</span>
<a id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-57-16" name="__codelineno-57-16"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-57-19" name="__codelineno-57-19"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-57-20" name="__codelineno-57-20"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-57-21" name="__codelineno-57-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-57-22" name="__codelineno-57-22"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-57-23" name="__codelineno-57-23"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-57-24" name="__codelineno-57-24"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-57-25" name="__codelineno-57-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-57-26" name="__codelineno-57-26"></a><span class="w">        </span><span class="c1">// on ajoute un client</span>
<a id="__codelineno-57-27" name="__codelineno-57-27"></a><span class="w">        </span><span class="n">client1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-57-28" name="__codelineno-57-28"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-57-29" name="__codelineno-57-29"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-57-30" name="__codelineno-57-30"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;client1--avant&quot;</span><span class="p">);</span>
<a id="__codelineno-57-31" name="__codelineno-57-31"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-57-32" name="__codelineno-57-32"></a><span class="w">        </span><span class="c1">// sauvegarde contexte</span>
<a id="__codelineno-57-33" name="__codelineno-57-33"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-57-34" name="__codelineno-57-34"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-57-35" name="__codelineno-57-35"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;client1--après&quot;</span><span class="p">);</span>
<a id="__codelineno-57-36" name="__codelineno-57-36"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-57-37" name="__codelineno-57-37"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-57-38" name="__codelineno-57-38"></a><span class="w">      </span><span class="c1">// 2ième contexte</span>
<a id="__codelineno-57-39" name="__codelineno-57-39"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-57-40" name="__codelineno-57-40"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-57-41" name="__codelineno-57-41"></a><span class="w">        </span><span class="c1">// on récupère client1 dans client2</span>
<a id="__codelineno-57-42" name="__codelineno-57-42"></a><span class="w">        </span><span class="n">client2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">client1</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-57-43" name="__codelineno-57-43"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-57-44" name="__codelineno-57-44"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;client2&quot;</span><span class="p">);</span>
<a id="__codelineno-57-45" name="__codelineno-57-45"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client2</span><span class="p">);</span>
<a id="__codelineno-57-46" name="__codelineno-57-46"></a><span class="w">        </span><span class="c1">// on modifie client2</span>
<a id="__codelineno-57-47" name="__codelineno-57-47"></a><span class="w">        </span><span class="n">client2</span><span class="p">.</span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;yy&quot;</span><span class="p">;</span>
<a id="__codelineno-57-48" name="__codelineno-57-48"></a><span class="w">        </span><span class="c1">// sauvegarde contexte</span>
<a id="__codelineno-57-49" name="__codelineno-57-49"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-57-50" name="__codelineno-57-50"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-57-51" name="__codelineno-57-51"></a><span class="w">      </span><span class="c1">// 3ième contexte</span>
<a id="__codelineno-57-52" name="__codelineno-57-52"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-57-53" name="__codelineno-57-53"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-57-54" name="__codelineno-57-54"></a><span class="w">        </span><span class="c1">// on récupère client2 dans client3</span>
<a id="__codelineno-57-55" name="__codelineno-57-55"></a><span class="w">        </span><span class="n">client3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">client2</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-57-56" name="__codelineno-57-56"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-57-57" name="__codelineno-57-57"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;client3&quot;</span><span class="p">);</span>
<a id="__codelineno-57-58" name="__codelineno-57-58"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client3</span><span class="p">);</span>
<a id="__codelineno-57-59" name="__codelineno-57-59"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-57-60" name="__codelineno-57-60"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-61" name="__codelineno-57-61"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-57-62" name="__codelineno-57-62"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 15 : ouverture contexte de l&#x27;application ;</li>
<li>lignes 18-25 : le contexte est vidé. Très exactement, toutes les entités sont amenées dans le contexte à partir de la base de données puis passent dans un état &quot; supprimé &quot;. On notera qu&#x27;à ce stade la base n&#x27;a pas bougé. Tant que le contexte n&#x27;est pas synchronisé avec la base, celle-ci ne change pas. On se rappelle que supprimer les entités [Medecin] et [Client] suffit à vider la base par le jeu des suppressions en cascade ;</li>
<li>lignes 27-28 : un nouveau client est ajouté à la base ;</li>
<li>lignes 30-31 : on l&#x27;affiche avant sa sauvegarde dans la base ;</li>
<li>ligne 33 : on synchronise le contexte avec la base. Les entitées marquées dans un état &quot; supprimé &quot; vont faire l&#x27;objet d&#x27;une opération SQL DELETE, l&#x27;entité ajoutée d&#x27;une opération SQL INSERT ;</li>
<li>lignes 35-36 : on affiche le client après la synchronisation avec la base ;</li>
</ul>
<p>Le résultat obtenu à la console est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1">1</a></span>
<span class="normal"><a href="#__codelineno-58-2">2</a></span>
<span class="normal"><a href="#__codelineno-58-3">3</a></span>
<span class="normal"><a href="#__codelineno-58-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a>client1--avant
<a id="__codelineno-58-2" name="__codelineno-58-2"></a>Client[,xx,xx,xx,]
<a id="__codelineno-58-3" name="__codelineno-58-3"></a>client1--après
<a id="__codelineno-58-4" name="__codelineno-58-4"></a>Client[16,xx,xx,xx,000000132209]
</code></pre></div></td></tr></table></div>
<p>On notera les points suivants :</p>
<ul>
<li>avant la synchronisation avec la base, le client n&#x27;a ni clé primaire, ni <em>timestamp,</em></li>
<li>après la synchronisation, il les a. On rappelle ici, que la clé primaire a été configurée pour être générée par SQL Server. De même ce SGBD génère automatiquement le <em>timestamp ;</em></li>
<li>ligne 37 : le contexte de persistance est fermé. Les entités qu&#x27;il contenait deviennent &quot;<strong> détachées </strong>&quot;. Elles existent en tant qu&#x27;objets mais pas en tant qu&#x27;entités attachées à un contexte de persistance ;</li>
<li>ligne 39 : on redémarre un nouveau contexte vide ;</li>
<li>ligne 42 : on récupère le client directement dans la base via sa clé primaire. Il est alors amené dans le contexte. S&#x27;il n&#x27;est pas trouvé, la méthode <strong>Find</strong> rend le pointeur <em>null</em> ;</li>
<li>lignes 48-49 : on l&#x27;affiche ;</li>
</ul>
<p>Cela donne le résultat suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1">1</a></span>
<span class="normal"><a href="#__codelineno-59-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a>client2
<a id="__codelineno-59-2" name="__codelineno-59-2"></a>Client[16,xx,xx,xx,000000132209]
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 47 : on le modifie ;</li>
<li>ligne 49 : on synchronise le contexte avec la base. EF va détecter que certains éléments du contexte ont été modifiés depuis qu&#x27;ils y ont été amenés. Pour ces éléments, il va générer des ordres SQL UPDATE sur la base. Donc ici, la synchronisation va consister en un unique ordre UPDATE ;</li>
<li>ligne 50 : le deuxième contexte est fermé. L&#x27;entité <em>client2</em> qui était attachée au contexte devient maintenant détachée de celui-ci ;</li>
<li>ligne 52 : on ouvre un troisième contexte vide ;</li>
<li>ligne 55 : on y amène de nouveau l&#x27;unique client de la base. On veut voir si la modification faite sur lui dans le contexte précédent a été répercutée dans la base ;</li>
<li>lignes 57-58 : on affiche le client. Cela donne le résultat suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span>
<span class="normal"><a href="#__codelineno-60-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a>client3
<a id="__codelineno-60-2" name="__codelineno-60-2"></a>Client[16,xx,xx,yy,000000132210]
</code></pre></div></td></tr></table></div>
<p>Le nom du client a bien été modifié en base. On notera avec intérêt que son <em>timestamp</em> a été mis à jour.</p>
<ul>
<li>ligne 59 : on ferme le contexte. Au passage, on notera que contrairement aux deux fois précédentes, on n&#x27;a pas eu besoin auparavant de synchroniser le contexte avec la base (SaveChanges) car le contexte n&#x27;avait pas été modifié.</li>
</ul>
<h3 id="356-gestion-des-entites-detachees">3.5.6. Gestion des entités détachées</h3>
<p>Revenons à l&#x27;architecture en couches d&#x27;une application telle que celle de l&#x27;étude de cas :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005E80000012394CCF3E6.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.464cm;" /></td></tr></table>

<p>La couche [DAO] utilise l&#x27;ORM EF5 pour accéder aux données. Nous avons les briques de base de cette couche. Chaque méthode ouvrira un contexte de persistance, fera dessus les opérations nécessaires (insertion, modification, suppression, requêtage) puis le fermera. Les entités gérées par la couche [DAO] vont remonter jusqu&#x27;à la couche web ASP.NET. Dans cette couche, elles sont hors contexte de persistance donc détachées. Dans la couche web, un utilisateur peut modifier ces entités (ajout, modification, suppression). Lorsqu&#x27;elles reviennent à la couche [DAO], elles sont toujours détachées. Or la couche [DAO] va devoir répercuter les modifications faites par l&#x27;utilisateur dans la base. Il va donc devoir travailler avec des entités détachées. Voyons les trois cas possibles :</p>
<p><strong>Ajouter une entité détachée</strong></p>
<p>C&#x27;est le cas normal pour un ajout. Il suffit d&#x27;ajouter (Add) l&#x27;entité détachée au contexte en s&#x27;assurant qu&#x27;elle a une clé primaire égale à <em>null</em>.</p>
<p><strong>Modifier une entité détachée</strong></p>
<p>On peut utiliser le code suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="na">[DbContext]</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">entité</span><span class="o">-</span><span class="n">détachée</span><span class="p">).</span><span class="n">State</span><span class="o">=</span><span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="w"> </span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>la méthode [DbContext].Entry(entité-détachée) va mettre l&#x27;entité dans le contexte ;</li>
<li>l&#x27;état de cette entité est mis à &quot; modifié &quot; afin qu&#x27;elle fasse l&#x27;objet d&#x27;un ordre SQL UPDATE.</li>
</ul>
<p><strong>Supprimer une entité détachée</strong></p>
<p>On peut utiliser le code suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span>
<span class="normal"><a href="#__codelineno-62-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="n">Entity</span><span class="w"> </span><span class="n">e</span><span class="o">=</span><span class="p">[</span><span class="n">DbContext</span><span class="p">].[</span><span class="n">DbSet</span><span class="p">].</span><span class="n">Find</span><span class="p">(</span><span class="n">clé</span><span class="w"> </span><span class="n">primaire</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">&#39;</span><span class="n">entité</span><span class="w"> </span><span class="n">détachée</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="na">[DbContext]</span><span class="p">.[</span><span class="n">DbSet</span><span class="p">].</span><span class="n">Remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne  1 : on met dans le contexte l&#x27;entité de même clé primaire que l&#x27;entité détachée ;</li>
<li>ligne 2 : on la supprime :</li>
</ul>
<p>On notera que cela nécessite en base un SELECT suivi d&#x27;un DELETE alors que normalement le seul DELETE est suffisant. On peut suivre également l&#x27;exemple de la modification d&#x27;une entité détachée et écrire :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="na">[DbContext]</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">entité</span><span class="o">-</span><span class="n">détachée</span><span class="p">).</span><span class="n">State</span><span class="o">=</span><span class="n">EntityState</span><span class="p">.</span><span class="n">Deleted</span><span class="w"> </span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>Comme je n&#x27;ai pas pu mettre en oeuvre de logs sur les opérations SQL faites sur la base, je ne sais pas si une méthode est à conseiller plutôt que l&#x27;autre.</p>
<p>Voici un exemple :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000D70000011967240B71.png" style="display:inline-block; margin:4px;width:3.979cm;height:5.2cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001390000009F9C3CAA2E.png" style="display:inline-block; margin:4px;width:5.78cm;height:2.94cm;" /></td></tr></table>

<p>Le code du programme [ModifyDetachedEntities] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-64-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-64-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-64-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-64-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-64-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-64-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-64-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-64-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-64-10">10</a></span>
<span class="normal"><a href="#__codelineno-64-11">11</a></span>
<span class="normal"><a href="#__codelineno-64-12">12</a></span>
<span class="normal"><a href="#__codelineno-64-13">13</a></span>
<span class="normal"><a href="#__codelineno-64-14">14</a></span>
<span class="normal"><a href="#__codelineno-64-15">15</a></span>
<span class="normal"><a href="#__codelineno-64-16">16</a></span>
<span class="normal"><a href="#__codelineno-64-17">17</a></span>
<span class="normal"><a href="#__codelineno-64-18">18</a></span>
<span class="normal"><a href="#__codelineno-64-19">19</a></span>
<span class="normal"><a href="#__codelineno-64-20">20</a></span>
<span class="normal"><a href="#__codelineno-64-21">21</a></span>
<span class="normal"><a href="#__codelineno-64-22">22</a></span>
<span class="normal"><a href="#__codelineno-64-23">23</a></span>
<span class="normal"><a href="#__codelineno-64-24">24</a></span>
<span class="normal"><a href="#__codelineno-64-25">25</a></span>
<span class="normal"><a href="#__codelineno-64-26">26</a></span>
<span class="normal"><a href="#__codelineno-64-27">27</a></span>
<span class="normal"><a href="#__codelineno-64-28">28</a></span>
<span class="normal"><a href="#__codelineno-64-29">29</a></span>
<span class="normal"><a href="#__codelineno-64-30">30</a></span>
<span class="normal"><a href="#__codelineno-64-31">31</a></span>
<span class="normal"><a href="#__codelineno-64-32">32</a></span>
<span class="normal"><a href="#__codelineno-64-33">33</a></span>
<span class="normal"><a href="#__codelineno-64-34">34</a></span>
<span class="normal"><a href="#__codelineno-64-35">35</a></span>
<span class="normal"><a href="#__codelineno-64-36">36</a></span>
<span class="normal"><a href="#__codelineno-64-37">37</a></span>
<span class="normal"><a href="#__codelineno-64-38">38</a></span>
<span class="normal"><a href="#__codelineno-64-39">39</a></span>
<span class="normal"><a href="#__codelineno-64-40">40</a></span>
<span class="normal"><a href="#__codelineno-64-41">41</a></span>
<span class="normal"><a href="#__codelineno-64-42">42</a></span>
<span class="normal"><a href="#__codelineno-64-43">43</a></span>
<span class="normal"><a href="#__codelineno-64-44">44</a></span>
<span class="normal"><a href="#__codelineno-64-45">45</a></span>
<span class="normal"><a href="#__codelineno-64-46">46</a></span>
<span class="normal"><a href="#__codelineno-64-47">47</a></span>
<span class="normal"><a href="#__codelineno-64-48">48</a></span>
<span class="normal"><a href="#__codelineno-64-49">49</a></span>
<span class="normal"><a href="#__codelineno-64-50">50</a></span>
<span class="normal"><a href="#__codelineno-64-51">51</a></span>
<span class="normal"><a href="#__codelineno-64-52">52</a></span>
<span class="normal"><a href="#__codelineno-64-53">53</a></span>
<span class="normal"><a href="#__codelineno-64-54">54</a></span>
<span class="normal"><a href="#__codelineno-64-55">55</a></span>
<span class="normal"><a href="#__codelineno-64-56">56</a></span>
<span class="normal"><a href="#__codelineno-64-57">57</a></span>
<span class="normal"><a href="#__codelineno-64-58">58</a></span>
<span class="normal"><a href="#__codelineno-64-59">59</a></span>
<span class="normal"><a href="#__codelineno-64-60">60</a></span>
<span class="normal"><a href="#__codelineno-64-61">61</a></span>
<span class="normal"><a href="#__codelineno-64-62">62</a></span>
<span class="normal"><a href="#__codelineno-64-63">63</a></span>
<span class="normal"><a href="#__codelineno-64-64">64</a></span>
<span class="normal"><a href="#__codelineno-64-65">65</a></span>
<span class="normal"><a href="#__codelineno-64-66">66</a></span>
<span class="normal"><a href="#__codelineno-64-67">67</a></span>
<span class="normal"><a href="#__codelineno-64-68">68</a></span>
<span class="normal"><a href="#__codelineno-64-69">69</a></span>
<span class="normal"><a href="#__codelineno-64-70">70</a></span>
<span class="normal"><a href="#__codelineno-64-71">71</a></span>
<span class="normal"><a href="#__codelineno-64-72">72</a></span>
<span class="normal"><a href="#__codelineno-64-73">73</a></span>
<span class="normal"><a href="#__codelineno-64-74">74</a></span>
<span class="normal"><a href="#__codelineno-64-75">75</a></span>
<span class="normal"><a href="#__codelineno-64-76">76</a></span>
<span class="normal"><a href="#__codelineno-64-77">77</a></span>
<span class="normal"><a href="#__codelineno-64-78">78</a></span>
<span class="normal"><a href="#__codelineno-64-79">79</a></span>
<span class="normal"><a href="#__codelineno-64-80">80</a></span>
<span class="normal"><a href="#__codelineno-64-81">81</a></span>
<span class="normal"><a href="#__codelineno-64-82">82</a></span>
<span class="normal"><a href="#__codelineno-64-83">83</a></span>
<span class="normal"><a href="#__codelineno-64-84">84</a></span>
<span class="normal"><a href="#__codelineno-64-85">85</a></span>
<span class="normal"><a href="#__codelineno-64-86">86</a></span>
<span class="normal"><a href="#__codelineno-64-87">87</a></span>
<span class="normal"><a href="#__codelineno-64-88">88</a></span>
<span class="normal"><a href="#__codelineno-64-89">89</a></span>
<span class="normal"><a href="#__codelineno-64-90">90</a></span>
<span class="normal"><a href="#__codelineno-64-91">91</a></span>
<span class="normal"><a href="#__codelineno-64-92">92</a></span>
<span class="normal"><a href="#__codelineno-64-93">93</a></span>
<span class="normal"><a href="#__codelineno-64-94">94</a></span>
<span class="normal"><a href="#__codelineno-64-95">95</a></span>
<span class="normal"><a href="#__codelineno-64-96">96</a></span>
<span class="normal"><a href="#__codelineno-64-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data</span><span class="p">;</span>
<a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-64-5" name="__codelineno-64-5"></a>
<a id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="p">{</span>
<a id="__codelineno-64-8" name="__codelineno-64-8"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">ModifyDetachedEntities</span>
<a id="__codelineno-64-9" name="__codelineno-64-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-64-10" name="__codelineno-64-10"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-64-11" name="__codelineno-64-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-64-12" name="__codelineno-64-12"></a><span class="w">      </span><span class="n">Client</span><span class="w"> </span><span class="n">client1</span><span class="p">;</span>
<a id="__codelineno-64-13" name="__codelineno-64-13"></a>
<a id="__codelineno-64-14" name="__codelineno-64-14"></a><span class="w">      </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-64-15" name="__codelineno-64-15"></a><span class="w">      </span><span class="n">Erase</span><span class="p">();</span>
<a id="__codelineno-64-16" name="__codelineno-64-16"></a><span class="w">      </span><span class="c1">// on ajoute un client</span>
<a id="__codelineno-64-17" name="__codelineno-64-17"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-64-18" name="__codelineno-64-18"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-19" name="__codelineno-64-19"></a><span class="w">        </span><span class="c1">// création client</span>
<a id="__codelineno-64-20" name="__codelineno-64-20"></a><span class="w">        </span><span class="n">client1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-64-21" name="__codelineno-64-21"></a><span class="w">        </span><span class="c1">// ajout du client au contexte</span>
<a id="__codelineno-64-22" name="__codelineno-64-22"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-64-23" name="__codelineno-64-23"></a><span class="w">        </span><span class="c1">// on sauvegarde le contexte</span>
<a id="__codelineno-64-24" name="__codelineno-64-24"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-64-25" name="__codelineno-64-25"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-26" name="__codelineno-64-26"></a><span class="w">      </span><span class="c1">// affichage base</span>
<a id="__codelineno-64-27" name="__codelineno-64-27"></a><span class="w">      </span><span class="n">Dump</span><span class="p">(</span><span class="s">&quot;1-----------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-64-28" name="__codelineno-64-28"></a><span class="w">      </span><span class="c1">// client1 n&#39;est pas dans le contexte - on le modifie</span>
<a id="__codelineno-64-29" name="__codelineno-64-29"></a><span class="w">      </span><span class="n">client1</span><span class="p">.</span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">;</span>
<a id="__codelineno-64-30" name="__codelineno-64-30"></a><span class="w">      </span><span class="c1">// nouveau contexte</span>
<a id="__codelineno-64-31" name="__codelineno-64-31"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-64-32" name="__codelineno-64-32"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-33" name="__codelineno-64-33"></a><span class="w">        </span><span class="c1">// ici, on a un contexte vide</span>
<a id="__codelineno-64-34" name="__codelineno-64-34"></a><span class="w">        </span><span class="c1">// on met client1 dans le contexte dans un état modifié</span>
<a id="__codelineno-64-35" name="__codelineno-64-35"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">client1</span><span class="p">).</span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="p">;</span>
<a id="__codelineno-64-36" name="__codelineno-64-36"></a><span class="w">        </span><span class="c1">// on sauvegarde le contexte</span>
<a id="__codelineno-64-37" name="__codelineno-64-37"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-64-38" name="__codelineno-64-38"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-39" name="__codelineno-64-39"></a><span class="w">      </span><span class="c1">// affichage base</span>
<a id="__codelineno-64-40" name="__codelineno-64-40"></a><span class="w">      </span><span class="n">Dump</span><span class="p">(</span><span class="s">&quot;2-----------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-64-41" name="__codelineno-64-41"></a><span class="w">      </span><span class="c1">// suppression entité hors contexte</span>
<a id="__codelineno-64-42" name="__codelineno-64-42"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-64-43" name="__codelineno-64-43"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-44" name="__codelineno-64-44"></a><span class="w">        </span><span class="c1">// ici, on a un nouveau contexte vide</span>
<a id="__codelineno-64-45" name="__codelineno-64-45"></a><span class="w">        </span><span class="c1">// on met client1 dans le contexte dans un état supprimé</span>
<a id="__codelineno-64-46" name="__codelineno-64-46"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">client1</span><span class="p">).</span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EntityState</span><span class="p">.</span><span class="n">Deleted</span><span class="p">;</span>
<a id="__codelineno-64-47" name="__codelineno-64-47"></a><span class="w">        </span><span class="c1">// on sauvegarde le contexte</span>
<a id="__codelineno-64-48" name="__codelineno-64-48"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-64-49" name="__codelineno-64-49"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-50" name="__codelineno-64-50"></a><span class="w">      </span><span class="c1">// affichage base</span>
<a id="__codelineno-64-51" name="__codelineno-64-51"></a><span class="w">      </span><span class="n">Dump</span><span class="p">(</span><span class="s">&quot;3-----------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-64-52" name="__codelineno-64-52"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-53" name="__codelineno-64-53"></a>
<a id="__codelineno-64-54" name="__codelineno-64-54"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Erase</span><span class="p">()</span>
<a id="__codelineno-64-55" name="__codelineno-64-55"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-64-56" name="__codelineno-64-56"></a><span class="w">      </span><span class="c1">// vide la base</span>
<a id="__codelineno-64-57" name="__codelineno-64-57"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-64-58" name="__codelineno-64-58"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-59" name="__codelineno-64-59"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-64-60" name="__codelineno-64-60"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-61" name="__codelineno-64-61"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-64-62" name="__codelineno-64-62"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-63" name="__codelineno-64-63"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-64-64" name="__codelineno-64-64"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-65" name="__codelineno-64-65"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-64-66" name="__codelineno-64-66"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-67" name="__codelineno-64-67"></a><span class="w">        </span><span class="c1">// on sauvegarde le contexte</span>
<a id="__codelineno-64-68" name="__codelineno-64-68"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-64-69" name="__codelineno-64-69"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-70" name="__codelineno-64-70"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-71" name="__codelineno-64-71"></a>
<a id="__codelineno-64-72" name="__codelineno-64-72"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Dump</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<a id="__codelineno-64-73" name="__codelineno-64-73"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-64-74" name="__codelineno-64-74"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<a id="__codelineno-64-75" name="__codelineno-64-75"></a><span class="w">      </span><span class="c1">// affiche la base</span>
<a id="__codelineno-64-76" name="__codelineno-64-76"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-64-77" name="__codelineno-64-77"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-78" name="__codelineno-64-78"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">)</span>
<a id="__codelineno-64-79" name="__codelineno-64-79"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-80" name="__codelineno-64-80"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
<a id="__codelineno-64-81" name="__codelineno-64-81"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-82" name="__codelineno-64-82"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">)</span>
<a id="__codelineno-64-83" name="__codelineno-64-83"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-84" name="__codelineno-64-84"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">creneau</span><span class="p">);</span>
<a id="__codelineno-64-85" name="__codelineno-64-85"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-86" name="__codelineno-64-86"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-64-87" name="__codelineno-64-87"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-88" name="__codelineno-64-88"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-64-89" name="__codelineno-64-89"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-90" name="__codelineno-64-90"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-64-91" name="__codelineno-64-91"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-64-92" name="__codelineno-64-92"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-64-93" name="__codelineno-64-93"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-64-94" name="__codelineno-64-94"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-95" name="__codelineno-64-95"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-96" name="__codelineno-64-96"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-64-97" name="__codelineno-64-97"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 15 : la base est effacée ;</li>
<li>lignes 17-25 : un client est ajouté en base ;</li>
<li>ligne 27 : affiche le contenu de la base ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1">1</a></span>
<span class="normal"><a href="#__codelineno-65-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a>1-----------------------------
<a id="__codelineno-65-2" name="__codelineno-65-2"></a>Client[20,x,x,x,0000011209]
</code></pre></div></td></tr></table></div>
<ul>
<li>après la ligne 25, le contexte de persistance n&#x27;existe plus. Il n&#x27;y a donc plus d&#x27;entités attachées. L&#x27;entité <em>client1</em> est passée dans l&#x27;état &quot;<strong> détaché </strong>&quot; ;</li>
<li>ligne 29 : on modifie le nom de l&#x27;entité détachée ;</li>
<li>ligne 31 : on ouvre un nouveau contexte vide ;</li>
<li>ligne 35 : l&#x27;entité détachée <em>client1</em> est mise dans le contexte dans un état &quot;<strong> modifié </strong>&quot; ;</li>
<li>ligne 37 : le contexte est synchronisé avec la base ;</li>
<li>ligne 38 : il est fermé ;</li>
<li>ligne 40 : la base est affichée ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1">1</a></span>
<span class="normal"><a href="#__codelineno-66-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a>2-----------------------------
<a id="__codelineno-66-2" name="__codelineno-66-2"></a>Client[20,x,x,y,0000011210]
</code></pre></div></td></tr></table></div>
<p>Le nom du client a bien été modifié en base. On notera que le <em>timestamp</em> a été mis à jour ;</p>
<ul>
<li>ligne 42 : ouverture d&#x27;un nouveau contexte vide ;</li>
<li>ligne 46 : l&#x27;entité détachée <em>client1</em> est mise dans le contexte dans un état &quot;<strong>supprimé</strong>&quot; ;</li>
<li>ligne 48 : le contexte est synchronisé avec la base ;</li>
<li>ligne 49 : il est fermé ;</li>
<li>ligne 51 : la base est affichée ;</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a>3-----------------------------
</code></pre></div></td></tr></table></div>
<p>L&#x27;entité a bien été supprimée en base.</p>
<p>Maintenant, nous voyons les deux modes de chargement des dépendances d&#x27;une entité : <strong>Lazy et Eager Loading</strong>.</p>
<h3 id="357-lazy-et-eager-loading">3.5.7. Lazy et Eager Loading</h3>
<p>Reprenons le schéma des dépendances plusieurs à un de nos quatre entités :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000037F0000014C1EAFB962.png" style="display:inline-block; margin:4px;width:11.841cm;height:4.392cm;" /></td></tr></table>

<p>Ci-dessus, l&#x27;entité [Creneau] a une propriété navigationnelle [Creneau.Medecin] vers l&#x27;entité [Medecin]. On appelle cela une dépendance. Nous avons vu qu&#x27;il y avait également des dépendances <em>un à plusieurs</em>. Le principe qui va être expliqué s&#x27;applique également à elles.</p>
<p>Par défaut, EF 5 est en mode <strong>Lazy Loading</strong> : lorsqu&#x27;il amène une entité dans le contexte de persistance depuis la base, il n&#x27;amène pas ses dépendances. Celles-ci seront amenées lorsqu&#x27;elles seront utilisées la première fois. C&#x27;est une mesure de bon sens. Si ce n&#x27;était pas le cas, amener dans le contexte les rendez-vous amènerait d&#x27;après les dépendances ci-dessus :</p>
<ul>
<li>les entités [Creneau] liées aux rendez-vous ;</li>
<li>les entités [Medecin] liées à ces créneaux ;</li>
<li>les entités [Clients] liées aux rendez-vous.</li>
</ul>
<p>Parfois cependant, on a besoin d&#x27;une entité et de ses dépendances. Nous allons illustrer les deux modes de chargement.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000D200000126F8BB805A.png" style="display:inline-block; margin:4px;width:3.889cm;height:5.45cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000138000000A4FC1D30EC.png" style="display:inline-block; margin:4px;width:5.78cm;height:3.039cm;" /></td></tr></table>

<p>Le code de [LazyEagerLoading] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span>
<span class="normal"><a href="#__codelineno-68-12">12</a></span>
<span class="normal"><a href="#__codelineno-68-13">13</a></span>
<span class="normal"><a href="#__codelineno-68-14">14</a></span>
<span class="normal"><a href="#__codelineno-68-15">15</a></span>
<span class="normal"><a href="#__codelineno-68-16">16</a></span>
<span class="normal"><a href="#__codelineno-68-17">17</a></span>
<span class="normal"><a href="#__codelineno-68-18">18</a></span>
<span class="normal"><a href="#__codelineno-68-19">19</a></span>
<span class="normal"><a href="#__codelineno-68-20">20</a></span>
<span class="normal"><a href="#__codelineno-68-21">21</a></span>
<span class="normal"><a href="#__codelineno-68-22">22</a></span>
<span class="normal"><a href="#__codelineno-68-23">23</a></span>
<span class="normal"><a href="#__codelineno-68-24">24</a></span>
<span class="normal"><a href="#__codelineno-68-25">25</a></span>
<span class="normal"><a href="#__codelineno-68-26">26</a></span>
<span class="normal"><a href="#__codelineno-68-27">27</a></span>
<span class="normal"><a href="#__codelineno-68-28">28</a></span>
<span class="normal"><a href="#__codelineno-68-29">29</a></span>
<span class="normal"><a href="#__codelineno-68-30">30</a></span>
<span class="normal"><a href="#__codelineno-68-31">31</a></span>
<span class="normal"><a href="#__codelineno-68-32">32</a></span>
<span class="normal"><a href="#__codelineno-68-33">33</a></span>
<span class="normal"><a href="#__codelineno-68-34">34</a></span>
<span class="normal"><a href="#__codelineno-68-35">35</a></span>
<span class="normal"><a href="#__codelineno-68-36">36</a></span>
<span class="normal"><a href="#__codelineno-68-37">37</a></span>
<span class="normal"><a href="#__codelineno-68-38">38</a></span>
<span class="normal"><a href="#__codelineno-68-39">39</a></span>
<span class="normal"><a href="#__codelineno-68-40">40</a></span>
<span class="normal"><a href="#__codelineno-68-41">41</a></span>
<span class="normal"><a href="#__codelineno-68-42">42</a></span>
<span class="normal"><a href="#__codelineno-68-43">43</a></span>
<span class="normal"><a href="#__codelineno-68-44">44</a></span>
<span class="normal"><a href="#__codelineno-68-45">45</a></span>
<span class="normal"><a href="#__codelineno-68-46">46</a></span>
<span class="normal"><a href="#__codelineno-68-47">47</a></span>
<span class="normal"><a href="#__codelineno-68-48">48</a></span>
<span class="normal"><a href="#__codelineno-68-49">49</a></span>
<span class="normal"><a href="#__codelineno-68-50">50</a></span>
<span class="normal"><a href="#__codelineno-68-51">51</a></span>
<span class="normal"><a href="#__codelineno-68-52">52</a></span>
<span class="normal"><a href="#__codelineno-68-53">53</a></span>
<span class="normal"><a href="#__codelineno-68-54">54</a></span>
<span class="normal"><a href="#__codelineno-68-55">55</a></span>
<span class="normal"><a href="#__codelineno-68-56">56</a></span>
<span class="normal"><a href="#__codelineno-68-57">57</a></span>
<span class="normal"><a href="#__codelineno-68-58">58</a></span>
<span class="normal"><a href="#__codelineno-68-59">59</a></span>
<span class="normal"><a href="#__codelineno-68-60">60</a></span>
<span class="normal"><a href="#__codelineno-68-61">61</a></span>
<span class="normal"><a href="#__codelineno-68-62">62</a></span>
<span class="normal"><a href="#__codelineno-68-63">63</a></span>
<span class="normal"><a href="#__codelineno-68-64">64</a></span>
<span class="normal"><a href="#__codelineno-68-65">65</a></span>
<span class="normal"><a href="#__codelineno-68-66">66</a></span>
<span class="normal"><a href="#__codelineno-68-67">67</a></span>
<span class="normal"><a href="#__codelineno-68-68">68</a></span>
<span class="normal"><a href="#__codelineno-68-69">69</a></span>
<span class="normal"><a href="#__codelineno-68-70">70</a></span>
<span class="normal"><a href="#__codelineno-68-71">71</a></span>
<span class="normal"><a href="#__codelineno-68-72">72</a></span>
<span class="normal"><a href="#__codelineno-68-73">73</a></span>
<span class="normal"><a href="#__codelineno-68-74">74</a></span>
<span class="normal"><a href="#__codelineno-68-75">75</a></span>
<span class="normal"><a href="#__codelineno-68-76">76</a></span>
<span class="normal"><a href="#__codelineno-68-77">77</a></span>
<span class="normal"><a href="#__codelineno-68-78">78</a></span>
<span class="normal"><a href="#__codelineno-68-79">79</a></span>
<span class="normal"><a href="#__codelineno-68-80">80</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-68-5" name="__codelineno-68-5"></a>
<a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="p">{</span>
<a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">LazyEagerLoading</span>
<a id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="w">    </span><span class="c1">// les entités</span>
<a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Medecin</span><span class="p">[]</span><span class="w"> </span><span class="n">medecins</span><span class="p">;</span>
<a id="__codelineno-68-12" name="__codelineno-68-12"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Client</span><span class="p">[]</span><span class="w"> </span><span class="n">clients</span><span class="p">;</span>
<a id="__codelineno-68-13" name="__codelineno-68-13"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Creneau</span><span class="p">[]</span><span class="w"> </span><span class="n">creneaux</span><span class="p">;</span>
<a id="__codelineno-68-14" name="__codelineno-68-14"></a>
<a id="__codelineno-68-15" name="__codelineno-68-15"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-68-16" name="__codelineno-68-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-68-17" name="__codelineno-68-17"></a><span class="w">      </span><span class="c1">// on initialise la base      </span>
<a id="__codelineno-68-18" name="__codelineno-68-18"></a><span class="w">      </span><span class="n">InitBase</span><span class="p">();</span>
<a id="__codelineno-68-19" name="__codelineno-68-19"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Initialisation terminée&quot;</span><span class="p">);</span>
<a id="__codelineno-68-20" name="__codelineno-68-20"></a><span class="w">      </span><span class="c1">// eager loading</span>
<a id="__codelineno-68-21" name="__codelineno-68-21"></a><span class="w">      </span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="p">;</span>
<a id="__codelineno-68-22" name="__codelineno-68-22"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">idCreneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">;</span>
<a id="__codelineno-68-23" name="__codelineno-68-23"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-68-24" name="__codelineno-68-24"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-25" name="__codelineno-68-25"></a><span class="w">        </span><span class="c1">// creneau n° 0</span>
<a id="__codelineno-68-26" name="__codelineno-68-26"></a><span class="w">        </span><span class="n">creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="s">&quot;Medecin&quot;</span><span class="p">).</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">);</span>
<a id="__codelineno-68-27" name="__codelineno-68-27"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">creneau</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-68-28" name="__codelineno-68-28"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-29" name="__codelineno-68-29"></a><span class="w">      </span><span class="c1">// affichage dépendance</span>
<a id="__codelineno-68-30" name="__codelineno-68-30"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-68-31" name="__codelineno-68-31"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-32" name="__codelineno-68-32"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Médecin={0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">creneau</span><span class="p">.</span><span class="n">Medecin</span><span class="p">);</span>
<a id="__codelineno-68-33" name="__codelineno-68-33"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-34" name="__codelineno-68-34"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-68-35" name="__codelineno-68-35"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-36" name="__codelineno-68-36"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;L&#39;erreur 1 suivante s&#39;est produite : {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-68-37" name="__codelineno-68-37"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-38" name="__codelineno-68-38"></a><span class="w">      </span><span class="c1">// lazy loading - mode par défaut</span>
<a id="__codelineno-68-39" name="__codelineno-68-39"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-68-40" name="__codelineno-68-40"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-41" name="__codelineno-68-41"></a><span class="w">        </span><span class="c1">// creneau n° 0</span>
<a id="__codelineno-68-42" name="__codelineno-68-42"></a><span class="w">        </span><span class="n">creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">);</span>
<a id="__codelineno-68-43" name="__codelineno-68-43"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">creneau</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-68-44" name="__codelineno-68-44"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-45" name="__codelineno-68-45"></a><span class="w">      </span><span class="c1">// affichage dépendance</span>
<a id="__codelineno-68-46" name="__codelineno-68-46"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-68-47" name="__codelineno-68-47"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-48" name="__codelineno-68-48"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Médecin={0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">creneau</span><span class="p">.</span><span class="n">Medecin</span><span class="p">);</span>
<a id="__codelineno-68-49" name="__codelineno-68-49"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-50" name="__codelineno-68-50"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-68-51" name="__codelineno-68-51"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-52" name="__codelineno-68-52"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;L&#39;erreur 2 suivante s&#39;est produite : {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-68-53" name="__codelineno-68-53"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-54" name="__codelineno-68-54"></a>
<a id="__codelineno-68-55" name="__codelineno-68-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-68-56" name="__codelineno-68-56"></a>
<a id="__codelineno-68-57" name="__codelineno-68-57"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">InitBase</span><span class="p">()</span>
<a id="__codelineno-68-58" name="__codelineno-68-58"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-68-59" name="__codelineno-68-59"></a><span class="w">      </span><span class="c1">// on initialise la base</span>
<a id="__codelineno-68-60" name="__codelineno-68-60"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-68-61" name="__codelineno-68-61"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-68-62" name="__codelineno-68-62"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-68-63" name="__codelineno-68-63"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-68-64" name="__codelineno-68-64"></a><span class="w">        </span><span class="c1">// on initialise la base</span>
<a id="__codelineno-68-65" name="__codelineno-68-65"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-68-66" name="__codelineno-68-66"></a><span class="w">        </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-67" name="__codelineno-68-67"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Martin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-68-68" name="__codelineno-68-68"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mme&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;German&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Christine&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-68-69" name="__codelineno-68-69"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jacquard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Jules&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-68-70" name="__codelineno-68-70"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Melle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bistrou&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Brigitte&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-68-71" name="__codelineno-68-71"></a><span class="w">     </span><span class="p">};</span>
<a id="__codelineno-68-72" name="__codelineno-68-72"></a><span class="p">...</span>
<a id="__codelineno-68-73" name="__codelineno-68-73"></a><span class="w">        </span><span class="c1">// les Rdv</span>
<a id="__codelineno-68-74" name="__codelineno-68-74"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-68-75" name="__codelineno-68-75"></a><span class="w">        </span><span class="c1">// on sauve le contexte de persistance</span>
<a id="__codelineno-68-76" name="__codelineno-68-76"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-68-77" name="__codelineno-68-77"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-68-78" name="__codelineno-68-78"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-68-79" name="__codelineno-68-79"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-68-80" name="__codelineno-68-80"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 18 : on part d&#x27;une base connue, celle utilisée jusqu&#x27;à maintenant. Après cette opération, les tableaux des lignes 11-13 sont remplis d&#x27;entités détachées ;</li>
<li>lignes 21-22 : on s&#x27;intéresse au premier créneau et au médecin associé ;</li>
<li>ligne 23 : nouveau contexte ;</li>
<li>ligne 26 : on met le créneau dans le contexte avec sa dépendance (eager loading). Parce que ce n&#x27;est pas le mode par défaut, il faut demander explicitement cette dépendance. C&#x27;est la méthode <strong>Include</strong> qui permet cela. Son paramètre est le nom de la dépendance dans l&#x27;entité amenée dans le contexte. La requête qui amène l&#x27;entité dans le contexte utilise des expressions lambda. La méthode <strong>Single</strong> permet de préciser une condition permettant de ramener une unique entité. Ici, on recherche en base l&#x27;entité [Creneau] qui a la clé primaire du créneau n° 0 ;</li>
<li>ligne 27 : on affiche l&#x27;entité ramenée. Rappelons les deux méthodes d&#x27;écriture utilisées dans les entités :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span>
<span class="normal"><a href="#__codelineno-69-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="c1">// signature</span>
<a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Creneau[{0},{1},{2},{3},{4}, {5},{6}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Hdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Mdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Hfin</span><span class="p">,</span><span class="w"> </span><span class="n">Mfin</span><span class="p">,</span><span class="w"> </span><span class="n">Medecin</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-69-6" name="__codelineno-69-6"></a>
<a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="w">   </span><span class="c1">// signature courte</span>
<a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ShortIdentity</span><span class="p">()</span>
<a id="__codelineno-69-9" name="__codelineno-69-9"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Creneau[{0},{1},{2},{3},{4}, {5}, {6}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Hdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Mdebut</span><span class="p">,</span><span class="w"> </span><span class="n">Hfin</span><span class="p">,</span><span class="w"> </span><span class="n">Mfin</span><span class="p">,</span><span class="w"> </span><span class="n">MedecinId</span><span class="p">,</span><span class="w"> </span><span class="n">dump</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">));</span>
<a id="__codelineno-69-11" name="__codelineno-69-11"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 2-5 : la méthode [ToString] affiche la dépendance [Medecin]. Si celle-ci n&#x27;est pas déjà dans le contexte, elle sera cherchée en base pour l&#x27;y mettre ;</li>
<li>lignes 8-11 : la méthode [ShortIdentity] n&#x27;affiche pas la dépendance [Medecin]. Elle ne sera donc pas recherchée en base si elle n&#x27;est pas dans le contexte ;</li>
</ul>
<p>A ce stade, l&#x27;affichage console est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1">1</a></span>
<span class="normal"><a href="#__codelineno-70-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a>Initialisation terminée
<a id="__codelineno-70-2" name="__codelineno-70-2"></a>Creneau[181,8,0,8,20, 21, 00000195150]
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 28 : le contexte est fermé ;</li>
<li>lignes 30-37 : on essaie d&#x27;écrire la dépendance [Medecin] de l&#x27;entité. On rappelle le fonctionnement en <strong>Lazy Loading</strong> : une dépendance est chargée lors de sa première utilisation si elle n&#x27;est pas présente.  Ici, normalement elle est présente. L&#x27;affichage est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a>Médecin=Medecin[21,Mme,Marie,Pelissier,00000195149]
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 39-44 : dans le cadre d&#x27;un nouveau contexte, le créneau n° 0 est de nouveau cherché en base et amené dans le contexte. Ici, la dépendance [Medecin] n&#x27;est pas demandée explicitement. Elle ne sera donc pas amenée (Lazy Loading) ;</li>
<li>ligne 43 : l&#x27;affichage de l&#x27;identité courte du créneau est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a>Creneau[181,8,0,8,20, 21, 00000195150]
</code></pre></div></td></tr></table></div>
<p>Ici, il est important d&#x27;utiliser <em>ShortIdentity</em> au lieu de <em>ToString</em> pour afficher l&#x27;entité. Si on utilise <em>ToString</em>, la dépendance [Medecin] va être affichée et pour cela elle va être cherchée en base. Or on ne veut pas cela.</p>
<ul>
<li>ligne 44 : le contexte est fermé ;</li>
<li>lignes 46-53 : on essaie d&#x27;afficher la dépendance de l&#x27;entité. Il est important de faire cela hors contexte sinon elle sera recherchée en base et trouvée. Ici on est hors contexte. L&#x27;entité [Creneau] est détachée et sa dépendance [Medecin] est absente (Lazy Loading). Que va-t-il se passer ? L&#x27;affichage écran est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="n">L</span><span class="c1">&#39;erreur 2 suivante s&#39;est produite : System.ObjectDisposedException: L&#39;instance ObjectContext a été supprimée et ne peut plus être utilisée pour les opérations qui requièrent une connexion.</span>
<a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="w">   </span><span class="err">à System.Data.Objects.ObjectContext.EnsureConnection()</span>
<a id="__codelineno-73-3" name="__codelineno-73-3"></a><span class="w">   </span><span class="err">à System.Data.Objects.ObjectQuery`1.GetResults(Nullable`1 forMergeOption)</span>
<a id="__codelineno-73-4" name="__codelineno-73-4"></a><span class="w">   </span><span class="err">à System.Data.Objects.ObjectQuery`1.Execute(MergeOption mergeOption)</span>
<a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="w">   </span><span class="err">à System.Data.Objects.DataClasses.EntityReference`1.Load(MergeOption mergeOption)</span>
<a id="__codelineno-73-6" name="__codelineno-73-6"></a><span class="w">   </span><span class="err">à System.Data.Objects.DataClasses.RelatedEnd.Load()</span>
<a id="__codelineno-73-7" name="__codelineno-73-7"></a><span class="w">   </span><span class="err">à System.Data.Objects.DataClasses.RelatedEnd.DeferredLoad()</span>
<a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="w">   </span><span class="err">à System.Data.Objects.Internal.LazyLoadBehavior.LoadProperty[TItem](TItem propertyValue, String relationshipName, String targetRoleName, Boolean mustBeNull,Object wrapperObject)</span>
<a id="__codelineno-73-9" name="__codelineno-73-9"></a><span class="w">   </span><span class="err">à System.Data.Objects.Internal.LazyLoadBehavior.&lt;&gt;c__DisplayClass7`2.&lt;GetInterceptorDelegate&gt;b__2(TProxy proxy, TItem item)</span>
<a id="__codelineno-73-10" name="__codelineno-73-10"></a><span class="w">   </span><span class="err">à System.Data.Entity.DynamicProxies.Creneau_AF14A89855AD9B7E5ABA4A877B4989B2F8B3F7ECA154E3FEC02BA722002773E4.get_Medecin()</span>
<a id="__codelineno-73-11" name="__codelineno-73-11"></a><span class="w">   </span><span class="err">à RdvMedecins_01.LazyEagerLoading.Main(String[] args) dans d:\data\istia-1213\c#\dvp\Entity Framework\RdvMedecins\RdvMedecins-SqlServer-01\LazyEagerLoading.cs:ligne 48</span>
</code></pre></div></td></tr></table></div>
<p>EF a trouvé la dépendance [Medecin] absente. Il a voulu la charger mais le contexte étant fermé, cette opération n&#x27;était plus possible. On mémorisera cette exception [System.ObjectDisposedException] car est elle caractéristique du chargement d&#x27;une dépendance en-dehors d&#x27;un contexte ouvert.</p>
<p>Maintenant examinons la concurrence d&#x27;accès aux entités.</p>
<h3 id="358-concurrence-dacces-aux-entites">3.5.8. Concurrence d&#x27;accès aux entités</h3>
<p>Revenons sur la définition de l&#x27;entité [Client] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-74-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-74-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-74-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-74-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-74-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-74-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-74-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-74-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-74-10">10</a></span>
<span class="normal"><a href="#__codelineno-74-11">11</a></span>
<span class="normal"><a href="#__codelineno-74-12">12</a></span>
<span class="normal"><a href="#__codelineno-74-13">13</a></span>
<span class="normal"><a href="#__codelineno-74-14">14</a></span>
<span class="normal"><a href="#__codelineno-74-15">15</a></span>
<span class="normal"><a href="#__codelineno-74-16">16</a></span>
<span class="normal"><a href="#__codelineno-74-17">17</a></span>
<span class="normal"><a href="#__codelineno-74-18">18</a></span>
<span class="normal"><a href="#__codelineno-74-19">19</a></span>
<span class="normal"><a href="#__codelineno-74-20">20</a></span>
<span class="normal"><a href="#__codelineno-74-21">21</a></span>
<span class="normal"><a href="#__codelineno-74-22">22</a></span>
<span class="normal"><a href="#__codelineno-74-23">23</a></span>
<span class="normal"><a href="#__codelineno-74-24">24</a></span>
<span class="normal"><a href="#__codelineno-74-25">25</a></span>
<span class="normal"><a href="#__codelineno-74-26">26</a></span>
<span class="normal"><a href="#__codelineno-74-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Client</span>
<a id="__codelineno-74-2" name="__codelineno-74-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-74-4" name="__codelineno-74-4"></a><span class="w">    </span><span class="na">[Key]</span>
<a id="__codelineno-74-5" name="__codelineno-74-5"></a><span class="w">    </span><span class="na">[Column(&quot;ID&quot;)]</span>
<a id="__codelineno-74-6" name="__codelineno-74-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int?</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-7" name="__codelineno-74-7"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-74-8" name="__codelineno-74-8"></a><span class="w">    </span><span class="na">[MaxLength(5)]</span>
<a id="__codelineno-74-9" name="__codelineno-74-9"></a><span class="w">    </span><span class="na">[Column(&quot;TITRE&quot;)]</span>
<a id="__codelineno-74-10" name="__codelineno-74-10"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-11" name="__codelineno-74-11"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-74-12" name="__codelineno-74-12"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-74-13" name="__codelineno-74-13"></a><span class="w">    </span><span class="na">[Column(&quot;NOM&quot;)]</span>
<a id="__codelineno-74-14" name="__codelineno-74-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-15" name="__codelineno-74-15"></a><span class="w">    </span><span class="na">[Required]</span>
<a id="__codelineno-74-16" name="__codelineno-74-16"></a><span class="w">    </span><span class="na">[MaxLength(30)]</span>
<a id="__codelineno-74-17" name="__codelineno-74-17"></a><span class="w">    </span><span class="na">[Column(&quot;PRENOM&quot;)]</span>
<a id="__codelineno-74-18" name="__codelineno-74-18"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-19" name="__codelineno-74-19"></a><span class="w">    </span><span class="c1">// les Rvs du client</span>
<a id="__codelineno-74-20" name="__codelineno-74-20"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ICollection</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rvs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-21" name="__codelineno-74-21"></a><span class="w">    </span><span class="na">[Column(&quot;TIMESTAMP&quot;)]</span>
<a id="__codelineno-74-22" name="__codelineno-74-22"></a><span class="w">    </span><span class="na">[Timestamp]</span>
<a id="__codelineno-74-23" name="__codelineno-74-23"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-74-24" name="__codelineno-74-24"></a>
<a id="__codelineno-74-25" name="__codelineno-74-25"></a><span class="w">    </span><span class="c1">// signature</span>
<a id="__codelineno-74-26" name="__codelineno-74-26"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-74-27" name="__codelineno-74-27"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons nous intéresser au champ [Timestamp] de la ligne 23. Nous savons que sa valeur est générée par le SGBD. Nous avons dit également que l&#x27;annotation [Timestamp] de la ligne 22 faisait que EF 5 utilisait le champ annoté pour gérer les concurrences d&#x27;accès aux entités. Rappelons ce qu&#x27;est une gestion de concurrence d&#x27;accès :</p>
<ul>
<li>un processus P1 lit une ligne L de la table [MEDECINS] au temps T1. La ligne a le <em>timestamp</em> TS1 ;</li>
<li>un processus P2 lit la même ligne L de la table [MEDECINS] au temps T2. La ligne a le <em>timestamp</em> TS1 parce que le processus P1 n&#x27;a pas encore validé sa modification ;</li>
<li>le processus P1 valide sa modification de la ligne L. Le <em>timestamp</em> de la ligne L passe alors à TS2 ;</li>
<li>le processus P2 valide sa modification de la ligne L. L&#x27;ORM lance alors une exception car le processus P2 a un <em>timestamp</em> TS1 de la ligne L différent du <em>timestamp</em> TS2 trouvé en base.</li>
</ul>
<p>On appelle cela la <strong>gestion optimiste</strong> des accès concurrents. Avec EF 5, un champ jouant ce rôle doit avoir l&#x27;un des deux attributs [<strong>Timestamp</strong>] ou [<strong>ConcurrencyCheck</strong>]. SQL server a un type [timestamp]. Une colonne ayant ce type voit sa valeur automatiquement générée par SQL Server à toute insertion / modification d&#x27;une ligne. Une telle colonne peut alors servir à gérer la concurrence d&#x27;accès.</p>
<p>Nous allons illustrer cette concurrence d&#x27;accès avec deux threads qui vont modifier en même temps une même entité [Client] en base. Le projet évolue comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000DF0000013F6A80419D.png" style="display:inline-block; margin:4px;width:4.129cm;height:5.911cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000139000000A0D76B7F5B.png" style="display:inline-block; margin:4px;width:5.78cm;height:2.96cm;" /></td></tr></table>

<p>Le code du programme [AccèsConcurrents] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-75-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-75-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-75-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-75-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-75-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-75-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-75-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-75-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-75-10">10</a></span>
<span class="normal"><a href="#__codelineno-75-11">11</a></span>
<span class="normal"><a href="#__codelineno-75-12">12</a></span>
<span class="normal"><a href="#__codelineno-75-13">13</a></span>
<span class="normal"><a href="#__codelineno-75-14">14</a></span>
<span class="normal"><a href="#__codelineno-75-15">15</a></span>
<span class="normal"><a href="#__codelineno-75-16">16</a></span>
<span class="normal"><a href="#__codelineno-75-17">17</a></span>
<span class="normal"><a href="#__codelineno-75-18">18</a></span>
<span class="normal"><a href="#__codelineno-75-19">19</a></span>
<span class="normal"><a href="#__codelineno-75-20">20</a></span>
<span class="normal"><a href="#__codelineno-75-21">21</a></span>
<span class="normal"><a href="#__codelineno-75-22">22</a></span>
<span class="normal"><a href="#__codelineno-75-23">23</a></span>
<span class="normal"><a href="#__codelineno-75-24">24</a></span>
<span class="normal"><a href="#__codelineno-75-25">25</a></span>
<span class="normal"><a href="#__codelineno-75-26">26</a></span>
<span class="normal"><a href="#__codelineno-75-27">27</a></span>
<span class="normal"><a href="#__codelineno-75-28">28</a></span>
<span class="normal"><a href="#__codelineno-75-29">29</a></span>
<span class="normal"><a href="#__codelineno-75-30">30</a></span>
<span class="normal"><a href="#__codelineno-75-31">31</a></span>
<span class="normal"><a href="#__codelineno-75-32">32</a></span>
<span class="normal"><a href="#__codelineno-75-33">33</a></span>
<span class="normal"><a href="#__codelineno-75-34">34</a></span>
<span class="normal"><a href="#__codelineno-75-35">35</a></span>
<span class="normal"><a href="#__codelineno-75-36">36</a></span>
<span class="normal"><a href="#__codelineno-75-37">37</a></span>
<span class="normal"><a href="#__codelineno-75-38">38</a></span>
<span class="normal"><a href="#__codelineno-75-39">39</a></span>
<span class="normal"><a href="#__codelineno-75-40">40</a></span>
<span class="normal"><a href="#__codelineno-75-41">41</a></span>
<span class="normal"><a href="#__codelineno-75-42">42</a></span>
<span class="normal"><a href="#__codelineno-75-43">43</a></span>
<span class="normal"><a href="#__codelineno-75-44">44</a></span>
<span class="normal"><a href="#__codelineno-75-45">45</a></span>
<span class="normal"><a href="#__codelineno-75-46">46</a></span>
<span class="normal"><a href="#__codelineno-75-47">47</a></span>
<span class="normal"><a href="#__codelineno-75-48">48</a></span>
<span class="normal"><a href="#__codelineno-75-49">49</a></span>
<span class="normal"><a href="#__codelineno-75-50">50</a></span>
<span class="normal"><a href="#__codelineno-75-51">51</a></span>
<span class="normal"><a href="#__codelineno-75-52">52</a></span>
<span class="normal"><a href="#__codelineno-75-53">53</a></span>
<span class="normal"><a href="#__codelineno-75-54">54</a></span>
<span class="normal"><a href="#__codelineno-75-55">55</a></span>
<span class="normal"><a href="#__codelineno-75-56">56</a></span>
<span class="normal"><a href="#__codelineno-75-57">57</a></span>
<span class="normal"><a href="#__codelineno-75-58">58</a></span>
<span class="normal"><a href="#__codelineno-75-59">59</a></span>
<span class="normal"><a href="#__codelineno-75-60">60</a></span>
<span class="normal"><a href="#__codelineno-75-61">61</a></span>
<span class="normal"><a href="#__codelineno-75-62">62</a></span>
<span class="normal"><a href="#__codelineno-75-63">63</a></span>
<span class="normal"><a href="#__codelineno-75-64">64</a></span>
<span class="normal"><a href="#__codelineno-75-65">65</a></span>
<span class="normal"><a href="#__codelineno-75-66">66</a></span>
<span class="normal"><a href="#__codelineno-75-67">67</a></span>
<span class="normal"><a href="#__codelineno-75-68">68</a></span>
<span class="normal"><a href="#__codelineno-75-69">69</a></span>
<span class="normal"><a href="#__codelineno-75-70">70</a></span>
<span class="normal"><a href="#__codelineno-75-71">71</a></span>
<span class="normal"><a href="#__codelineno-75-72">72</a></span>
<span class="normal"><a href="#__codelineno-75-73">73</a></span>
<span class="normal"><a href="#__codelineno-75-74">74</a></span>
<span class="normal"><a href="#__codelineno-75-75">75</a></span>
<span class="normal"><a href="#__codelineno-75-76">76</a></span>
<span class="normal"><a href="#__codelineno-75-77">77</a></span>
<span class="normal"><a href="#__codelineno-75-78">78</a></span>
<span class="normal"><a href="#__codelineno-75-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Data</span><span class="p">;</span>
<a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-75-4" name="__codelineno-75-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a id="__codelineno-75-5" name="__codelineno-75-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-75-6" name="__codelineno-75-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-75-7" name="__codelineno-75-7"></a>
<a id="__codelineno-75-8" name="__codelineno-75-8"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-75-9" name="__codelineno-75-9"></a><span class="p">{</span>
<a id="__codelineno-75-10" name="__codelineno-75-10"></a>
<a id="__codelineno-75-11" name="__codelineno-75-11"></a><span class="w">  </span><span class="c1">// objet échangé avec les threads</span>
<a id="__codelineno-75-12" name="__codelineno-75-12"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Data</span>
<a id="__codelineno-75-13" name="__codelineno-75-13"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-75-14" name="__codelineno-75-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Duree</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-75-15" name="__codelineno-75-15"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-75-16" name="__codelineno-75-16"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-75-17" name="__codelineno-75-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-75-18" name="__codelineno-75-18"></a>
<a id="__codelineno-75-19" name="__codelineno-75-19"></a><span class="w">  </span><span class="c1">// programme de test</span>
<a id="__codelineno-75-20" name="__codelineno-75-20"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">AccèsConcurrents</span>
<a id="__codelineno-75-21" name="__codelineno-75-21"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-75-22" name="__codelineno-75-22"></a>
<a id="__codelineno-75-23" name="__codelineno-75-23"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-75-24" name="__codelineno-75-24"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-75-25" name="__codelineno-75-25"></a><span class="w">      </span><span class="n">Client</span><span class="w"> </span><span class="n">client1</span><span class="p">;</span>
<a id="__codelineno-75-26" name="__codelineno-75-26"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-75-27" name="__codelineno-75-27"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-75-28" name="__codelineno-75-28"></a><span class="w">        </span><span class="c1">// thread principal</span>
<a id="__codelineno-75-29" name="__codelineno-75-29"></a><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;main&quot;</span><span class="p">;</span>
<a id="__codelineno-75-30" name="__codelineno-75-30"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-75-31" name="__codelineno-75-31"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-75-32" name="__codelineno-75-32"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-75-33" name="__codelineno-75-33"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-75-34" name="__codelineno-75-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-75-35" name="__codelineno-75-35"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-75-36" name="__codelineno-75-36"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-75-37" name="__codelineno-75-37"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-75-38" name="__codelineno-75-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-75-39" name="__codelineno-75-39"></a><span class="w">        </span><span class="c1">// on ajoute un client</span>
<a id="__codelineno-75-40" name="__codelineno-75-40"></a><span class="w">        </span><span class="n">client1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-75-41" name="__codelineno-75-41"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-75-42" name="__codelineno-75-42"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-75-43" name="__codelineno-75-43"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0} client1--avant sauvegarde du contexte&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-75-44" name="__codelineno-75-44"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client1</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-75-45" name="__codelineno-75-45"></a><span class="w">        </span><span class="c1">// sauvegarde</span>
<a id="__codelineno-75-46" name="__codelineno-75-46"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-75-47" name="__codelineno-75-47"></a><span class="w">        </span><span class="c1">// suivi</span>
<a id="__codelineno-75-48" name="__codelineno-75-48"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0} client1--après sauvegarde du contexte&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-75-49" name="__codelineno-75-49"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client1</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-75-50" name="__codelineno-75-50"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-75-51" name="__codelineno-75-51"></a><span class="w">      </span><span class="c1">// on va modifier client1 avec deux threads</span>
<a id="__codelineno-75-52" name="__codelineno-75-52"></a><span class="w">      </span><span class="c1">// thead t1</span>
<a id="__codelineno-75-53" name="__codelineno-75-53"></a><span class="w">      </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">Modifie</span><span class="p">);</span>
<a id="__codelineno-75-54" name="__codelineno-75-54"></a><span class="w">      </span><span class="n">t1</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;t1&quot;</span><span class="p">;</span>
<a id="__codelineno-75-55" name="__codelineno-75-55"></a><span class="w">      </span><span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Duree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;yy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client1</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-75-56" name="__codelineno-75-56"></a><span class="w">      </span><span class="c1">// thread t2</span>
<a id="__codelineno-75-57" name="__codelineno-75-57"></a><span class="w">      </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">Modifie</span><span class="p">);</span>
<a id="__codelineno-75-58" name="__codelineno-75-58"></a><span class="w">      </span><span class="n">t2</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;t2&quot;</span><span class="p">;</span>
<a id="__codelineno-75-59" name="__codelineno-75-59"></a><span class="w">      </span><span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Duree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;zz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client1</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-75-60" name="__codelineno-75-60"></a><span class="w">      </span><span class="c1">// on attend la fin des 2 threads</span>
<a id="__codelineno-75-61" name="__codelineno-75-61"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} -- début attente fin des deux threads&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-75-62" name="__codelineno-75-62"></a><span class="w">      </span><span class="n">t1</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
<a id="__codelineno-75-63" name="__codelineno-75-63"></a><span class="w">      </span><span class="n">t2</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
<a id="__codelineno-75-64" name="__codelineno-75-64"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} -- fin attente fin des deux threads&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-75-65" name="__codelineno-75-65"></a><span class="w">      </span><span class="c1">// on affiche la modification - une seule a du réussir</span>
<a id="__codelineno-75-66" name="__codelineno-75-66"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-75-67" name="__codelineno-75-67"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-75-68" name="__codelineno-75-68"></a><span class="w">        </span><span class="c1">// on récupère client1 dans client2</span>
<a id="__codelineno-75-69" name="__codelineno-75-69"></a><span class="w">        </span><span class="n">Client</span><span class="w"> </span><span class="n">client2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">client1</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-75-70" name="__codelineno-75-70"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} client2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-75-71" name="__codelineno-75-71"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} {1}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">client2</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-75-72" name="__codelineno-75-72"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-75-73" name="__codelineno-75-73"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-75-74" name="__codelineno-75-74"></a>
<a id="__codelineno-75-75" name="__codelineno-75-75"></a><span class="w">    </span><span class="c1">// thread</span>
<a id="__codelineno-75-76" name="__codelineno-75-76"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Modifie</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">infos</span><span class="p">)</span>
<a id="__codelineno-75-77" name="__codelineno-75-77"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-75-78" name="__codelineno-75-78"></a><span class="w"> </span><span class="p">...</span>
<a id="__codelineno-75-79" name="__codelineno-75-79"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 26 : on démarre un contexte vide ;</li>
<li>ligne 29 : on donne un nom au thread courant pour le différentier des deux threads qui vont être créés ultérieurement ;</li>
<li>lignes 31-38 : les entités [Medecin] et [Client] sont mises dans l&#x27;état &quot; supprimé &quot; ;</li>
<li>lignes 40-41: on met un client dans le contexte ;</li>
<li>lignes 43-44 : on l&#x27;affiche avant la synchronisation du contexte ;</li>
<li>ligne 46 : synchronisation du contexte avec la base : les entités dans l&#x27;état &quot; supprimé &quot; vont être supprimées de la base. L&#x27;entité [Client] mise dans le contexte va être insérée dans la base. Ce sera le seul élément de la base ;</li>
<li>lignes 47-49 : on affiche le client après synchronisation du contexte. A ce stade, les affichages écran sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span>
<span class="normal"><a href="#__codelineno-76-2">2</a></span>
<span class="normal"><a href="#__codelineno-76-3">3</a></span>
<span class="normal"><a href="#__codelineno-76-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a>main client1--avant sauvegarde du contexte
<a id="__codelineno-76-2" name="__codelineno-76-2"></a>Client[,xx,xx,xx,]
<a id="__codelineno-76-3" name="__codelineno-76-3"></a>main client1--après sauvegarde du contexte
<a id="__codelineno-76-4" name="__codelineno-76-4"></a>Client[33,xx,xx,xx,000001126209]
</code></pre></div></td></tr></table></div>
<p>On remarquera qu&#x27;après synchronisation du contexte, le client a une clé primaire et un <em>timestamp</em> ;</p>
<ul>
<li>ligne 50 : le contexte est fermé ;</li>
<li>ligne 53 : un thread t1 est associé à la méthode [Modifie] de la ligne 84. Cela signifie que lorsqu&#x27;il sera lancé, il exécutera la méthode [Modifie] ;</li>
<li>ligne 54 : on donne un nom au thread t1 ;</li>
<li>ligne 55 : le thread t1 est lancé. On lui passe des paramètres sous la forme d&#x27;une structure [Data] définie lignes 12-17 :</li>
<li><strong>Durée</strong> : le thread s&#x27;arrêtera <em>Durée</em> secondes avant de terminer son exécution,</li>
<li><strong>Client</strong> : une référence sur le client à mettre à jour dans la base,</li>
<li><strong>Nom </strong>: nom à donner à ce client ;</li>
<li>lignes 57-59 : même chose avec un deuxième thread. Au final, deux threads vont essayer de changer en base, le nom du même client ;</li>
<li>lignes 60-63 : après avoir lancé les deux threads, le thread principal attend leur fin d&#x27;exécution ;</li>
<li>ligne 62 : attente de la fin du thread t1 ;</li>
<li>ligne 63 : attente de la fin du thread t2 ;</li>
<li>ligne 64 : on se sait pas dans quel ordre les deux threads vont se terminer. Ce qui est sûr, c&#x27;est qu&#x27;en ligne 64 ils sont terminés ;</li>
<li>lignes 66-72 : dans un nouveau contexte, on va chercher le client en base pour voir dans quel état il est.</li>
</ul>
<p>Voyons maintenant, ce que font les deux threads t1 et t2. Ils exécutent la méthode [Modifie] suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span>
<span class="normal"><a href="#__codelineno-77-17">17</a></span>
<span class="normal"><a href="#__codelineno-77-18">18</a></span>
<span class="normal"><a href="#__codelineno-77-19">19</a></span>
<span class="normal"><a href="#__codelineno-77-20">20</a></span>
<span class="normal"><a href="#__codelineno-77-21">21</a></span>
<span class="normal"><a href="#__codelineno-77-22">22</a></span>
<span class="normal"><a href="#__codelineno-77-23">23</a></span>
<span class="normal"><a href="#__codelineno-77-24">24</a></span>
<span class="normal"><a href="#__codelineno-77-25">25</a></span>
<span class="normal"><a href="#__codelineno-77-26">26</a></span>
<span class="normal"><a href="#__codelineno-77-27">27</a></span>
<span class="normal"><a href="#__codelineno-77-28">28</a></span>
<span class="normal"><a href="#__codelineno-77-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Modifie</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">infos</span><span class="p">)</span>
<a id="__codelineno-77-2" name="__codelineno-77-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-77-3" name="__codelineno-77-3"></a><span class="w">      </span><span class="c1">// on récupère le paramètre</span>
<a id="__codelineno-77-4" name="__codelineno-77-4"></a><span class="w">      </span><span class="n">Data</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">)</span><span class="n">infos</span><span class="p">;</span>
<a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-77-6" name="__codelineno-77-6"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-77-7" name="__codelineno-77-7"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-77-8" name="__codelineno-77-8"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-77-9" name="__codelineno-77-9"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Début Thread {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-77-10" name="__codelineno-77-10"></a><span class="w">          </span><span class="c1">// on récupère client1 dans client2</span>
<a id="__codelineno-77-11" name="__codelineno-77-11"></a><span class="w">          </span><span class="n">Client</span><span class="w"> </span><span class="n">client2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Client</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-77-12" name="__codelineno-77-12"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} client2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-77-13" name="__codelineno-77-13"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} {1}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">client2</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-77-14" name="__codelineno-77-14"></a><span class="w">          </span><span class="c1">// on modifie client2</span>
<a id="__codelineno-77-15" name="__codelineno-77-15"></a><span class="w">          </span><span class="n">client2</span><span class="p">.</span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">Nom</span><span class="p">;</span>
<a id="__codelineno-77-16" name="__codelineno-77-16"></a><span class="w">          </span><span class="c1">// on attend un peu</span>
<a id="__codelineno-77-17" name="__codelineno-77-17"></a><span class="w">          </span><span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Duree</span><span class="p">);</span>
<a id="__codelineno-77-18" name="__codelineno-77-18"></a><span class="w">          </span><span class="c1">// on sauvegarde les changements</span>
<a id="__codelineno-77-19" name="__codelineno-77-19"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-77-20" name="__codelineno-77-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-77-21" name="__codelineno-77-21"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-77-22" name="__codelineno-77-22"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-77-23" name="__codelineno-77-23"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-77-24" name="__codelineno-77-24"></a><span class="w">        </span><span class="c1">// exception</span>
<a id="__codelineno-77-25" name="__codelineno-77-25"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Thread {0} {1}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-77-26" name="__codelineno-77-26"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-77-27" name="__codelineno-77-27"></a><span class="w">      </span><span class="c1">// fin du thread</span>
<a id="__codelineno-77-28" name="__codelineno-77-28"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Fin Thread {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<a id="__codelineno-77-29" name="__codelineno-77-29"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 4 : on récupère les paramètres du thread (Durée, Nom, Client) ;</li>
<li>ligne 7 : nouveau contexte ;</li>
<li>ligne 11 : le client est amené dans le contexte ;</li>
<li>lignes 12-13 : suivi pour voir l&#x27;état du client ;</li>
<li>ligne 15 : on change son nom ;</li>
<li>ligne 17 : le thread s&#x27;arrête <em>Duree</em> milli-secondes. Cela a un effet intéressant. Le thread lâche le processeur qui l&#x27;exécutait laissant la place à un autre thread. Dans notre exemple, nous avons trois threads : main, t1 , t2. Le thread <em>main</em> est à l&#x27;arrêt attendant la fin des threads t1 et t2. En supposant que le thread t1 ait le processeur le premier, il le laisse désormais au thread t2. Cela va avoir pour effet, que le thread t2 va lire exactement la même chose que le thread t1, le même client avec le même <em>timestamp</em> ;</li>
<li>ligne 19 : le contexte est synchronisé avec la base. Admettons de nouveau que le thread t1 se réveille le premier. Il va sauvegarder le client avec le nom &quot;<strong> yy </strong>&quot;. Il va pouvoir le faire parce qu&#x27;il a le même <em>timestamp</em> qu&#x27;en base. A cause de cette mise à jour, le SGBD va modifier le <em>timestamp</em>. Lorsque le thread t2 va se réveiller à son tour, il aura un client avec un <em>timestamp</em> différent de celui qui est maintenant en base. Sa mise à jour va être refusée.</li>
</ul>
<p>Les affichages écran sont les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span>
<span class="normal"><a href="#__codelineno-78-17">17</a></span>
<span class="normal"><a href="#__codelineno-78-18">18</a></span>
<span class="normal"><a href="#__codelineno-78-19">19</a></span>
<span class="normal"><a href="#__codelineno-78-20">20</a></span>
<span class="normal"><a href="#__codelineno-78-21">21</a></span>
<span class="normal"><a href="#__codelineno-78-22">22</a></span>
<span class="normal"><a href="#__codelineno-78-23">23</a></span>
<span class="normal"><a href="#__codelineno-78-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a>main client1--avant sauvegarde du contexte
<a id="__codelineno-78-2" name="__codelineno-78-2"></a>Client[,xx,xx,xx,]
<a id="__codelineno-78-3" name="__codelineno-78-3"></a>main client1--après sauvegarde du contexte
<a id="__codelineno-78-4" name="__codelineno-78-4"></a>Client[33,xx,xx,xx,000001126209]
<a id="__codelineno-78-5" name="__codelineno-78-5"></a>Thread main -- début attente fin des deux threads
<a id="__codelineno-78-6" name="__codelineno-78-6"></a>Début Thread t1
<a id="__codelineno-78-7" name="__codelineno-78-7"></a>Début Thread t2
<a id="__codelineno-78-8" name="__codelineno-78-8"></a>Thread t2 client2
<a id="__codelineno-78-9" name="__codelineno-78-9"></a>Thread t2 Client[33,xx,xx,xx,000001126209]
<a id="__codelineno-78-10" name="__codelineno-78-10"></a>Thread t1 client2
<a id="__codelineno-78-11" name="__codelineno-78-11"></a>Thread t1 Client[33,xx,xx,xx,000001126209]
<a id="__codelineno-78-12" name="__codelineno-78-12"></a>Fin Thread t2
<a id="__codelineno-78-13" name="__codelineno-78-13"></a>Thread t1 System.Data.Entity.Infrastructure.DbUpdateConcurrencyException: Une instruction de mise à jour, d&#39;insertion ou de suppression dans le magasin a affecté un nombre inattendu de lignes (0). Des entités ont peut-être été modifiées ou supprimées depuis leur chargement. Actualisez les entrées ObjectStateManager. ---&gt; System.Data.OptimisticConcurrencyException: Une instruction de mise à jour, d&#39;insertion ou de suppression dans le magasin a affecté un nombre inattendu de lignes (0). Des entités ont peut-être été modifiées ou supprimées depuis leur char
<a id="__codelineno-78-14" name="__codelineno-78-14"></a>gement. Actualisez les entrées ObjectStateManager.
<a id="__codelineno-78-15" name="__codelineno-78-15"></a>   à System.Data.Mapping.Update.Internal.UpdateTranslator.ValidateRowsAffected(I
<a id="__codelineno-78-16" name="__codelineno-78-16"></a>nt64 rowsAffected, UpdateCommand source)
<a id="__codelineno-78-17" name="__codelineno-78-17"></a>   ...
<a id="__codelineno-78-18" name="__codelineno-78-18"></a>   à RdvMedecins_01.AccèsConcurrents.Modifie(Object infos) dans d:\data\istia-12
<a id="__codelineno-78-19" name="__codelineno-78-19"></a>13\c#\dvp\Entity Framework\RdvMedecins\RdvMedecins-SqlServer-01\AccèsConcurrents
<a id="__codelineno-78-20" name="__codelineno-78-20"></a>.cs:ligne 102
<a id="__codelineno-78-21" name="__codelineno-78-21"></a>Fin Thread t1
<a id="__codelineno-78-22" name="__codelineno-78-22"></a>Thread main -- fin attente fin des deux threads
<a id="__codelineno-78-23" name="__codelineno-78-23"></a>Thread main client2
<a id="__codelineno-78-24" name="__codelineno-78-24"></a>Thread main Client[33,xx,xx,zz,000001126210]
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 4 : le client dans la base ;</li>
<li>ligne 9 : le client tel qu&#x27;il est lu par le thread t2 ;</li>
<li>ligne 11 : le client tel qu&#x27;il est lu par le thread t1. Les deux threads ont donc lu la même chose ;</li>
<li>ligne 12 : le thread t2 se termine le premier. Il a donc pu faire sa mise à jour. Le nom a du passer à &quot; zz &quot; ;</li>
<li>ligne 13 : le thread t1 lance une exception de type [System.Data.OptimisticConcurrencyException]. EF a détecté qu&#x27;il n&#x27;avait pas le bon <em>timestamp</em> ;</li>
<li>ligne 21 : le thread t1 se termine à son tour ;</li>
<li>ligne 22 : le thread principal a terminé son attente ;</li>
<li>ligne 24 :  le thread principal affiche le client en base. C&#x27;est bien le thread t2 qui a gagné. Le nom est &quot; zz &quot;. On notera que le <em>timestamp</em> a changé.</li>
</ul>
<p>Maintenant, examinons un autre aspect : la transaction qui encadre la synchronisation du contexte de persistance avec la base.</p>
<h3 id="359-synchronisation-dans-une-transaction">3.5.9. Synchronisation dans une transaction</h3>
<p>La table [CRENEAUX] a une contrainte d&#x27;unicité que nous avons ajoutée à la main (cf paragraphe 2.2.4, page 11) :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">RV</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">UNQ1_RV</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">JOUR</span><span class="p">,</span><span class="w"> </span><span class="n">ID_CRENEAU</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons procéder de la façon suivante : nous allons ajouter en même temps deux rendez-vous pour le même médecin, le même jour et le même créneau horaire. On va voir ce qui se passe.</p>
<p>Le projet évolue comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F30000014F4C30B2B9.png" style="display:inline-block; margin:4px;width:4.5cm;height:6.2cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000013C0000009EB256FB66.png" style="display:inline-block; margin:4px;width:5.851cm;height:2.93cm;" /></td></tr></table>

<p>Le code du programme [SynchronisationTransaction] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span>
<span class="normal"><a href="#__codelineno-80-20">20</a></span>
<span class="normal"><a href="#__codelineno-80-21">21</a></span>
<span class="normal"><a href="#__codelineno-80-22">22</a></span>
<span class="normal"><a href="#__codelineno-80-23">23</a></span>
<span class="normal"><a href="#__codelineno-80-24">24</a></span>
<span class="normal"><a href="#__codelineno-80-25">25</a></span>
<span class="normal"><a href="#__codelineno-80-26">26</a></span>
<span class="normal"><a href="#__codelineno-80-27">27</a></span>
<span class="normal"><a href="#__codelineno-80-28">28</a></span>
<span class="normal"><a href="#__codelineno-80-29">29</a></span>
<span class="normal"><a href="#__codelineno-80-30">30</a></span>
<span class="normal"><a href="#__codelineno-80-31">31</a></span>
<span class="normal"><a href="#__codelineno-80-32">32</a></span>
<span class="normal"><a href="#__codelineno-80-33">33</a></span>
<span class="normal"><a href="#__codelineno-80-34">34</a></span>
<span class="normal"><a href="#__codelineno-80-35">35</a></span>
<span class="normal"><a href="#__codelineno-80-36">36</a></span>
<span class="normal"><a href="#__codelineno-80-37">37</a></span>
<span class="normal"><a href="#__codelineno-80-38">38</a></span>
<span class="normal"><a href="#__codelineno-80-39">39</a></span>
<span class="normal"><a href="#__codelineno-80-40">40</a></span>
<span class="normal"><a href="#__codelineno-80-41">41</a></span>
<span class="normal"><a href="#__codelineno-80-42">42</a></span>
<span class="normal"><a href="#__codelineno-80-43">43</a></span>
<span class="normal"><a href="#__codelineno-80-44">44</a></span>
<span class="normal"><a href="#__codelineno-80-45">45</a></span>
<span class="normal"><a href="#__codelineno-80-46">46</a></span>
<span class="normal"><a href="#__codelineno-80-47">47</a></span>
<span class="normal"><a href="#__codelineno-80-48">48</a></span>
<span class="normal"><a href="#__codelineno-80-49">49</a></span>
<span class="normal"><a href="#__codelineno-80-50">50</a></span>
<span class="normal"><a href="#__codelineno-80-51">51</a></span>
<span class="normal"><a href="#__codelineno-80-52">52</a></span>
<span class="normal"><a href="#__codelineno-80-53">53</a></span>
<span class="normal"><a href="#__codelineno-80-54">54</a></span>
<span class="normal"><a href="#__codelineno-80-55">55</a></span>
<span class="normal"><a href="#__codelineno-80-56">56</a></span>
<span class="normal"><a href="#__codelineno-80-57">57</a></span>
<span class="normal"><a href="#__codelineno-80-58">58</a></span>
<span class="normal"><a href="#__codelineno-80-59">59</a></span>
<span class="normal"><a href="#__codelineno-80-60">60</a></span>
<span class="normal"><a href="#__codelineno-80-61">61</a></span>
<span class="normal"><a href="#__codelineno-80-62">62</a></span>
<span class="normal"><a href="#__codelineno-80-63">63</a></span>
<span class="normal"><a href="#__codelineno-80-64">64</a></span>
<span class="normal"><a href="#__codelineno-80-65">65</a></span>
<span class="normal"><a href="#__codelineno-80-66">66</a></span>
<span class="normal"><a href="#__codelineno-80-67">67</a></span>
<span class="normal"><a href="#__codelineno-80-68">68</a></span>
<span class="normal"><a href="#__codelineno-80-69">69</a></span>
<span class="normal"><a href="#__codelineno-80-70">70</a></span>
<span class="normal"><a href="#__codelineno-80-71">71</a></span>
<span class="normal"><a href="#__codelineno-80-72">72</a></span>
<span class="normal"><a href="#__codelineno-80-73">73</a></span>
<span class="normal"><a href="#__codelineno-80-74">74</a></span>
<span class="normal"><a href="#__codelineno-80-75">75</a></span>
<span class="normal"><a href="#__codelineno-80-76">76</a></span>
<span class="normal"><a href="#__codelineno-80-77">77</a></span>
<span class="normal"><a href="#__codelineno-80-78">78</a></span>
<span class="normal"><a href="#__codelineno-80-79">79</a></span>
<span class="normal"><a href="#__codelineno-80-80">80</a></span>
<span class="normal"><a href="#__codelineno-80-81">81</a></span>
<span class="normal"><a href="#__codelineno-80-82">82</a></span>
<span class="normal"><a href="#__codelineno-80-83">83</a></span>
<span class="normal"><a href="#__codelineno-80-84">84</a></span>
<span class="normal"><a href="#__codelineno-80-85">85</a></span>
<span class="normal"><a href="#__codelineno-80-86">86</a></span>
<span class="normal"><a href="#__codelineno-80-87">87</a></span>
<span class="normal"><a href="#__codelineno-80-88">88</a></span>
<span class="normal"><a href="#__codelineno-80-89">89</a></span>
<span class="normal"><a href="#__codelineno-80-90">90</a></span>
<span class="normal"><a href="#__codelineno-80-91">91</a></span>
<span class="normal"><a href="#__codelineno-80-92">92</a></span>
<span class="normal"><a href="#__codelineno-80-93">93</a></span>
<span class="normal"><a href="#__codelineno-80-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-80-5" name="__codelineno-80-5"></a>
<a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins_01</span>
<a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="p">{</span>
<a id="__codelineno-80-8" name="__codelineno-80-8"></a>
<a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w">  </span><span class="c1">// programme de test</span>
<a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">SynchronisationTransaction</span>
<a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-80-12" name="__codelineno-80-12"></a>
<a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w">        </span><span class="c1">// on vide la base actuelle</span>
<a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">)</span>
<a id="__codelineno-80-19" name="__codelineno-80-19"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-20" name="__codelineno-80-20"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-80-21" name="__codelineno-80-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-22" name="__codelineno-80-22"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">)</span>
<a id="__codelineno-80-23" name="__codelineno-80-23"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-24" name="__codelineno-80-24"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-80-25" name="__codelineno-80-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-26" name="__codelineno-80-26"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-80-27" name="__codelineno-80-27"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-80-28" name="__codelineno-80-28"></a>
<a id="__codelineno-80-29" name="__codelineno-80-29"></a><span class="w">      </span><span class="c1">// on crée un client</span>
<a id="__codelineno-80-30" name="__codelineno-80-30"></a><span class="w">      </span><span class="n">Client</span><span class="w"> </span><span class="n">client1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-80-31" name="__codelineno-80-31"></a><span class="w">      </span><span class="c1">// on crée un médecin</span>
<a id="__codelineno-80-32" name="__codelineno-80-32"></a><span class="w">      </span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Prenom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Titre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xx&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-80-33" name="__codelineno-80-33"></a><span class="w">      </span><span class="c1">// on crée un créneau pour ce médecin</span>
<a id="__codelineno-80-34" name="__codelineno-80-34"></a><span class="w">      </span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Hdebut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Mdebut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">Hfin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Mfin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">medecin1</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-80-35" name="__codelineno-80-35"></a><span class="w">      </span><span class="c1">// on crée deux Rv pour ce médecin et ce client, même jour, même créneau</span>
<a id="__codelineno-80-36" name="__codelineno-80-36"></a><span class="w">      </span><span class="n">Rv</span><span class="w"> </span><span class="n">rv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client1</span><span class="p">,</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneau1</span><span class="p">,</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-80-37" name="__codelineno-80-37"></a><span class="w">      </span><span class="n">Rv</span><span class="w"> </span><span class="n">rv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client1</span><span class="p">,</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneau1</span><span class="p">,</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-80-38" name="__codelineno-80-38"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-80-39" name="__codelineno-80-39"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-80-40" name="__codelineno-80-40"></a><span class="w">        </span><span class="c1">// on met tout ce petit monde dans le contexte de persistance</span>
<a id="__codelineno-80-41" name="__codelineno-80-41"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-80-42" name="__codelineno-80-42"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-43" name="__codelineno-80-43"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">client1</span><span class="p">);</span>
<a id="__codelineno-80-44" name="__codelineno-80-44"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">creneau1</span><span class="p">);</span>
<a id="__codelineno-80-45" name="__codelineno-80-45"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">medecin1</span><span class="p">);</span>
<a id="__codelineno-80-46" name="__codelineno-80-46"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rv1</span><span class="p">);</span>
<a id="__codelineno-80-47" name="__codelineno-80-47"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rv2</span><span class="p">);</span>
<a id="__codelineno-80-48" name="__codelineno-80-48"></a><span class="w">          </span><span class="c1">// on sauvegarde le contexte - on doit avoir une exception</span>
<a id="__codelineno-80-49" name="__codelineno-80-49"></a><span class="w">          </span><span class="c1">// car la BD sous-jacente a une contrainte d&#39;unicité empêchant</span>
<a id="__codelineno-80-50" name="__codelineno-80-50"></a><span class="w">          </span><span class="c1">// d&#39;avoir deux RDV même jour, même créneau</span>
<a id="__codelineno-80-51" name="__codelineno-80-51"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-80-52" name="__codelineno-80-52"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-53" name="__codelineno-80-53"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-80-54" name="__codelineno-80-54"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-80-55" name="__codelineno-80-55"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-80-56" name="__codelineno-80-56"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Erreur : {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-80-57" name="__codelineno-80-57"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-80-58" name="__codelineno-80-58"></a><span class="w">      </span><span class="c1">// si la sauvegarde se passe dans une transaction alors rien n&#39;a du être inséré dans la base</span>
<a id="__codelineno-80-59" name="__codelineno-80-59"></a><span class="w">      </span><span class="c1">// à cause de l&#39;exception précédente - on vérifie</span>
<a id="__codelineno-80-60" name="__codelineno-80-60"></a>
<a id="__codelineno-80-61" name="__codelineno-80-61"></a><span class="w">      </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-80-62" name="__codelineno-80-62"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-80-63" name="__codelineno-80-63"></a><span class="w">        </span><span class="c1">// les clients</span>
<a id="__codelineno-80-64" name="__codelineno-80-64"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Clients--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-80-65" name="__codelineno-80-65"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-80-66" name="__codelineno-80-66"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-80-67" name="__codelineno-80-67"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-68" name="__codelineno-80-68"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-80-69" name="__codelineno-80-69"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-70" name="__codelineno-80-70"></a><span class="w">        </span><span class="c1">// les médecins</span>
<a id="__codelineno-80-71" name="__codelineno-80-71"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Médecins--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-80-72" name="__codelineno-80-72"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">medecin</span><span class="p">;</span>
<a id="__codelineno-80-73" name="__codelineno-80-73"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">medecins</span><span class="p">)</span>
<a id="__codelineno-80-74" name="__codelineno-80-74"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-75" name="__codelineno-80-75"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">medecin</span><span class="p">);</span>
<a id="__codelineno-80-76" name="__codelineno-80-76"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-77" name="__codelineno-80-77"></a><span class="w">        </span><span class="c1">// les créneaux horaires</span>
<a id="__codelineno-80-78" name="__codelineno-80-78"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Créneaux horaires--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-80-79" name="__codelineno-80-79"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">creneaux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">creneau</span><span class="p">;</span>
<a id="__codelineno-80-80" name="__codelineno-80-80"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">creneaux</span><span class="p">)</span>
<a id="__codelineno-80-81" name="__codelineno-80-81"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-82" name="__codelineno-80-82"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">creneau</span><span class="p">);</span>
<a id="__codelineno-80-83" name="__codelineno-80-83"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-84" name="__codelineno-80-84"></a><span class="w">        </span><span class="c1">// les Rdvs</span>
<a id="__codelineno-80-85" name="__codelineno-80-85"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Rendez-vous--------------------------------------&quot;</span><span class="p">);</span>
<a id="__codelineno-80-86" name="__codelineno-80-86"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">rvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">rv</span><span class="p">;</span>
<a id="__codelineno-80-87" name="__codelineno-80-87"></a><span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Rv</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rvs</span><span class="p">)</span>
<a id="__codelineno-80-88" name="__codelineno-80-88"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-89" name="__codelineno-80-89"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
<a id="__codelineno-80-90" name="__codelineno-80-90"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-91" name="__codelineno-80-91"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-80-92" name="__codelineno-80-92"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-80-93" name="__codelineno-80-93"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-80-94" name="__codelineno-80-94"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 15-27 : on utilise un contexte de persistance pour vider la base ;</li>
<li>ligne 30 : création d&#x27;un objet [Client] ;</li>
<li>ligne 32 : création d&#x27;un objet [Medecin] ;</li>
<li>ligne 34 : création d&#x27;un objet [Creneau] ;</li>
<li>ligne 36 : création d&#x27;un objet [Rv] ;</li>
<li>ligne 37 : création d&#x27;un second objet [Rv] identique au précédent ;</li>
<li>ligne 41 : ouverture d&#x27;un nouveau contexte ;</li>
<li>lignes 43-47 : les objets créés précédemment sont attachés au nouveau contexte. Notez ici, qu&#x27;en tenant compte des dépendances, nous aurions pu minimiser le nombre d&#x27;opération <em>Add</em>. Mais EF lui optimisera les ordres SQL INSERT à émettre sur la base ;</li>
<li>ligne 51 : le contexte est synchronisé avec la base. Comme l&#x27;indique le commentaire, l&#x27;insertion d&#x27;un des deux rendez-vous doit échouer à cause de la contrainte d&#x27;unicité sur la table [RVS]. Mais davantage que cela, si la synchronisation se passe dans une transaction, tout doit être défait. Donc aucune insertion ne doit avoir lieu. La base doit rester vide ;</li>
<li>ligne 53 : le contexte est fermé ;</li>
<li>lignes 61-90 : affichage du contenu de la base. Elle doit être vide.</li>
</ul>
<p>L&#x27;affichage écran est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a>Erreur : System.Data.Entity.Infrastructure.DbUpdateException: Une erreur s&#39;est produite lors de la mise à jour des entrées. Pour plus d&#39;informations, consultezl&#39;exception interne. ---&gt; System.Data.UpdateException: Une erreur s&#39;est produite lors de la mise à jour des entrées. Pour plus d&#39;informations, consultez l&#39;exception interne. ---&gt; System.Data.SqlClient.SqlException: Violation de la contrainte UNIQUE KEY « RVS_uq ». Impossible d&#39;insérer une clé en double dans l&#39;objet « dbo.RVS ». Valeur de clé dupliquée : (oct 18 2012 12:00AM, 34).
<a id="__codelineno-81-2" name="__codelineno-81-2"></a>L&#39;instruction a été arrêtée.
<a id="__codelineno-81-3" name="__codelineno-81-3"></a>   à System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
<a id="__codelineno-81-4" name="__codelineno-81-4"></a>   à System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)...
<a id="__codelineno-81-5" name="__codelineno-81-5"></a>   --- Fin de la trace de la pile d&#39;exception interne ---
<a id="__codelineno-81-6" name="__codelineno-81-6"></a>   ...
<a id="__codelineno-81-7" name="__codelineno-81-7"></a>   à System.Data.Entity.DbContext.SaveChanges()
<a id="__codelineno-81-8" name="__codelineno-81-8"></a>   à RdvMedecins_01.SynchronisationTransaction.Main(String[] args) dans d:\data\istia-1213\c#\dvp\Entity Framework\RdvMedecins\RdvMedecins-SqlServer-01\SynchronisationTransaction.cs:ligne 59
<a id="__codelineno-81-9" name="__codelineno-81-9"></a>Clients--------------------------------------
<a id="__codelineno-81-10" name="__codelineno-81-10"></a>Médecins--------------------------------------
<a id="__codelineno-81-11" name="__codelineno-81-11"></a>Créneaux horaires--------------------------------------
<a id="__codelineno-81-12" name="__codelineno-81-12"></a>Rendez-vous--------------------------------------
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : exception due à la violation de la contrainte d&#x27;unicité sur la table [RVS] ;</li>
<li>lignes 9-12 : la base est bien vide. La synchronisation du contexte avec la base s&#x27;est donc passée dans une transaction.</li>
</ul>
<p>Il y aurait sans doute d&#x27;autres choses à explorer dans EF 5. Mais nous en savons assez pour revenir sur notre étude d&#x27;une architecture multi-couche. Le lecteur trouvera au début de ce document des références d&#x27;articles et de livres lui permettant d&#x27;approfondir sa connaissance de EF 5.</p>
<h2 id="36-etude-dune-architecture-multi-couche-sappuyant-sur-ef-5">3.6. Etude d&#x27;une architecture multi-couche s&#x27;appuyant sur EF 5</h2>
<p>Nous revenons à notre étude de cas décrite au paragraphe 2. Il s&#x27;agit d&#x27;une application web ASP.NET structurée comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005EE0000011D31285E16.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.38cm;" /></td></tr></table>

<p>Nous allons commencer par construire la couche [DAO] d&#x27;accès aux données. Cette couche s&#x27;appuiera sur EF5.</p>
<h3 id="361-le-nouveau-projet">3.6.1. Le nouveau projet</h3>
<p>Nous créons un nouveau projet console VS 2012 [RdvMedecins-SqlServer-02] dans la solution courante [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005320000015E4686C70B.png" style="display:inline-block; margin:4px;width:17.595cm;height:4.63cm;" /></td></tr></table>

<p>Nous lui ajoutons quatre dossiers [2] dans lesquels nous allons répartir nos codes. Le dossier [Entites] est une recopie du dossier [Entites] du projet précédent. Après cette recopie, apparaissent des erreurs dues au fait que nous n&#x27;avons pas les bonnes références. Il nous faut ajouter une référence à Entity Framework 5. On suivra pour cela, la méthode expliquée au paragraphe 3.4, page 20. La liste des références devient la suivante [3] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>3</b></p><img src="images/10000000000000D8000000864ECE9850.png" style="display:inline-block; margin:4px;width:4.001cm;height:2.48cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>A ce stade, le projet ne doit plus présenter d&#x27;erreurs de compilation. Du projet précédent, nous recopions également le fichier [App.config] qui configure la connexion à la base de données :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-82-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-82-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-82-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-82-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-82-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-82-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-82-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-82-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-82-10">10</a></span>
<span class="normal"><a href="#__codelineno-82-11">11</a></span>
<span class="normal"><a href="#__codelineno-82-12">12</a></span>
<span class="normal"><a href="#__codelineno-82-13">13</a></span>
<span class="normal"><a href="#__codelineno-82-14">14</a></span>
<span class="normal"><a href="#__codelineno-82-15">15</a></span>
<span class="normal"><a href="#__codelineno-82-16">16</a></span>
<span class="normal"><a href="#__codelineno-82-17">17</a></span>
<span class="normal"><a href="#__codelineno-82-18">18</a></span>
<span class="normal"><a href="#__codelineno-82-19">19</a></span>
<span class="normal"><a href="#__codelineno-82-20">20</a></span>
<span class="normal"><a href="#__codelineno-82-21">21</a></span>
<span class="normal"><a href="#__codelineno-82-22">22</a></span>
<span class="normal"><a href="#__codelineno-82-23">23</a></span>
<span class="normal"><a href="#__codelineno-82-24">24</a></span>
<span class="normal"><a href="#__codelineno-82-25">25</a></span>
<span class="normal"><a href="#__codelineno-82-26">26</a></span>
<span class="normal"><a href="#__codelineno-82-27">27</a></span>
<span class="normal"><a href="#__codelineno-82-28">28</a></span>
<span class="normal"><a href="#__codelineno-82-29">29</a></span>
<span class="normal"><a href="#__codelineno-82-30">30</a></span>
<span class="normal"><a href="#__codelineno-82-31">31</a></span>
<span class="normal"><a href="#__codelineno-82-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-82-2" name="__codelineno-82-2"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-82-3" name="__codelineno-82-3"></a><span class="w">  </span><span class="nt">&lt;configSections&gt;</span>
<a id="__codelineno-82-4" name="__codelineno-82-4"></a><span class="w">    </span><span class="cm">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
<a id="__codelineno-82-5" name="__codelineno-82-5"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span><span class="w"> </span><span class="na">requirePermission=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-82-6" name="__codelineno-82-6"></a><span class="w">  </span><span class="nt">&lt;/configSections&gt;</span>
<a id="__codelineno-82-7" name="__codelineno-82-7"></a><span class="w">  </span><span class="nt">&lt;startup&gt;</span>
<a id="__codelineno-82-8" name="__codelineno-82-8"></a><span class="w">    </span><span class="nt">&lt;supportedRuntime</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;v4.0&quot;</span><span class="w"> </span><span class="na">sku=</span><span class="s">&quot;.NETFramework,Version=v4.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-82-9" name="__codelineno-82-9"></a><span class="w">  </span><span class="nt">&lt;/startup&gt;</span>
<a id="__codelineno-82-10" name="__codelineno-82-10"></a><span class="w">  </span><span class="nt">&lt;entityFramework&gt;</span>
<a id="__codelineno-82-11" name="__codelineno-82-11"></a><span class="w">    </span><span class="nt">&lt;defaultConnectionFactory</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-82-12" name="__codelineno-82-12"></a><span class="w">  </span><span class="nt">&lt;/entityFramework&gt;</span>
<a id="__codelineno-82-13" name="__codelineno-82-13"></a>
<a id="__codelineno-82-14" name="__codelineno-82-14"></a><span class="w">  </span><span class="cm">&lt;!-- chaîne de connexion sur la base --&gt;</span>
<a id="__codelineno-82-15" name="__codelineno-82-15"></a><span class="w">  </span><span class="nt">&lt;connectionStrings&gt;</span>
<a id="__codelineno-82-16" name="__codelineno-82-16"></a><span class="w">    </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;monContexte&quot;</span>
<a id="__codelineno-82-17" name="__codelineno-82-17"></a><span class="w">         </span><span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=rdvmedecins-ef;User Id=sa;Password=sqlserver2012;&quot;</span>
<a id="__codelineno-82-18" name="__codelineno-82-18"></a><span class="w">         </span><span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-82-19" name="__codelineno-82-19"></a><span class="w">  </span><span class="nt">&lt;/connectionStrings&gt;</span>
<a id="__codelineno-82-20" name="__codelineno-82-20"></a><span class="w">  </span><span class="cm">&lt;!-- le factory provider --&gt;</span>
<a id="__codelineno-82-21" name="__codelineno-82-21"></a><span class="w">  </span><span class="nt">&lt;system.data&gt;</span>
<a id="__codelineno-82-22" name="__codelineno-82-22"></a><span class="w">    </span><span class="nt">&lt;DbProviderFactories&gt;</span>
<a id="__codelineno-82-23" name="__codelineno-82-23"></a><span class="w">      </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SqlClient Data Provider&quot;</span>
<a id="__codelineno-82-24" name="__codelineno-82-24"></a><span class="w">       </span><span class="na">invariant=</span><span class="s">&quot;System.Data.SqlClient&quot;</span>
<a id="__codelineno-82-25" name="__codelineno-82-25"></a><span class="w">       </span><span class="na">description=</span><span class="s">&quot;.Net Framework Data Provider for SqlServer&quot;</span>
<a id="__codelineno-82-26" name="__codelineno-82-26"></a><span class="w">       </span><span class="na">type=</span><span class="s">&quot;System.Data.SqlClient.SqlClientFactory, System.Data,</span>
<a id="__codelineno-82-27" name="__codelineno-82-27"></a><span class="s">     Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span>
<a id="__codelineno-82-28" name="__codelineno-82-28"></a><span class="w">    </span><span class="nt">/&gt;</span>
<a id="__codelineno-82-29" name="__codelineno-82-29"></a><span class="w">    </span><span class="nt">&lt;/DbProviderFactories&gt;</span>
<a id="__codelineno-82-30" name="__codelineno-82-30"></a><span class="w">  </span><span class="nt">&lt;/system.data&gt;</span>
<a id="__codelineno-82-31" name="__codelineno-82-31"></a>
<a id="__codelineno-82-32" name="__codelineno-82-32"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<h3 id="362-la-classe-exception">3.6.2. La classe Exception</h3>
<p>Nous allons utiliser une classe d&#x27;exception propre au projet. C&#x27;est celle qui sortira de la couche [DAO] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005EC000001AE4346C234.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.105cm;" /></td></tr></table>

<p>La couche [DAO] arrêtera toutes les exceptions qui remonteront jusqu&#x27;à elles et les encapsulera dans une exception de type [RdvMedecinsException]. Cette exception sera la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span>
<span class="normal"><a href="#__codelineno-83-11">11</a></span>
<span class="normal"><a href="#__codelineno-83-12">12</a></span>
<span class="normal"><a href="#__codelineno-83-13">13</a></span>
<span class="normal"><a href="#__codelineno-83-14">14</a></span>
<span class="normal"><a href="#__codelineno-83-15">15</a></span>
<span class="normal"><a href="#__codelineno-83-16">16</a></span>
<span class="normal"><a href="#__codelineno-83-17">17</a></span>
<span class="normal"><a href="#__codelineno-83-18">18</a></span>
<span class="normal"><a href="#__codelineno-83-19">19</a></span>
<span class="normal"><a href="#__codelineno-83-20">20</a></span>
<span class="normal"><a href="#__codelineno-83-21">21</a></span>
<span class="normal"><a href="#__codelineno-83-22">22</a></span>
<span class="normal"><a href="#__codelineno-83-23">23</a></span>
<span class="normal"><a href="#__codelineno-83-24">24</a></span>
<span class="normal"><a href="#__codelineno-83-25">25</a></span>
<span class="normal"><a href="#__codelineno-83-26">26</a></span>
<span class="normal"><a href="#__codelineno-83-27">27</a></span>
<span class="normal"><a href="#__codelineno-83-28">28</a></span>
<span class="normal"><a href="#__codelineno-83-29">29</a></span>
<span class="normal"><a href="#__codelineno-83-30">30</a></span>
<span class="normal"><a href="#__codelineno-83-31">31</a></span>
<span class="normal"><a href="#__codelineno-83-32">32</a></span>
<span class="normal"><a href="#__codelineno-83-33">33</a></span>
<span class="normal"><a href="#__codelineno-83-34">34</a></span>
<span class="normal"><a href="#__codelineno-83-35">35</a></span>
<span class="normal"><a href="#__codelineno-83-36">36</a></span>
<span class="normal"><a href="#__codelineno-83-37">37</a></span>
<span class="normal"><a href="#__codelineno-83-38">38</a></span>
<span class="normal"><a href="#__codelineno-83-39">39</a></span>
<span class="normal"><a href="#__codelineno-83-40">40</a></span>
<span class="normal"><a href="#__codelineno-83-41">41</a></span>
<span class="normal"><a href="#__codelineno-83-42">42</a></span>
<span class="normal"><a href="#__codelineno-83-43">43</a></span>
<span class="normal"><a href="#__codelineno-83-44">44</a></span>
<span class="normal"><a href="#__codelineno-83-45">45</a></span>
<span class="normal"><a href="#__codelineno-83-46">46</a></span>
<span class="normal"><a href="#__codelineno-83-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-83-2" name="__codelineno-83-2"></a>
<a id="__codelineno-83-3" name="__codelineno-83-3"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Exceptions</span>
<a id="__codelineno-83-4" name="__codelineno-83-4"></a><span class="p">{</span>
<a id="__codelineno-83-5" name="__codelineno-83-5"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">RdvMedecinsException</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span>
<a id="__codelineno-83-6" name="__codelineno-83-6"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-83-7" name="__codelineno-83-7"></a>
<a id="__codelineno-83-8" name="__codelineno-83-8"></a><span class="w">    </span><span class="c1">// propriétés</span>
<a id="__codelineno-83-9" name="__codelineno-83-9"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-83-10" name="__codelineno-83-10"></a>
<a id="__codelineno-83-11" name="__codelineno-83-11"></a><span class="w">    </span><span class="c1">// constructeurs</span>
<a id="__codelineno-83-12" name="__codelineno-83-12"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">()</span>
<a id="__codelineno-83-13" name="__codelineno-83-13"></a><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">()</span>
<a id="__codelineno-83-14" name="__codelineno-83-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-83-15" name="__codelineno-83-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-83-16" name="__codelineno-83-16"></a>
<a id="__codelineno-83-17" name="__codelineno-83-17"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-83-18" name="__codelineno-83-18"></a><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-83-19" name="__codelineno-83-19"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-83-20" name="__codelineno-83-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-83-21" name="__codelineno-83-21"></a>
<a id="__codelineno-83-22" name="__codelineno-83-22"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-83-23" name="__codelineno-83-23"></a><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-83-24" name="__codelineno-83-24"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-83-25" name="__codelineno-83-25"></a><span class="w">      </span><span class="n">Code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<a id="__codelineno-83-26" name="__codelineno-83-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-83-27" name="__codelineno-83-27"></a>
<a id="__codelineno-83-28" name="__codelineno-83-28"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-83-29" name="__codelineno-83-29"></a><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-83-30" name="__codelineno-83-30"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-83-31" name="__codelineno-83-31"></a><span class="w">      </span><span class="n">Code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<a id="__codelineno-83-32" name="__codelineno-83-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-83-33" name="__codelineno-83-33"></a>
<a id="__codelineno-83-34" name="__codelineno-83-34"></a><span class="w">    </span><span class="c1">// identité</span>
<a id="__codelineno-83-35" name="__codelineno-83-35"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span>
<a id="__codelineno-83-36" name="__codelineno-83-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-83-37" name="__codelineno-83-37"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InnerException</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-83-38" name="__codelineno-83-38"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-83-39" name="__codelineno-83-39"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;RdvMedecinsException[{0},{1}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="k">base</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<a id="__codelineno-83-40" name="__codelineno-83-40"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-83-41" name="__codelineno-83-41"></a><span class="w">      </span><span class="k">else</span>
<a id="__codelineno-83-42" name="__codelineno-83-42"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-83-43" name="__codelineno-83-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;RdvMedecinsException[{0},{1},{2}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">,</span><span class="w"> </span><span class="k">base</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span><span class="w"> </span><span class="k">base</span><span class="p">.</span><span class="n">InnerException</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<a id="__codelineno-83-44" name="__codelineno-83-44"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-83-45" name="__codelineno-83-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-83-46" name="__codelineno-83-46"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-83-47" name="__codelineno-83-47"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 5 : la classe dérive de la classe [Exception] ;</li>
<li>ligne 9 : elle ajoute à sa classe de base un code d&#x27;erreur ;</li>
<li>lignes 12-32 : les différents constructeurs intègrent la présence du champ [Code].</li>
</ul>
<p>Le projet évolue comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001BE00000155E26225E6.png" style="display:inline-block; margin:4px;width:5.9cm;height:4.512cm;" /></td></tr></table>

<h3 id="363-la-couche-dao">3.6.3. La couche [DAO]</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F00000011DB5528856.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.374cm;" /></td></tr></table>

<p>La couche [DAO] offre une interface à la couche [ASP.NET]. Pour identifier celle-ci, il faut regarder les pages web de l&#x27;application :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006490000037B2FA71C0A.png" style="display:inline-block; margin:4px;width:17.999cm;height:9.966cm;" /></td></tr></table>

<ul>
<li>en [1] ci-dessus, la liste déroulante a été remplie avec la liste des médecins. La couche [DAO] fournira cette liste ;</li>
<li>en [2], la couche [DAO] fournira ;</li>
<li>la liste des rendez-vous d&#x27;un médecin pour tel jour,</li>
<li>la liste des créneaux horaires d&#x27;un médecin,</li>
<li>des informations complémentaires sur le médecin sélectionné ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000006420000024EBE1D0B3B.png" style="display:inline-block; margin:4px;width:17.999cm;height:6.629cm;" /></td></tr></table>

<ul>
<li>en [3], la liste déroulante des clients sera fournie par la couche [DAO] ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000646000002A8B9C88291.png" style="display:inline-block; margin:4px;width:17.999cm;height:7.62cm;" /></td></tr></table>

<ul>
<li>en [4], l&#x27;utilisateur valide un rendez-vous. La couche [DAO] doit pouvoir l&#x27;ajouter à la base. Elle doit pouvoir également donner des informations complémentaires sur le client sélectionné ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000646000002E1D5D3F8DA.png" style="display:inline-block; margin:4px;width:17.999cm;height:8.26cm;" /></td></tr></table>

<ul>
<li>en [5], l&#x27;utilisateur supprime un rendez-vous. La couche [DAO] doit permettre cela.</li>
</ul>
<p>Avec ces informations, l&#x27;interface [IDao] de la couche [DAO] pourrait être la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span>
<span class="normal"><a href="#__codelineno-84-18">18</a></span>
<span class="normal"><a href="#__codelineno-84-19">19</a></span>
<span class="normal"><a href="#__codelineno-84-20">20</a></span>
<span class="normal"><a href="#__codelineno-84-21">21</a></span>
<span class="normal"><a href="#__codelineno-84-22">22</a></span>
<span class="normal"><a href="#__codelineno-84-23">23</a></span>
<span class="normal"><a href="#__codelineno-84-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a id="__codelineno-84-3" name="__codelineno-84-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-84-4" name="__codelineno-84-4"></a>
<a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Dao</span>
<a id="__codelineno-84-6" name="__codelineno-84-6"></a><span class="p">{</span>
<a id="__codelineno-84-7" name="__codelineno-84-7"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">interface</span><span class="w"> </span><span class="n">IDao</span>
<a id="__codelineno-84-8" name="__codelineno-84-8"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-84-9" name="__codelineno-84-9"></a><span class="w">    </span><span class="c1">// liste des clients</span>
<a id="__codelineno-84-10" name="__codelineno-84-10"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllClients</span><span class="p">();</span>
<a id="__codelineno-84-11" name="__codelineno-84-11"></a><span class="w">    </span><span class="c1">// liste des médecins</span>
<a id="__codelineno-84-12" name="__codelineno-84-12"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllMedecins</span><span class="p">();</span>
<a id="__codelineno-84-13" name="__codelineno-84-13"></a><span class="w">    </span><span class="c1">// liste des créneaux horaires d&#39;un médecin</span>
<a id="__codelineno-84-14" name="__codelineno-84-14"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetCreneauxMedecin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">);</span>
<a id="__codelineno-84-15" name="__codelineno-84-15"></a><span class="w">    </span><span class="c1">// liste des RV d&#39;un médecin donné, un jour donné</span>
<a id="__codelineno-84-16" name="__codelineno-84-16"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetRvMedecinJour</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">);</span>
<a id="__codelineno-84-17" name="__codelineno-84-17"></a><span class="w">    </span><span class="c1">// ajouter un RV</span>
<a id="__codelineno-84-18" name="__codelineno-84-18"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">AjouterRv</span><span class="p">(</span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idClient</span><span class="p">);</span>
<a id="__codelineno-84-19" name="__codelineno-84-19"></a><span class="w">    </span><span class="c1">// supprimer un RV</span>
<a id="__codelineno-84-20" name="__codelineno-84-20"></a><span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">SupprimerRv</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idRv</span><span class="p">);</span>
<a id="__codelineno-84-21" name="__codelineno-84-21"></a><span class="w">    </span><span class="c1">// trouver une entité T via sa clé primaire</span>
<a id="__codelineno-84-22" name="__codelineno-84-22"></a><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">Find</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">class</span><span class="p">;</span>
<a id="__codelineno-84-23" name="__codelineno-84-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-84-24" name="__codelineno-84-24"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Les méthodes des lignes 10-20 découlent de l&#x27;étude qui vient d&#x27;être faite. La méthodes de la ligne 22 est là pour remédier au fait qu&#x27;on travaille en <strong>Lazy Loading</strong>. Si dans la couche [ASP.NET] on a besoin d&#x27;une dépendance d&#x27;une entité, on ira la chercher en base avec cette méthode.</p>
<p>L&#x27;implémentation [Dao] de cette interface sera la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">  1</a></span>
<span class="normal"><a href="#__codelineno-85-2">  2</a></span>
<span class="normal"><a href="#__codelineno-85-3">  3</a></span>
<span class="normal"><a href="#__codelineno-85-4">  4</a></span>
<span class="normal"><a href="#__codelineno-85-5">  5</a></span>
<span class="normal"><a href="#__codelineno-85-6">  6</a></span>
<span class="normal"><a href="#__codelineno-85-7">  7</a></span>
<span class="normal"><a href="#__codelineno-85-8">  8</a></span>
<span class="normal"><a href="#__codelineno-85-9">  9</a></span>
<span class="normal"><a href="#__codelineno-85-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-85-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-85-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-85-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-85-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-85-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-85-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-85-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-85-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-85-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-85-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-85-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-85-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-85-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-85-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-85-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-85-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-85-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-85-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-85-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-85-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-85-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-85-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-85-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-85-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-85-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-85-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-85-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-85-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-85-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-85-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-85-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-85-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-85-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-85-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-85-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-85-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-85-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-85-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-85-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-85-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-85-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-85-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-85-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-85-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-85-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-85-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-85-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-85-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-85-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-85-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-85-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-85-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-85-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-85-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-85-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-85-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-85-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-85-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-85-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-85-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-85-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-85-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-85-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-85-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-85-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-85-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-85-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-85-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-85-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-85-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-85-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-85-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-85-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-85-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-85-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-85-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-85-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-85-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-85-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-85-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-85-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-85-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-85-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-85-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-85-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-85-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-85-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-85-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-85-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-85-100">100</a></span>
<span class="normal"><a href="#__codelineno-85-101">101</a></span>
<span class="normal"><a href="#__codelineno-85-102">102</a></span>
<span class="normal"><a href="#__codelineno-85-103">103</a></span>
<span class="normal"><a href="#__codelineno-85-104">104</a></span>
<span class="normal"><a href="#__codelineno-85-105">105</a></span>
<span class="normal"><a href="#__codelineno-85-106">106</a></span>
<span class="normal"><a href="#__codelineno-85-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a id="__codelineno-85-3" name="__codelineno-85-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-85-5" name="__codelineno-85-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Exceptions</span><span class="p">;</span>
<a id="__codelineno-85-6" name="__codelineno-85-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Models</span><span class="p">;</span>
<a id="__codelineno-85-7" name="__codelineno-85-7"></a>
<a id="__codelineno-85-8" name="__codelineno-85-8"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Dao</span>
<a id="__codelineno-85-9" name="__codelineno-85-9"></a><span class="p">{</span>
<a id="__codelineno-85-10" name="__codelineno-85-10"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Dao</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IDao</span>
<a id="__codelineno-85-11" name="__codelineno-85-11"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-85-12" name="__codelineno-85-12"></a>
<a id="__codelineno-85-13" name="__codelineno-85-13"></a><span class="w">    </span><span class="c1">//liste des clients</span>
<a id="__codelineno-85-14" name="__codelineno-85-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllClients</span><span class="p">()</span>
<a id="__codelineno-85-15" name="__codelineno-85-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-16" name="__codelineno-85-16"></a><span class="w">      </span><span class="c1">// liste des clients</span>
<a id="__codelineno-85-17" name="__codelineno-85-17"></a><span class="w">      </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<a id="__codelineno-85-18" name="__codelineno-85-18"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-85-19" name="__codelineno-85-19"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-85-20" name="__codelineno-85-20"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-85-21" name="__codelineno-85-21"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-85-22" name="__codelineno-85-22"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-85-23" name="__codelineno-85-23"></a><span class="w">          </span><span class="c1">// liste des clients</span>
<a id="__codelineno-85-24" name="__codelineno-85-24"></a><span class="w">          </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
<a id="__codelineno-85-25" name="__codelineno-85-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-85-26" name="__codelineno-85-26"></a>
<a id="__codelineno-85-27" name="__codelineno-85-27"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-85-28" name="__codelineno-85-28"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-85-29" name="__codelineno-85-29"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-85-30" name="__codelineno-85-30"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GetAllClients&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-85-31" name="__codelineno-85-31"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-85-32" name="__codelineno-85-32"></a><span class="w">      </span><span class="c1">// on rend le résultat</span>
<a id="__codelineno-85-33" name="__codelineno-85-33"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">clients</span><span class="p">;</span>
<a id="__codelineno-85-34" name="__codelineno-85-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-35" name="__codelineno-85-35"></a>
<a id="__codelineno-85-36" name="__codelineno-85-36"></a><span class="w">    </span><span class="c1">// liste des médecins</span>
<a id="__codelineno-85-37" name="__codelineno-85-37"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllMedecins</span><span class="p">()</span>
<a id="__codelineno-85-38" name="__codelineno-85-38"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-39" name="__codelineno-85-39"></a><span class="w">      </span><span class="c1">// liste des médecins</span>
<a id="__codelineno-85-40" name="__codelineno-85-40"></a><span class="w">      </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<a id="__codelineno-85-41" name="__codelineno-85-41"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-85-42" name="__codelineno-85-42"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-85-43" name="__codelineno-85-43"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-85-44" name="__codelineno-85-44"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-85-45" name="__codelineno-85-45"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-85-46" name="__codelineno-85-46"></a><span class="w">          </span><span class="c1">// liste des médecins</span>
<a id="__codelineno-85-47" name="__codelineno-85-47"></a><span class="w">          </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
<a id="__codelineno-85-48" name="__codelineno-85-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-85-49" name="__codelineno-85-49"></a>
<a id="__codelineno-85-50" name="__codelineno-85-50"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-85-51" name="__codelineno-85-51"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-85-52" name="__codelineno-85-52"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-85-53" name="__codelineno-85-53"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GetAllMedecins&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-85-54" name="__codelineno-85-54"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-85-55" name="__codelineno-85-55"></a><span class="w">      </span><span class="c1">// on rend le résultat</span>
<a id="__codelineno-85-56" name="__codelineno-85-56"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">medecins</span><span class="p">;</span>
<a id="__codelineno-85-57" name="__codelineno-85-57"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-58" name="__codelineno-85-58"></a>
<a id="__codelineno-85-59" name="__codelineno-85-59"></a><span class="w">    </span><span class="c1">// liste des créneaux horaires d&#39;un médecin donné</span>
<a id="__codelineno-85-60" name="__codelineno-85-60"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetCreneauxMedecin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">)</span>
<a id="__codelineno-85-61" name="__codelineno-85-61"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-62" name="__codelineno-85-62"></a><span class="w">   </span><span class="p">...</span>
<a id="__codelineno-85-63" name="__codelineno-85-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-64" name="__codelineno-85-64"></a>
<a id="__codelineno-85-65" name="__codelineno-85-65"></a><span class="w">    </span><span class="c1">// liste des RV d&#39;un médecin pour un jour donné</span>
<a id="__codelineno-85-66" name="__codelineno-85-66"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetRvMedecinJour</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">)</span>
<a id="__codelineno-85-67" name="__codelineno-85-67"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-68" name="__codelineno-85-68"></a><span class="w"> </span><span class="p">...</span>
<a id="__codelineno-85-69" name="__codelineno-85-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-70" name="__codelineno-85-70"></a>
<a id="__codelineno-85-71" name="__codelineno-85-71"></a><span class="w">    </span><span class="c1">// ajouter un RV</span>
<a id="__codelineno-85-72" name="__codelineno-85-72"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">AjouterRv</span><span class="p">(</span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idClient</span><span class="p">)</span>
<a id="__codelineno-85-73" name="__codelineno-85-73"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-74" name="__codelineno-85-74"></a><span class="w"> </span><span class="p">...</span>
<a id="__codelineno-85-75" name="__codelineno-85-75"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-76" name="__codelineno-85-76"></a>
<a id="__codelineno-85-77" name="__codelineno-85-77"></a><span class="w">    </span><span class="c1">// supprimer un RV</span>
<a id="__codelineno-85-78" name="__codelineno-85-78"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SupprimerRv</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idRv</span><span class="p">)</span>
<a id="__codelineno-85-79" name="__codelineno-85-79"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-80" name="__codelineno-85-80"></a><span class="p">...</span>
<a id="__codelineno-85-81" name="__codelineno-85-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-82" name="__codelineno-85-82"></a>
<a id="__codelineno-85-83" name="__codelineno-85-83"></a><span class="w">    </span><span class="c1">// trouver un client</span>
<a id="__codelineno-85-84" name="__codelineno-85-84"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="nf">FindClient</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-85-85" name="__codelineno-85-85"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-86" name="__codelineno-85-86"></a><span class="p">...</span>
<a id="__codelineno-85-87" name="__codelineno-85-87"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-88" name="__codelineno-85-88"></a>
<a id="__codelineno-85-89" name="__codelineno-85-89"></a><span class="w">    </span><span class="c1">// trouver un créneau</span>
<a id="__codelineno-85-90" name="__codelineno-85-90"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="nf">FindCreneau</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-85-91" name="__codelineno-85-91"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-92" name="__codelineno-85-92"></a><span class="w"> </span><span class="p">...</span>
<a id="__codelineno-85-93" name="__codelineno-85-93"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-94" name="__codelineno-85-94"></a>
<a id="__codelineno-85-95" name="__codelineno-85-95"></a><span class="w">    </span><span class="c1">// trouver un médecin</span>
<a id="__codelineno-85-96" name="__codelineno-85-96"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Medecin</span><span class="w"> </span><span class="nf">FindMedecin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-85-97" name="__codelineno-85-97"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-85-98" name="__codelineno-85-98"></a><span class="p">....</span>
<a id="__codelineno-85-99" name="__codelineno-85-99"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-100" name="__codelineno-85-100"></a>
<a id="__codelineno-85-101" name="__codelineno-85-101"></a><span class="w">    </span><span class="c1">// trouver un Rv</span>
<a id="__codelineno-85-102" name="__codelineno-85-102"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="nf">FindRv</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">){</span>
<a id="__codelineno-85-103" name="__codelineno-85-103"></a><span class="p">...</span>
<a id="__codelineno-85-104" name="__codelineno-85-104"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-85-105" name="__codelineno-85-105"></a>
<a id="__codelineno-85-106" name="__codelineno-85-106"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-85-107" name="__codelineno-85-107"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Explicitons la méthode [GetAllClients] qui doit rendre la liste de tous les clients :</p>
<ul>
<li>lignes 18-31 : la recherche des clients se fait dans un try / catch. Il en sera de même de toutes les méthodes à suivre ;</li>
<li>ligne 21 : ouverture d&#x27;un nouveau contexte ;</li>
<li>ligne 24 : les entités [Client] sont chargées dans le contexte et mises dans une liste.</li>
</ul>
<p>La méthode [GetAllMedecins] qui doit rendre la liste de tous les médecins est analogue (lignes 37-57).</p>
<p>La méthode [GetCreneauxMedecin] est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-86-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-86-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-86-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-86-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-86-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-86-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-86-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-86-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-86-10">10</a></span>
<span class="normal"><a href="#__codelineno-86-11">11</a></span>
<span class="normal"><a href="#__codelineno-86-12">12</a></span>
<span class="normal"><a href="#__codelineno-86-13">13</a></span>
<span class="normal"><a href="#__codelineno-86-14">14</a></span>
<span class="normal"><a href="#__codelineno-86-15">15</a></span>
<span class="normal"><a href="#__codelineno-86-16">16</a></span>
<span class="normal"><a href="#__codelineno-86-17">17</a></span>
<span class="normal"><a href="#__codelineno-86-18">18</a></span>
<span class="normal"><a href="#__codelineno-86-19">19</a></span>
<span class="normal"><a href="#__codelineno-86-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="c1">// liste des créneaux horaires d&#39;un médecin donné</span>
<a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetCreneauxMedecin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">)</span>
<a id="__codelineno-86-3" name="__codelineno-86-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="w">      </span><span class="c1">// liste des créneaux</span>
<a id="__codelineno-86-5" name="__codelineno-86-5"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-86-6" name="__codelineno-86-6"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-86-7" name="__codelineno-86-7"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-86-8" name="__codelineno-86-8"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-86-9" name="__codelineno-86-9"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-86-10" name="__codelineno-86-10"></a><span class="w">          </span><span class="c1">// on récupère le médecin avec ses créneaux</span>
<a id="__codelineno-86-11" name="__codelineno-86-11"></a><span class="w">          </span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="s">&quot;Creneaux&quot;</span><span class="p">).</span><span class="n">Single</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">);</span>
<a id="__codelineno-86-12" name="__codelineno-86-12"></a><span class="w">          </span><span class="c1">// liste des créneaux du médecin</span>
<a id="__codelineno-86-13" name="__codelineno-86-13"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">medecin</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">ToList</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-86-14" name="__codelineno-86-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-86-15" name="__codelineno-86-15"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-86-16" name="__codelineno-86-16"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-86-17" name="__codelineno-86-17"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-86-18" name="__codelineno-86-18"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GetCreneauxMedecin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-86-19" name="__codelineno-86-19"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-86-20" name="__codelineno-86-20"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : ouverture d&#x27;un nouveau contexte de persistance ;</li>
<li>ligne 11 : on recherche le médecin dont on a la clé primaire. On demande d&#x27;y inclure la dépendance [Creneaux] qui est une collection des créneaux du médecin. Si le médecin n&#x27;existe pas, la méthode <strong>Single</strong> lance une exception ;</li>
<li>ligne 13 : on rend la liste des créneaux.</li>
</ul>
<p>La méthode [GetRvMedecinJour] doit rendre la liste des rendez-vous d&#x27;un médecin pour un jour donné. Son code pourrait être le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-87-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-87-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-87-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-87-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-87-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-87-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-87-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-87-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-87-10">10</a></span>
<span class="normal"><a href="#__codelineno-87-11">11</a></span>
<span class="normal"><a href="#__codelineno-87-12">12</a></span>
<span class="normal"><a href="#__codelineno-87-13">13</a></span>
<span class="normal"><a href="#__codelineno-87-14">14</a></span>
<span class="normal"><a href="#__codelineno-87-15">15</a></span>
<span class="normal"><a href="#__codelineno-87-16">16</a></span>
<span class="normal"><a href="#__codelineno-87-17">17</a></span>
<span class="normal"><a href="#__codelineno-87-18">18</a></span>
<span class="normal"><a href="#__codelineno-87-19">19</a></span>
<span class="normal"><a href="#__codelineno-87-20">20</a></span>
<span class="normal"><a href="#__codelineno-87-21">21</a></span>
<span class="normal"><a href="#__codelineno-87-22">22</a></span>
<span class="normal"><a href="#__codelineno-87-23">23</a></span>
<span class="normal"><a href="#__codelineno-87-24">24</a></span>
<span class="normal"><a href="#__codelineno-87-25">25</a></span>
<span class="normal"><a href="#__codelineno-87-26">26</a></span>
<span class="normal"><a href="#__codelineno-87-27">27</a></span>
<span class="normal"><a href="#__codelineno-87-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1"></a><span class="c1">// liste des RV d&#39;un médecin pour un jour donné</span>
<a id="__codelineno-87-2" name="__codelineno-87-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetRvMedecinJour</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">)</span>
<a id="__codelineno-87-3" name="__codelineno-87-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-87-4" name="__codelineno-87-4"></a><span class="w">      </span><span class="c1">// liste des Rv</span>
<a id="__codelineno-87-5" name="__codelineno-87-5"></a><span class="w">      </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<a id="__codelineno-87-6" name="__codelineno-87-6"></a>
<a id="__codelineno-87-7" name="__codelineno-87-7"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-87-8" name="__codelineno-87-8"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-87-9" name="__codelineno-87-9"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-87-10" name="__codelineno-87-10"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-87-11" name="__codelineno-87-11"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-87-12" name="__codelineno-87-12"></a><span class="w">          </span><span class="c1">// on récupère le médecin</span>
<a id="__codelineno-87-13" name="__codelineno-87-13"></a><span class="w">          </span><span class="n">Medecin</span><span class="w"> </span><span class="n">medecin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Medecins</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">idMedecin</span><span class="p">);</span>
<a id="__codelineno-87-14" name="__codelineno-87-14"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">medecin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-87-15" name="__codelineno-87-15"></a><span class="w">          </span><span class="p">{</span>
<a id="__codelineno-87-16" name="__codelineno-87-16"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Médecin [{0}] inexistant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">));</span>
<a id="__codelineno-87-17" name="__codelineno-87-17"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-87-18" name="__codelineno-87-18"></a><span class="w">          </span><span class="c1">// liste des rv</span>
<a id="__codelineno-87-19" name="__codelineno-87-19"></a><span class="w">          </span><span class="n">rvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">Creneau</span><span class="p">.</span><span class="n">Medecin</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idMedecin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">Jour</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">jour</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
<a id="__codelineno-87-20" name="__codelineno-87-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-87-21" name="__codelineno-87-21"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-87-22" name="__codelineno-87-22"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-87-23" name="__codelineno-87-23"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-87-24" name="__codelineno-87-24"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GetRvMedecinJour&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-87-25" name="__codelineno-87-25"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-87-26" name="__codelineno-87-26"></a><span class="w">      </span><span class="c1">// on rend le résultat</span>
<a id="__codelineno-87-27" name="__codelineno-87-27"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">rvs</span><span class="p">;</span>
<a id="__codelineno-87-28" name="__codelineno-87-28"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 13 : on amène dans le contexte le médecin dont on a la clé primaire ;</li>
<li>lignes 14-17 : s&#x27;il n&#x27;existe pas, on lance une exception ;</li>
<li>ligne 19 : la requête LINQ pour récupérer les rendez-vous pour ce médecin ;</li>
</ul>
<p>La méthode [AjouterRv] doit ajouter un rendez-vous en base et doit rendre la clé primaire de l&#x27;élément inséré. Son code pourrait être le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-88-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-88-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-88-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-88-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-88-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-88-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-88-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-88-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-88-10">10</a></span>
<span class="normal"><a href="#__codelineno-88-11">11</a></span>
<span class="normal"><a href="#__codelineno-88-12">12</a></span>
<span class="normal"><a href="#__codelineno-88-13">13</a></span>
<span class="normal"><a href="#__codelineno-88-14">14</a></span>
<span class="normal"><a href="#__codelineno-88-15">15</a></span>
<span class="normal"><a href="#__codelineno-88-16">16</a></span>
<span class="normal"><a href="#__codelineno-88-17">17</a></span>
<span class="normal"><a href="#__codelineno-88-18">18</a></span>
<span class="normal"><a href="#__codelineno-88-19">19</a></span>
<span class="normal"><a href="#__codelineno-88-20">20</a></span>
<span class="normal"><a href="#__codelineno-88-21">21</a></span>
<span class="normal"><a href="#__codelineno-88-22">22</a></span>
<span class="normal"><a href="#__codelineno-88-23">23</a></span>
<span class="normal"><a href="#__codelineno-88-24">24</a></span>
<span class="normal"><a href="#__codelineno-88-25">25</a></span>
<span class="normal"><a href="#__codelineno-88-26">26</a></span>
<span class="normal"><a href="#__codelineno-88-27">27</a></span>
<span class="normal"><a href="#__codelineno-88-28">28</a></span>
<span class="normal"><a href="#__codelineno-88-29">29</a></span>
<span class="normal"><a href="#__codelineno-88-30">30</a></span>
<span class="normal"><a href="#__codelineno-88-31">31</a></span>
<span class="normal"><a href="#__codelineno-88-32">32</a></span>
<span class="normal"><a href="#__codelineno-88-33">33</a></span>
<span class="normal"><a href="#__codelineno-88-34">34</a></span>
<span class="normal"><a href="#__codelineno-88-35">35</a></span>
<span class="normal"><a href="#__codelineno-88-36">36</a></span>
<span class="normal"><a href="#__codelineno-88-37">37</a></span>
<span class="normal"><a href="#__codelineno-88-38">38</a></span>
<span class="normal"><a href="#__codelineno-88-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1"></a><span class="c1">// ajouter un RV</span>
<a id="__codelineno-88-2" name="__codelineno-88-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">AjouterRv</span><span class="p">(</span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idClient</span><span class="p">)</span>
<a id="__codelineno-88-3" name="__codelineno-88-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-88-4" name="__codelineno-88-4"></a><span class="w">      </span><span class="c1">// n° du Rdv ajouté</span>
<a id="__codelineno-88-5" name="__codelineno-88-5"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">idRv</span><span class="p">;</span>
<a id="__codelineno-88-6" name="__codelineno-88-6"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-88-7" name="__codelineno-88-7"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-88-8" name="__codelineno-88-8"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-88-9" name="__codelineno-88-9"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-88-10" name="__codelineno-88-10"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-88-11" name="__codelineno-88-11"></a><span class="w">          </span><span class="c1">// on récupère le créneau</span>
<a id="__codelineno-88-12" name="__codelineno-88-12"></a><span class="w">          </span><span class="n">Creneau</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">idCreneau</span><span class="p">);</span>
<a id="__codelineno-88-13" name="__codelineno-88-13"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">creneau</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-88-14" name="__codelineno-88-14"></a><span class="w">          </span><span class="p">{</span>
<a id="__codelineno-88-15" name="__codelineno-88-15"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Créneau [{0}] inexistant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">));</span>
<a id="__codelineno-88-16" name="__codelineno-88-16"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-88-17" name="__codelineno-88-17"></a><span class="w">          </span><span class="c1">// on récupère le client</span>
<a id="__codelineno-88-18" name="__codelineno-88-18"></a><span class="w">          </span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">idClient</span><span class="p">);</span>
<a id="__codelineno-88-19" name="__codelineno-88-19"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-88-20" name="__codelineno-88-20"></a><span class="w">          </span><span class="p">{</span>
<a id="__codelineno-88-21" name="__codelineno-88-21"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Client [{0}] inexistant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">));</span>
<a id="__codelineno-88-22" name="__codelineno-88-22"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-88-23" name="__codelineno-88-23"></a><span class="w">          </span><span class="c1">// création créneau</span>
<a id="__codelineno-88-24" name="__codelineno-88-24"></a><span class="w">          </span><span class="n">Rv</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Rv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Jour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jour</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">Creneau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">creneau</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-88-25" name="__codelineno-88-25"></a><span class="w">          </span><span class="c1">// ajout dans le contexte</span>
<a id="__codelineno-88-26" name="__codelineno-88-26"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
<a id="__codelineno-88-27" name="__codelineno-88-27"></a><span class="w">          </span><span class="c1">// sauvegarde du contexte</span>
<a id="__codelineno-88-28" name="__codelineno-88-28"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-88-29" name="__codelineno-88-29"></a><span class="w">          </span><span class="c1">// on récupère la clé primaire du rv ajouté</span>
<a id="__codelineno-88-30" name="__codelineno-88-30"></a><span class="w">          </span><span class="n">idRv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rv</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
<a id="__codelineno-88-31" name="__codelineno-88-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-88-32" name="__codelineno-88-32"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-88-33" name="__codelineno-88-33"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-88-34" name="__codelineno-88-34"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-88-35" name="__codelineno-88-35"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AjouterRv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-88-36" name="__codelineno-88-36"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-88-37" name="__codelineno-88-37"></a><span class="w">      </span><span class="c1">// résultat</span>
<a id="__codelineno-88-38" name="__codelineno-88-38"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">idRv</span><span class="p">;</span>
<a id="__codelineno-88-39" name="__codelineno-88-39"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 12 : on cherche le créneau du rendez-vous en base ;</li>
<li>lignes 13-16 : si on ne le trouve pas, on lance une exception ;</li>
<li>ligne 18 : on cherche le client du rendez-vous en base ;</li>
<li>lignes 19-22 : si on ne le trouve pas, on lance une exception ;</li>
<li>ligne 24 : on construit un objet [Rv] avec les informations nécessaires ;</li>
<li>ligne 26 : on l&#x27;ajoute au contexte de persistance ;</li>
<li>ligne 28 : on synchronise le contexte de persistance avec la base. Le rendez-vous va alors être mis en base ;</li>
<li>ligne 30 : on sait qu&#x27;après synchronisation de la base, les clés primaires des éléments insérés sont disponibles. On récupère celle du rendez-vous ajouté ;</li>
<li>ligne 31 : on ferme le contexte de persistance.</li>
</ul>
<p>La méthode [SupprimerRv] doit supprimer un rendez-vous dont on lui passe la clé primaire.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-89-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-89-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-89-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-89-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-89-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-89-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-89-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-89-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-89-10">10</a></span>
<span class="normal"><a href="#__codelineno-89-11">11</a></span>
<span class="normal"><a href="#__codelineno-89-12">12</a></span>
<span class="normal"><a href="#__codelineno-89-13">13</a></span>
<span class="normal"><a href="#__codelineno-89-14">14</a></span>
<span class="normal"><a href="#__codelineno-89-15">15</a></span>
<span class="normal"><a href="#__codelineno-89-16">16</a></span>
<span class="normal"><a href="#__codelineno-89-17">17</a></span>
<span class="normal"><a href="#__codelineno-89-18">18</a></span>
<span class="normal"><a href="#__codelineno-89-19">19</a></span>
<span class="normal"><a href="#__codelineno-89-20">20</a></span>
<span class="normal"><a href="#__codelineno-89-21">21</a></span>
<span class="normal"><a href="#__codelineno-89-22">22</a></span>
<span class="normal"><a href="#__codelineno-89-23">23</a></span>
<span class="normal"><a href="#__codelineno-89-24">24</a></span>
<span class="normal"><a href="#__codelineno-89-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1"></a><span class="c1">// supprimer un RV</span>
<a id="__codelineno-89-2" name="__codelineno-89-2"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SupprimerRv</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idRv</span><span class="p">)</span>
<a id="__codelineno-89-3" name="__codelineno-89-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-89-4" name="__codelineno-89-4"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-89-5" name="__codelineno-89-5"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-89-6" name="__codelineno-89-6"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-89-7" name="__codelineno-89-7"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-89-8" name="__codelineno-89-8"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-89-9" name="__codelineno-89-9"></a><span class="w">          </span><span class="c1">// on récupère le Rv</span>
<a id="__codelineno-89-10" name="__codelineno-89-10"></a><span class="w">          </span><span class="n">Rv</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">idRv</span><span class="p">);</span>
<a id="__codelineno-89-11" name="__codelineno-89-11"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-89-12" name="__codelineno-89-12"></a><span class="w">          </span><span class="p">{</span>
<a id="__codelineno-89-13" name="__codelineno-89-13"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Rv [{0}] inexistant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idRv</span><span class="p">));</span>
<a id="__codelineno-89-14" name="__codelineno-89-14"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-89-15" name="__codelineno-89-15"></a><span class="w">          </span><span class="c1">// suppression Rv</span>
<a id="__codelineno-89-16" name="__codelineno-89-16"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">Rvs</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
<a id="__codelineno-89-17" name="__codelineno-89-17"></a><span class="w">          </span><span class="c1">// sauvegarde du contexte</span>
<a id="__codelineno-89-18" name="__codelineno-89-18"></a><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<a id="__codelineno-89-19" name="__codelineno-89-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-89-20" name="__codelineno-89-20"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-89-21" name="__codelineno-89-21"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-89-22" name="__codelineno-89-22"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-89-23" name="__codelineno-89-23"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SupprimerRv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-89-24" name="__codelineno-89-24"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-89-25" name="__codelineno-89-25"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 7 : nouveau contexte de persistance ;</li>
<li>ligne 10 : on amène dans le contexte, le rendez-vous à supprimer ;</li>
<li>lignes 11-15 : s&#x27;il n&#x27;existe pas, on lance une exception ;</li>
<li>ligne 16 : on le supprime du contexte ;</li>
<li>ligne 18 : on synchronise le contexte avec la base ;</li>
<li>ligne 19 : on ferme le contexte.</li>
</ul>
<p>La méthode [Find&lt;T&gt;] permet de rechercher en base une entité de type T, via sa clé primaire. Son code pourrait être le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-90-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-90-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-90-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-90-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-90-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-90-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-90-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-90-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-90-10">10</a></span>
<span class="normal"><a href="#__codelineno-90-11">11</a></span>
<span class="normal"><a href="#__codelineno-90-12">12</a></span>
<span class="normal"><a href="#__codelineno-90-13">13</a></span>
<span class="normal"><a href="#__codelineno-90-14">14</a></span>
<span class="normal"><a href="#__codelineno-90-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="k">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Find</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">class</span>
<a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-90-3" name="__codelineno-90-3"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-90-4" name="__codelineno-90-4"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-90-5" name="__codelineno-90-5"></a><span class="w">        </span><span class="c1">// ouverture contexte de persistance</span>
<a id="__codelineno-90-6" name="__codelineno-90-6"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RdvMedecinsContext</span><span class="p">())</span>
<a id="__codelineno-90-7" name="__codelineno-90-7"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-90-8" name="__codelineno-90-8"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">().</span><span class="n">Find</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-90-9" name="__codelineno-90-9"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-90-10" name="__codelineno-90-10"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-90-11" name="__codelineno-90-11"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-90-12" name="__codelineno-90-12"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-90-13" name="__codelineno-90-13"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">RdvMedecinsException</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Find&lt;T&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<a id="__codelineno-90-14" name="__codelineno-90-14"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-90-15" name="__codelineno-90-15"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 8 : la méthode <strong>Set&lt;T&gt;</strong> permet de récupérer un <strong>DbSet&lt;T&gt;</strong> sur lequel on peut appliquer les méthodes habituelles.</li>
</ul>
<p>Le projet évolue comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001A00000018AF231FF65.png" style="display:inline-block; margin:4px;width:5.503cm;height:5.212cm;" /></td></tr></table>

<h3 id="364-test-de-la-couche-dao">3.6.4. Test de la couche [DAO]</h3>
<p>Nous allons créer un programme de test de la couche [DAO]. L&#x27;architecture du test sera la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005E40000011BF7266974.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.378cm;" /></td></tr></table>

<p>Un programme console demande à [Spring.net] d&#x27;instancier la couche [DAO]. Ceci fait, il teste les différentes fonctionnalités de l&#x27;interface de la couche [DAO]. Plutôt qu&#x27;un programme console, il aurait été préférable d&#x27;écrire un programme de test de type NUnit. Un programme de test de la couche [DAO] pourrait être le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-91-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-91-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-91-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-91-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-91-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-91-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-91-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-91-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-91-10">10</a></span>
<span class="normal"><a href="#__codelineno-91-11">11</a></span>
<span class="normal"><a href="#__codelineno-91-12">12</a></span>
<span class="normal"><a href="#__codelineno-91-13">13</a></span>
<span class="normal"><a href="#__codelineno-91-14">14</a></span>
<span class="normal"><a href="#__codelineno-91-15">15</a></span>
<span class="normal"><a href="#__codelineno-91-16">16</a></span>
<span class="normal"><a href="#__codelineno-91-17">17</a></span>
<span class="normal"><a href="#__codelineno-91-18">18</a></span>
<span class="normal"><a href="#__codelineno-91-19">19</a></span>
<span class="normal"><a href="#__codelineno-91-20">20</a></span>
<span class="normal"><a href="#__codelineno-91-21">21</a></span>
<span class="normal"><a href="#__codelineno-91-22">22</a></span>
<span class="normal"><a href="#__codelineno-91-23">23</a></span>
<span class="normal"><a href="#__codelineno-91-24">24</a></span>
<span class="normal"><a href="#__codelineno-91-25">25</a></span>
<span class="normal"><a href="#__codelineno-91-26">26</a></span>
<span class="normal"><a href="#__codelineno-91-27">27</a></span>
<span class="normal"><a href="#__codelineno-91-28">28</a></span>
<span class="normal"><a href="#__codelineno-91-29">29</a></span>
<span class="normal"><a href="#__codelineno-91-30">30</a></span>
<span class="normal"><a href="#__codelineno-91-31">31</a></span>
<span class="normal"><a href="#__codelineno-91-32">32</a></span>
<span class="normal"><a href="#__codelineno-91-33">33</a></span>
<span class="normal"><a href="#__codelineno-91-34">34</a></span>
<span class="normal"><a href="#__codelineno-91-35">35</a></span>
<span class="normal"><a href="#__codelineno-91-36">36</a></span>
<span class="normal"><a href="#__codelineno-91-37">37</a></span>
<span class="normal"><a href="#__codelineno-91-38">38</a></span>
<span class="normal"><a href="#__codelineno-91-39">39</a></span>
<span class="normal"><a href="#__codelineno-91-40">40</a></span>
<span class="normal"><a href="#__codelineno-91-41">41</a></span>
<span class="normal"><a href="#__codelineno-91-42">42</a></span>
<span class="normal"><a href="#__codelineno-91-43">43</a></span>
<span class="normal"><a href="#__codelineno-91-44">44</a></span>
<span class="normal"><a href="#__codelineno-91-45">45</a></span>
<span class="normal"><a href="#__codelineno-91-46">46</a></span>
<span class="normal"><a href="#__codelineno-91-47">47</a></span>
<span class="normal"><a href="#__codelineno-91-48">48</a></span>
<span class="normal"><a href="#__codelineno-91-49">49</a></span>
<span class="normal"><a href="#__codelineno-91-50">50</a></span>
<span class="normal"><a href="#__codelineno-91-51">51</a></span>
<span class="normal"><a href="#__codelineno-91-52">52</a></span>
<span class="normal"><a href="#__codelineno-91-53">53</a></span>
<span class="normal"><a href="#__codelineno-91-54">54</a></span>
<span class="normal"><a href="#__codelineno-91-55">55</a></span>
<span class="normal"><a href="#__codelineno-91-56">56</a></span>
<span class="normal"><a href="#__codelineno-91-57">57</a></span>
<span class="normal"><a href="#__codelineno-91-58">58</a></span>
<span class="normal"><a href="#__codelineno-91-59">59</a></span>
<span class="normal"><a href="#__codelineno-91-60">60</a></span>
<span class="normal"><a href="#__codelineno-91-61">61</a></span>
<span class="normal"><a href="#__codelineno-91-62">62</a></span>
<span class="normal"><a href="#__codelineno-91-63">63</a></span>
<span class="normal"><a href="#__codelineno-91-64">64</a></span>
<span class="normal"><a href="#__codelineno-91-65">65</a></span>
<span class="normal"><a href="#__codelineno-91-66">66</a></span>
<span class="normal"><a href="#__codelineno-91-67">67</a></span>
<span class="normal"><a href="#__codelineno-91-68">68</a></span>
<span class="normal"><a href="#__codelineno-91-69">69</a></span>
<span class="normal"><a href="#__codelineno-91-70">70</a></span>
<span class="normal"><a href="#__codelineno-91-71">71</a></span>
<span class="normal"><a href="#__codelineno-91-72">72</a></span>
<span class="normal"><a href="#__codelineno-91-73">73</a></span>
<span class="normal"><a href="#__codelineno-91-74">74</a></span>
<span class="normal"><a href="#__codelineno-91-75">75</a></span>
<span class="normal"><a href="#__codelineno-91-76">76</a></span>
<span class="normal"><a href="#__codelineno-91-77">77</a></span>
<span class="normal"><a href="#__codelineno-91-78">78</a></span>
<span class="normal"><a href="#__codelineno-91-79">79</a></span>
<span class="normal"><a href="#__codelineno-91-80">80</a></span>
<span class="normal"><a href="#__codelineno-91-81">81</a></span>
<span class="normal"><a href="#__codelineno-91-82">82</a></span>
<span class="normal"><a href="#__codelineno-91-83">83</a></span>
<span class="normal"><a href="#__codelineno-91-84">84</a></span>
<span class="normal"><a href="#__codelineno-91-85">85</a></span>
<span class="normal"><a href="#__codelineno-91-86">86</a></span>
<span class="normal"><a href="#__codelineno-91-87">87</a></span>
<span class="normal"><a href="#__codelineno-91-88">88</a></span>
<span class="normal"><a href="#__codelineno-91-89">89</a></span>
<span class="normal"><a href="#__codelineno-91-90">90</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a id="__codelineno-91-3" name="__codelineno-91-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Dao</span><span class="p">;</span>
<a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Entites</span><span class="p">;</span>
<a id="__codelineno-91-5" name="__codelineno-91-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">RdvMedecins.Exceptions</span><span class="p">;</span>
<a id="__codelineno-91-6" name="__codelineno-91-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">Spring.Context.Support</span><span class="p">;</span>
<a id="__codelineno-91-7" name="__codelineno-91-7"></a>
<a id="__codelineno-91-8" name="__codelineno-91-8"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">RdvMedecins.Tests</span>
<a id="__codelineno-91-9" name="__codelineno-91-9"></a><span class="p">{</span>
<a id="__codelineno-91-10" name="__codelineno-91-10"></a><span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Program</span>
<a id="__codelineno-91-11" name="__codelineno-91-11"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-91-12" name="__codelineno-91-12"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">()</span>
<a id="__codelineno-91-13" name="__codelineno-91-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-91-14" name="__codelineno-91-14"></a><span class="w">      </span><span class="n">IDao</span><span class="w"> </span><span class="n">dao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<a id="__codelineno-91-15" name="__codelineno-91-15"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-91-16" name="__codelineno-91-16"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-91-17" name="__codelineno-91-17"></a><span class="w">        </span><span class="c1">// instanciation couche [DAO] via Spring</span>
<a id="__codelineno-91-18" name="__codelineno-91-18"></a><span class="w">        </span><span class="n">dao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextRegistry</span><span class="p">.</span><span class="n">GetContext</span><span class="p">().</span><span class="n">GetObject</span><span class="p">(</span><span class="s">&quot;rdvmedecinsDao&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">IDao</span><span class="p">;</span>
<a id="__codelineno-91-19" name="__codelineno-91-19"></a>
<a id="__codelineno-91-20" name="__codelineno-91-20"></a><span class="w">        </span><span class="c1">// affichage clients</span>
<a id="__codelineno-91-21" name="__codelineno-91-21"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetAllClients</span><span class="p">();</span>
<a id="__codelineno-91-22" name="__codelineno-91-22"></a><span class="w">        </span><span class="n">DisplayClients</span><span class="p">(</span><span class="s">&quot;Liste des clients :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">clients</span><span class="p">);</span>
<a id="__codelineno-91-23" name="__codelineno-91-23"></a>
<a id="__codelineno-91-24" name="__codelineno-91-24"></a><span class="w">        </span><span class="c1">// affichage médecins</span>
<a id="__codelineno-91-25" name="__codelineno-91-25"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">medecins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetAllMedecins</span><span class="p">();</span>
<a id="__codelineno-91-26" name="__codelineno-91-26"></a><span class="w">        </span><span class="n">DisplayMedecins</span><span class="p">(</span><span class="s">&quot;Liste des médecins :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">);</span>
<a id="__codelineno-91-27" name="__codelineno-91-27"></a>
<a id="__codelineno-91-28" name="__codelineno-91-28"></a><span class="w">        </span><span class="c1">// liste des créneaux horaires du médecin n° 0</span>
<a id="__codelineno-91-29" name="__codelineno-91-29"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">creneaux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetCreneauxMedecin</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-91-30" name="__codelineno-91-30"></a><span class="w">        </span><span class="n">DisplayCreneaux</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Liste des créneaux horaires du médecin {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">creneaux</span><span class="p">);</span>
<a id="__codelineno-91-31" name="__codelineno-91-31"></a>
<a id="__codelineno-91-32" name="__codelineno-91-32"></a><span class="w">        </span><span class="c1">// liste des Rv d&#39;un médecin pour un jour donné</span>
<a id="__codelineno-91-33" name="__codelineno-91-33"></a><span class="w">        </span><span class="n">DisplayRvs</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Liste des RV du médecin {0}, le 23/11/2013 :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetRvMedecinJour</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">)));</span>
<a id="__codelineno-91-34" name="__codelineno-91-34"></a>
<a id="__codelineno-91-35" name="__codelineno-91-35"></a><span class="w">        </span><span class="c1">// ajouter un RV au médecin n°1 dans créneau n° 0</span>
<a id="__codelineno-91-36" name="__codelineno-91-36"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Ajout d&#39;un RV au médecin {0} avec client {1} le 23/11/2013&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<a id="__codelineno-91-37" name="__codelineno-91-37"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idRv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">AjouterRv</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-91-38" name="__codelineno-91-38"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Rdv ajouté&quot;</span><span class="p">);</span>
<a id="__codelineno-91-39" name="__codelineno-91-39"></a><span class="w">        </span><span class="n">DisplayRvs</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Liste des RV du médecin {0}, le 23/11/2013 :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetRvMedecinJour</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">)));</span>
<a id="__codelineno-91-40" name="__codelineno-91-40"></a>
<a id="__codelineno-91-41" name="__codelineno-91-41"></a><span class="w">        </span><span class="c1">// ajouter un Rv dans un créneau déjà occupé - doit provoquer une exception</span>
<a id="__codelineno-91-42" name="__codelineno-91-42"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idRv2</span><span class="p">;</span>
<a id="__codelineno-91-43" name="__codelineno-91-43"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Ajout d&#39;un RV dans un créneau déjà occupé&quot;</span><span class="p">);</span>
<a id="__codelineno-91-44" name="__codelineno-91-44"></a><span class="w">        </span><span class="k">try</span>
<a id="__codelineno-91-45" name="__codelineno-91-45"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-91-46" name="__codelineno-91-46"></a><span class="w">          </span><span class="n">idRv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">AjouterRv</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">creneaux</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">clients</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">);</span>
<a id="__codelineno-91-47" name="__codelineno-91-47"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Rdv ajouté&quot;</span><span class="p">);</span>
<a id="__codelineno-91-48" name="__codelineno-91-48"></a><span class="w">          </span><span class="n">DisplayRvs</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Liste des RV du médecin {0}, le 23/11/2013 :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetRvMedecinJour</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">)));</span>
<a id="__codelineno-91-49" name="__codelineno-91-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-91-50" name="__codelineno-91-50"></a><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RdvMedecinsException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-91-51" name="__codelineno-91-51"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-91-52" name="__codelineno-91-52"></a><span class="w">          </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;L&#39;erreur suivante s&#39;est produite : {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">));</span>
<a id="__codelineno-91-53" name="__codelineno-91-53"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-91-54" name="__codelineno-91-54"></a>
<a id="__codelineno-91-55" name="__codelineno-91-55"></a><span class="w">        </span><span class="c1">// supprimer un Rv</span>
<a id="__codelineno-91-56" name="__codelineno-91-56"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Suppression du RV n° {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idRv1</span><span class="p">));</span>
<a id="__codelineno-91-57" name="__codelineno-91-57"></a><span class="w">        </span><span class="n">dao</span><span class="p">.</span><span class="n">SupprimerRv</span><span class="p">(</span><span class="n">idRv1</span><span class="p">);</span>
<a id="__codelineno-91-58" name="__codelineno-91-58"></a><span class="w">        </span><span class="n">DisplayRvs</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Liste des RV du médecin {0}, le 23/11/2013 :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="n">GetRvMedecinJour</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">medecins</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DateTime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">)));</span>
<a id="__codelineno-91-59" name="__codelineno-91-59"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-91-60" name="__codelineno-91-60"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-91-61" name="__codelineno-91-61"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-91-62" name="__codelineno-91-62"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;L&#39;erreur suivante s&#39;est produite : {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">));</span>
<a id="__codelineno-91-63" name="__codelineno-91-63"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-91-64" name="__codelineno-91-64"></a><span class="w">      </span><span class="c1">//pause </span>
<a id="__codelineno-91-65" name="__codelineno-91-65"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
<a id="__codelineno-91-66" name="__codelineno-91-66"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-91-67" name="__codelineno-91-67"></a>
<a id="__codelineno-91-68" name="__codelineno-91-68"></a><span class="w">    </span><span class="c1">// méthodes utilitaires - affiche des listes</span>
<a id="__codelineno-91-69" name="__codelineno-91-69"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">DisplayClients</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">Message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-91-70" name="__codelineno-91-70"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-91-71" name="__codelineno-91-71"></a><span class="w">      </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Message</span><span class="p">);</span>
<a id="__codelineno-91-72" name="__codelineno-91-72"></a><span class="w">      </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">Client</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span>
<a id="__codelineno-91-73" name="__codelineno-91-73"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-91-74" name="__codelineno-91-74"></a><span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">ShortIdentity</span><span class="p">());</span>
<a id="__codelineno-91-75" name="__codelineno-91-75"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-91-76" name="__codelineno-91-76"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-91-77" name="__codelineno-91-77"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">DisplayMedecins</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">Message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">medecins</span><span class="p">)</span>
<a id="__codelineno-91-78" name="__codelineno-91-78"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-91-79" name="__codelineno-91-79"></a><span class="p">...</span>
<a id="__codelineno-91-80" name="__codelineno-91-80"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-91-81" name="__codelineno-91-81"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">DisplayCreneaux</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">Message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">creneaux</span><span class="p">)</span>
<a id="__codelineno-91-82" name="__codelineno-91-82"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-91-83" name="__codelineno-91-83"></a><span class="p">...</span>
<a id="__codelineno-91-84" name="__codelineno-91-84"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-91-85" name="__codelineno-91-85"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">DisplayRvs</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">Message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rvs</span><span class="p">)</span>
<a id="__codelineno-91-86" name="__codelineno-91-86"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-91-87" name="__codelineno-91-87"></a><span class="p">...</span>
<a id="__codelineno-91-88" name="__codelineno-91-88"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-91-89" name="__codelineno-91-89"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-91-90" name="__codelineno-91-90"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 14 : la référence sur la couche [DAO]. Pour rendre le test indépendant de l&#x27;implémentation réelle de celle-ci, cette référence est du type de l&#x27;interface [IDao] et non du type de la classe [Dao] ;</li>
<li>ligne 18 : la couche [DAO] est instanciée par Spring. Nous reviendrons sur la configuration nécessaire pour que cela soit possible. Nous castons la référence d&#x27;objet rendue par Spring en une référence du type de l&#x27;interface [IDao] ;</li>
<li>lignes 21-22 : affichent les clients ;</li>
<li>lignes 25-26 : affichent les médecins ;</li>
<li>lignes 29-30 : affichent la liste des créneaux du médecin n° 0 ;</li>
<li>ligne 33 : affiche les rendez-vous du médecin n° 0 à la date du 23/11/2013. On doit en avoir aucun ;</li>
<li>ligne 37 : ajoute un rendez-vous au médecin n° 0 pour le 23/11/2013 ;</li>
<li>ligne 39 : affiche les rendez-vous du médecin n° 0 à la date du 23/11/2013. On doit en avoir un ;</li>
<li>ligne 46 : on ajoute une seconde fois le même rendez-vous. On doit avoir une exception ;</li>
<li>ligne 57 : on supprime l&#x27;unique rendez-vous ajouté ;</li>
<li>ligne 58 : affiche les rendez-vous du médecin n° 0 à la date du 23/11/2013. On doit en avoir aucun.</li>
</ul>
<h3 id="365-configuration-de-springnet">3.6.5. Configuration de Spring.net</h3>
<p>Dans le programme de test ci-dessus, nous sommes passés rapidement sur l&#x27;instruction qui instancie la couche [DAO] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1"></a>dao = ContextRegistry.GetContext().GetObject(&quot;rdvmedecinsDao&quot;) as IDao;
</code></pre></div></td></tr></table></div>
<p>La classe [ContextRegistry] est une classe de Spring dans l&#x27;espace de noms [Spring.Context.Support]. Pour pouvoir utiliser Spring, il nous faut ajouter sa DLL dans les références du projet. Nous procédons de la façon suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003240000010B2E265D70.png" style="display:inline-block; margin:4px;width:10.636cm;height:3.533cm;" /></td></tr></table>

<ul>
<li>en [1], on recherche des paquetages avec l&#x27;outil [NuGet] ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005B200000157C7BCCCB8.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.233cm;" /></td></tr></table>

<ul>
<li>en [2], on cherche des paquetages en ligne ;</li>
<li>en [3], on met le mot clé <em>spring</em> dans la zone de recherche ;</li>
<li>en [4], les paquetages dont la description contient ce mot clé sont affichées. Ici, c&#x27;est [Spring.Core] qui nous convient. On l&#x27;installe.</li>
</ul>
<p>Les références du projet évoluent comme suit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000184000000C51A352E88.png" style="display:inline-block; margin:4px;width:5.133cm;height:2.607cm;" /></td></tr></table>

<p>Le paquetage [Spring.Core] avait une dépendance sur le paquetage [Common.Logging]. Celui-ci a été chargé également. A ce stade, le projet ne doit plus présenter d&#x27;erreurs.</p>
<p>Ce n&#x27;est pas pour cela qu&#x27;il va marcher. Il nous faut configurer d&#x27;abord Spring dans le fichier [App.config]. C&#x27;est la partie la plus délicate du projet. Le nouveau fichier [App.config] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-93-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-93-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-93-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-93-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-93-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-93-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-93-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-93-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-93-10">10</a></span>
<span class="normal"><a href="#__codelineno-93-11">11</a></span>
<span class="normal"><a href="#__codelineno-93-12">12</a></span>
<span class="normal"><a href="#__codelineno-93-13">13</a></span>
<span class="normal"><a href="#__codelineno-93-14">14</a></span>
<span class="normal"><a href="#__codelineno-93-15">15</a></span>
<span class="normal"><a href="#__codelineno-93-16">16</a></span>
<span class="normal"><a href="#__codelineno-93-17">17</a></span>
<span class="normal"><a href="#__codelineno-93-18">18</a></span>
<span class="normal"><a href="#__codelineno-93-19">19</a></span>
<span class="normal"><a href="#__codelineno-93-20">20</a></span>
<span class="normal"><a href="#__codelineno-93-21">21</a></span>
<span class="normal"><a href="#__codelineno-93-22">22</a></span>
<span class="normal"><a href="#__codelineno-93-23">23</a></span>
<span class="normal"><a href="#__codelineno-93-24">24</a></span>
<span class="normal"><a href="#__codelineno-93-25">25</a></span>
<span class="normal"><a href="#__codelineno-93-26">26</a></span>
<span class="normal"><a href="#__codelineno-93-27">27</a></span>
<span class="normal"><a href="#__codelineno-93-28">28</a></span>
<span class="normal"><a href="#__codelineno-93-29">29</a></span>
<span class="normal"><a href="#__codelineno-93-30">30</a></span>
<span class="normal"><a href="#__codelineno-93-31">31</a></span>
<span class="normal"><a href="#__codelineno-93-32">32</a></span>
<span class="normal"><a href="#__codelineno-93-33">33</a></span>
<span class="normal"><a href="#__codelineno-93-34">34</a></span>
<span class="normal"><a href="#__codelineno-93-35">35</a></span>
<span class="normal"><a href="#__codelineno-93-36">36</a></span>
<span class="normal"><a href="#__codelineno-93-37">37</a></span>
<span class="normal"><a href="#__codelineno-93-38">38</a></span>
<span class="normal"><a href="#__codelineno-93-39">39</a></span>
<span class="normal"><a href="#__codelineno-93-40">40</a></span>
<span class="normal"><a href="#__codelineno-93-41">41</a></span>
<span class="normal"><a href="#__codelineno-93-42">42</a></span>
<span class="normal"><a href="#__codelineno-93-43">43</a></span>
<span class="normal"><a href="#__codelineno-93-44">44</a></span>
<span class="normal"><a href="#__codelineno-93-45">45</a></span>
<span class="normal"><a href="#__codelineno-93-46">46</a></span>
<span class="normal"><a href="#__codelineno-93-47">47</a></span>
<span class="normal"><a href="#__codelineno-93-48">48</a></span>
<span class="normal"><a href="#__codelineno-93-49">49</a></span>
<span class="normal"><a href="#__codelineno-93-50">50</a></span>
<span class="normal"><a href="#__codelineno-93-51">51</a></span>
<span class="normal"><a href="#__codelineno-93-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-93-2" name="__codelineno-93-2"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-93-3" name="__codelineno-93-3"></a><span class="w">  </span><span class="nt">&lt;configSections&gt;</span>
<a id="__codelineno-93-4" name="__codelineno-93-4"></a><span class="w">    </span><span class="cm">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
<a id="__codelineno-93-5" name="__codelineno-93-5"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span><span class="w"> </span><span class="na">requirePermission=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-6" name="__codelineno-93-6"></a><span class="w">    </span><span class="cm">&lt;!-- spring --&gt;</span>
<a id="__codelineno-93-7" name="__codelineno-93-7"></a><span class="w">    </span><span class="nt">&lt;sectionGroup</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;spring&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-93-8" name="__codelineno-93-8"></a><span class="w">      </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;context&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Spring.Context.Support.ContextHandler, Spring.Core&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-9" name="__codelineno-93-9"></a><span class="w">      </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;objects&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Spring.Context.Support.DefaultSectionHandler, Spring.Core&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-10" name="__codelineno-93-10"></a><span class="w">    </span><span class="nt">&lt;/sectionGroup&gt;</span>
<a id="__codelineno-93-11" name="__codelineno-93-11"></a><span class="w">    </span><span class="cm">&lt;!-- common logging--&gt;</span>
<a id="__codelineno-93-12" name="__codelineno-93-12"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;logging&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Common.Logging.ConfigurationSectionHandler, Common.Logging&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-13" name="__codelineno-93-13"></a><span class="w">  </span><span class="nt">&lt;/configSections&gt;</span>
<a id="__codelineno-93-14" name="__codelineno-93-14"></a><span class="w">  </span><span class="nt">&lt;startup&gt;</span>
<a id="__codelineno-93-15" name="__codelineno-93-15"></a><span class="w">    </span><span class="nt">&lt;supportedRuntime</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;v4.0&quot;</span><span class="w"> </span><span class="na">sku=</span><span class="s">&quot;.NETFramework,Version=v4.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-16" name="__codelineno-93-16"></a><span class="w">  </span><span class="nt">&lt;/startup&gt;</span>
<a id="__codelineno-93-17" name="__codelineno-93-17"></a><span class="w">  </span><span class="cm">&lt;!-- Entity Framework --&gt;</span>
<a id="__codelineno-93-18" name="__codelineno-93-18"></a><span class="w">  </span><span class="nt">&lt;entityFramework&gt;</span>
<a id="__codelineno-93-19" name="__codelineno-93-19"></a><span class="w">    </span><span class="nt">&lt;defaultConnectionFactory</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-93-20" name="__codelineno-93-20"></a><span class="w">      </span><span class="nt">&lt;parameters&gt;</span>
<a id="__codelineno-93-21" name="__codelineno-93-21"></a><span class="w">        </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;v11.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-22" name="__codelineno-93-22"></a><span class="w">      </span><span class="nt">&lt;/parameters&gt;</span>
<a id="__codelineno-93-23" name="__codelineno-93-23"></a><span class="w">    </span><span class="nt">&lt;/defaultConnectionFactory&gt;</span>
<a id="__codelineno-93-24" name="__codelineno-93-24"></a><span class="w">  </span><span class="nt">&lt;/entityFramework&gt;</span>
<a id="__codelineno-93-25" name="__codelineno-93-25"></a><span class="w">  </span><span class="cm">&lt;!-- Chaînes de connexion --&gt;</span>
<a id="__codelineno-93-26" name="__codelineno-93-26"></a><span class="w">  </span><span class="nt">&lt;connectionStrings&gt;</span>
<a id="__codelineno-93-27" name="__codelineno-93-27"></a><span class="w">    </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;monContexte&quot;</span><span class="w"> </span><span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=rdvmedecins-ef;User Id=sa;Password=sqlserver2012;&quot;</span><span class="w"> </span><span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-28" name="__codelineno-93-28"></a><span class="w">  </span><span class="nt">&lt;/connectionStrings&gt;</span>
<a id="__codelineno-93-29" name="__codelineno-93-29"></a><span class="w">  </span><span class="nt">&lt;system.data&gt;</span>
<a id="__codelineno-93-30" name="__codelineno-93-30"></a><span class="w">    </span><span class="nt">&lt;DbProviderFactories&gt;</span>
<a id="__codelineno-93-31" name="__codelineno-93-31"></a><span class="w">      </span><span class="nt">&lt;add</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SqlClient Data Provider&quot;</span><span class="w"> </span><span class="na">invariant=</span><span class="s">&quot;System.Data.SqlClient&quot;</span><span class="w"> </span><span class="na">description=</span><span class="s">&quot;.Net Framework Data Provider for SqlServer&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;System.Data.SqlClient.SqlClientFactory, System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-32" name="__codelineno-93-32"></a><span class="w">    </span><span class="nt">&lt;/DbProviderFactories&gt;</span>
<a id="__codelineno-93-33" name="__codelineno-93-33"></a><span class="w">  </span><span class="nt">&lt;/system.data&gt;</span>
<a id="__codelineno-93-34" name="__codelineno-93-34"></a><span class="w">  </span><span class="cm">&lt;!-- configuration Spring --&gt;</span>
<a id="__codelineno-93-35" name="__codelineno-93-35"></a><span class="w">  </span><span class="nt">&lt;spring&gt;</span>
<a id="__codelineno-93-36" name="__codelineno-93-36"></a><span class="w">    </span><span class="nt">&lt;context&gt;</span>
<a id="__codelineno-93-37" name="__codelineno-93-37"></a><span class="w">      </span><span class="nt">&lt;resource</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;config://spring/objects&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-38" name="__codelineno-93-38"></a><span class="w">    </span><span class="nt">&lt;/context&gt;</span>
<a id="__codelineno-93-39" name="__codelineno-93-39"></a><span class="w">    </span><span class="nt">&lt;objects</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.net&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-93-40" name="__codelineno-93-40"></a><span class="w">      </span><span class="nt">&lt;object</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;rdvmedecinsDao&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;RdvMedecins.Dao.Dao,RdvMedecins-SqlServer-02&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-41" name="__codelineno-93-41"></a><span class="w">    </span><span class="nt">&lt;/objects&gt;</span>
<a id="__codelineno-93-42" name="__codelineno-93-42"></a><span class="w">  </span><span class="nt">&lt;/spring&gt;</span>
<a id="__codelineno-93-43" name="__codelineno-93-43"></a><span class="w">  </span><span class="cm">&lt;!-- configuration common.logging --&gt;</span>
<a id="__codelineno-93-44" name="__codelineno-93-44"></a><span class="w">  </span><span class="nt">&lt;logging&gt;</span>
<a id="__codelineno-93-45" name="__codelineno-93-45"></a><span class="w">    </span><span class="nt">&lt;factoryAdapter</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Common.Logging.Simple.ConsoleOutLoggerFactoryAdapter, Common.Logging&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-93-46" name="__codelineno-93-46"></a><span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;showLogName&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-47" name="__codelineno-93-47"></a><span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;showDataTime&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-48" name="__codelineno-93-48"></a><span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;level&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;DEBUG&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-49" name="__codelineno-93-49"></a><span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;dateTimeFormat&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;yyyy/MM/dd HH:mm:ss:fff&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-93-50" name="__codelineno-93-50"></a><span class="w">    </span><span class="nt">&lt;/factoryAdapter&gt;</span>
<a id="__codelineno-93-51" name="__codelineno-93-51"></a><span class="w">  </span><span class="nt">&lt;/logging&gt;</span>
<a id="__codelineno-93-52" name="__codelineno-93-52"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Commençons par enlever tout ce qui est déjà connu : Entity Framework, chaînes de connexion, ProviderFactory. Le fichier évolue comme suit :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-94-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-94-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-94-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-94-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-94-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-94-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-94-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-94-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-94-10">10</a></span>
<span class="normal"><a href="#__codelineno-94-11">11</a></span>
<span class="normal"><a href="#__codelineno-94-12">12</a></span>
<span class="normal"><a href="#__codelineno-94-13">13</a></span>
<span class="normal"><a href="#__codelineno-94-14">14</a></span>
<span class="normal"><a href="#__codelineno-94-15">15</a></span>
<span class="normal"><a href="#__codelineno-94-16">16</a></span>
<span class="normal"><a href="#__codelineno-94-17">17</a></span>
<span class="normal"><a href="#__codelineno-94-18">18</a></span>
<span class="normal"><a href="#__codelineno-94-19">19</a></span>
<span class="normal"><a href="#__codelineno-94-20">20</a></span>
<span class="normal"><a href="#__codelineno-94-21">21</a></span>
<span class="normal"><a href="#__codelineno-94-22">22</a></span>
<span class="normal"><a href="#__codelineno-94-23">23</a></span>
<span class="normal"><a href="#__codelineno-94-24">24</a></span>
<span class="normal"><a href="#__codelineno-94-25">25</a></span>
<span class="normal"><a href="#__codelineno-94-26">26</a></span>
<span class="normal"><a href="#__codelineno-94-27">27</a></span>
<span class="normal"><a href="#__codelineno-94-28">28</a></span>
<span class="normal"><a href="#__codelineno-94-29">29</a></span>
<span class="normal"><a href="#__codelineno-94-30">30</a></span>
<span class="normal"><a href="#__codelineno-94-31">31</a></span>
<span class="normal"><a href="#__codelineno-94-32">32</a></span>
<span class="normal"><a href="#__codelineno-94-33">33</a></span>
<span class="normal"><a href="#__codelineno-94-34">34</a></span>
<span class="normal"><a href="#__codelineno-94-35">35</a></span>
<span class="normal"><a href="#__codelineno-94-36">36</a></span>
<span class="normal"><a href="#__codelineno-94-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a id="__codelineno-94-2" name="__codelineno-94-2"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-94-3" name="__codelineno-94-3"></a><span class="w">  </span><span class="nt">&lt;configSections&gt;</span>
<a id="__codelineno-94-4" name="__codelineno-94-4"></a><span class="w">    </span><span class="cm">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
<a id="__codelineno-94-5" name="__codelineno-94-5"></a><span class="w">    </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-6" name="__codelineno-94-6"></a><span class="w">    </span><span class="cm">&lt;!-- spring --&gt;</span>
<a id="__codelineno-94-7" name="__codelineno-94-7"></a><span class="w">    </span><span class="nt">&lt;sectionGroup</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;spring&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-94-8" name="__codelineno-94-8"></a><span class="w">      </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;context&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Spring.Context.Support.ContextHandler, Spring.Core&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-9" name="__codelineno-94-9"></a><span class="w">      </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;objects&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Spring.Context.Support.DefaultSectionHandler, Spring.Core&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-10" name="__codelineno-94-10"></a><span class="w">    </span><span class="nt">&lt;/sectionGroup&gt;</span>
<a id="__codelineno-94-11" name="__codelineno-94-11"></a><span class="w">    </span><span class="cm">&lt;!-- common logging--&gt;</span>
<a id="__codelineno-94-12" name="__codelineno-94-12"></a><span class="w">    </span><span class="nt">&lt;sectionGroup</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;common&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-94-13" name="__codelineno-94-13"></a><span class="w">      </span><span class="nt">&lt;section</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;logging&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Common.Logging.ConfigurationSectionHandler, Common.Logging&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-14" name="__codelineno-94-14"></a><span class="w">    </span><span class="nt">&lt;/sectionGroup&gt;</span>
<a id="__codelineno-94-15" name="__codelineno-94-15"></a><span class="w">  </span><span class="nt">&lt;/configSections&gt;</span>
<a id="__codelineno-94-16" name="__codelineno-94-16"></a>...
<a id="__codelineno-94-17" name="__codelineno-94-17"></a><span class="w">  </span><span class="cm">&lt;!-- configuration Spring --&gt;</span>
<a id="__codelineno-94-18" name="__codelineno-94-18"></a><span class="w">  </span><span class="nt">&lt;spring&gt;</span>
<a id="__codelineno-94-19" name="__codelineno-94-19"></a><span class="w">    </span><span class="nt">&lt;context&gt;</span>
<a id="__codelineno-94-20" name="__codelineno-94-20"></a><span class="w">      </span><span class="nt">&lt;resource</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;config://spring/objects&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-21" name="__codelineno-94-21"></a><span class="w">    </span><span class="nt">&lt;/context&gt;</span>
<a id="__codelineno-94-22" name="__codelineno-94-22"></a><span class="w">    </span><span class="nt">&lt;objects</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.net&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-94-23" name="__codelineno-94-23"></a><span class="w">      </span><span class="nt">&lt;object</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;rdvmedecinsDao&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;RdvMedecins.Dao.Dao,RdvMedecins-SqlServer-02&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-24" name="__codelineno-94-24"></a><span class="w">    </span><span class="nt">&lt;/objects&gt;</span>
<a id="__codelineno-94-25" name="__codelineno-94-25"></a><span class="w">  </span><span class="nt">&lt;/spring&gt;</span>
<a id="__codelineno-94-26" name="__codelineno-94-26"></a><span class="w">  </span><span class="cm">&lt;!-- configuration common.logging --&gt;</span>
<a id="__codelineno-94-27" name="__codelineno-94-27"></a><span class="w">  </span><span class="nt">&lt;common&gt;</span>
<a id="__codelineno-94-28" name="__codelineno-94-28"></a><span class="w">    </span><span class="nt">&lt;logging&gt;</span>
<a id="__codelineno-94-29" name="__codelineno-94-29"></a><span class="w">      </span><span class="nt">&lt;factoryAdapter</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;Common.Logging.Simple.ConsoleOutLoggerFactoryAdapter, Common.Logging&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-94-30" name="__codelineno-94-30"></a><span class="w">        </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;showLogName&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-31" name="__codelineno-94-31"></a><span class="w">        </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;showDataTime&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-32" name="__codelineno-94-32"></a><span class="w">        </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;level&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;DEBUG&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-33" name="__codelineno-94-33"></a><span class="w">        </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;dateTimeFormat&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;yyyy/MM/dd HH:mm:ss:fff&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<a id="__codelineno-94-34" name="__codelineno-94-34"></a><span class="w">      </span><span class="nt">&lt;/factoryAdapter&gt;</span>
<a id="__codelineno-94-35" name="__codelineno-94-35"></a><span class="w">    </span><span class="nt">&lt;/logging&gt;</span>
<a id="__codelineno-94-36" name="__codelineno-94-36"></a><span class="w">  </span><span class="nt">&lt;/common&gt;</span>
<a id="__codelineno-94-37" name="__codelineno-94-37"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 3-15 : définissent des sections de configuration ;</li>
<li>ligne 8 : définit la classe qui va gérer la section &lt;spring&gt;&lt;context&gt; du fichier XML (lignes 19-21) ;</li>
<li>ligne 9 : définit la classe qui va gérer la section &lt;spring&gt;&lt;objects&gt; du fichier XML (lignes 22-24) ;</li>
<li>ligne 13 : définit la classe qui va gérer la section &lt;common&gt;&lt;logging&gt; du fichier XML (lignes 27-36) ;</li>
<li>lignes 7-14 : sont stables. N&#x27;ont pas à être changées dans un autre projet ;</li>
<li>lignes 18-25 : configuration Spring. Est stable sauf pour les lignes 22-24 qui définissent les objets que Spring sera amené à instancier ;</li>
<li>ligne 23 : définition d&#x27;un objet. L&#x27;attribut <strong>id</strong> est libre. C&#x27;est l&#x27;identifiant de l&#x27;objet. L&#x27;attribut <strong>type</strong> désigne la classe à instancier sous la forme &quot; nom complet de la classe, Assembly qui contient la classe&quot;. La classe ici est celle qui implémente la couche [DAO] : [RdvMedecins.Dao.Dao]. Pour connaître son assembly, il faut regarder les propriétés du projet :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002270000010A7E8CCBFD.png" style="display:inline-block; margin:4px;width:7.29cm;height:3.519cm;" /></td></tr></table>

<p>En [1], le nom de l&#x27;assembly à fournir ;</p>
<ul>
<li>lignes 27-36 : la configuration de &quot; Common Logging &quot; est stable. On peut être amenés à modifier le niveau d&#x27;information, ligne 32. Après la phase de débogage, on peut passer le niveau à <strong>INFO</strong>.</li>
</ul>
<p>Au final, complexe au premier abord, le fichier de configuration de Spring s&#x27;avère simple. Il n&#x27;y a à modifier que :</p>
<ul>
<li>les lignes 22-24 qui définissent les objets à instancier ;</li>
<li>ligne 32 : le niveau de logs.</li>
</ul>
<p>Dans le programme de test l&#x27;instruction qui instancie la couche [DAO]est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1"></a>dao = ContextRegistry.GetContext().GetObject(&quot;rdvmedecinsDao&quot;) as IDao;
</code></pre></div></td></tr></table></div>
<p>[ContextRegistry] est une classe de Spring qui exploite la configuration de Spring faite dans un fichier [Web.config] ou [App.config]. Ici, elle va exploiter la section suivante du fichier [App.config] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-96-1">1</a></span>
<span class="normal"><a href="#__codelineno-96-2">2</a></span>
<span class="normal"><a href="#__codelineno-96-3">3</a></span>
<span class="normal"><a href="#__codelineno-96-4">4</a></span>
<span class="normal"><a href="#__codelineno-96-5">5</a></span>
<span class="normal"><a href="#__codelineno-96-6">6</a></span>
<span class="normal"><a href="#__codelineno-96-7">7</a></span>
<span class="normal"><a href="#__codelineno-96-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1"></a>  &lt;spring&gt;
<a id="__codelineno-96-2" name="__codelineno-96-2"></a>    &lt;context&gt;
<a id="__codelineno-96-3" name="__codelineno-96-3"></a>      &lt;resource uri=&quot;config://spring/objects&quot; /&gt;
<a id="__codelineno-96-4" name="__codelineno-96-4"></a>    &lt;/context&gt;
<a id="__codelineno-96-5" name="__codelineno-96-5"></a>    &lt;objects xmlns=&quot;http://www.springframework.net&quot;&gt;
<a id="__codelineno-96-6" name="__codelineno-96-6"></a>      &lt;object id=&quot;rdvmedecinsDao&quot; type=&quot;RdvMedecins.Dao.Dao,RdvMedecins-SqlServer-02&quot; /&gt;
<a id="__codelineno-96-7" name="__codelineno-96-7"></a>    &lt;/objects&gt;
<a id="__codelineno-96-8" name="__codelineno-96-8"></a>&lt;/spring&gt;
</code></pre></div></td></tr></table></div>
<ul>
<li>ContextRegistry.GetContext() exploite le contexte des lignes 2-4. La ligne 3 signifie que les objets Spring sont définis dans la section [spring/objects] du fichier de configuration. Cette section est lignes 5-7 ;</li>
<li>ContextRegistry.GetContext().GetObject(&quot;rdvmedecinsDao&quot;) exploite la section des lignes 5-7. Elle ramène une référence sur l&#x27;objet qui a l&#x27;attribut <strong>id= &quot;rdvmedecinsDao &quot;</strong>. C&#x27;est l&#x27;objet défini ligne 6. Spring va alors instancier la classe définie par l&#x27;attribut <strong>type</strong> en utilisant son constructeur sans paramètres. Celui-ci doit donc exister. Ceci fait, la référence de l&#x27;objet créé est rendue au code appelant. Si l&#x27;objet est demandé une seconde fois dans le code, Spring se contente de rendre une référence sur le premier objet créé. C&#x27;est le modèle de conception (Design Pattern) appelé <strong>singleton</strong>.</li>
</ul>
<p>La construction de l&#x27;objet peut être plus complexe. On peut utiliser un constructeur avec paramètres ou préciser l&#x27;initialisation de certains champs de l&#x27;objet une fois celui-ci créé. Pour plus d&#x27;informations sur ce sujet, on pourra lire l&#x27;article &quot; Tutoriel Spring IOC pour .NET &quot;, à l&#x27;URL [http://tahe.developpez.com/dotnet/springioc/].</p>
<p>Ceci fait, nous pouvons exécuter l&#x27;application. Les résultats écran sont les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-97-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-97-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-97-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-97-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-97-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-97-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-97-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-97-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-97-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-97-10">10</a></span>
<span class="normal"><a href="#__codelineno-97-11">11</a></span>
<span class="normal"><a href="#__codelineno-97-12">12</a></span>
<span class="normal"><a href="#__codelineno-97-13">13</a></span>
<span class="normal"><a href="#__codelineno-97-14">14</a></span>
<span class="normal"><a href="#__codelineno-97-15">15</a></span>
<span class="normal"><a href="#__codelineno-97-16">16</a></span>
<span class="normal"><a href="#__codelineno-97-17">17</a></span>
<span class="normal"><a href="#__codelineno-97-18">18</a></span>
<span class="normal"><a href="#__codelineno-97-19">19</a></span>
<span class="normal"><a href="#__codelineno-97-20">20</a></span>
<span class="normal"><a href="#__codelineno-97-21">21</a></span>
<span class="normal"><a href="#__codelineno-97-22">22</a></span>
<span class="normal"><a href="#__codelineno-97-23">23</a></span>
<span class="normal"><a href="#__codelineno-97-24">24</a></span>
<span class="normal"><a href="#__codelineno-97-25">25</a></span>
<span class="normal"><a href="#__codelineno-97-26">26</a></span>
<span class="normal"><a href="#__codelineno-97-27">27</a></span>
<span class="normal"><a href="#__codelineno-97-28">28</a></span>
<span class="normal"><a href="#__codelineno-97-29">29</a></span>
<span class="normal"><a href="#__codelineno-97-30">30</a></span>
<span class="normal"><a href="#__codelineno-97-31">31</a></span>
<span class="normal"><a href="#__codelineno-97-32">32</a></span>
<span class="normal"><a href="#__codelineno-97-33">33</a></span>
<span class="normal"><a href="#__codelineno-97-34">34</a></span>
<span class="normal"><a href="#__codelineno-97-35">35</a></span>
<span class="normal"><a href="#__codelineno-97-36">36</a></span>
<span class="normal"><a href="#__codelineno-97-37">37</a></span>
<span class="normal"><a href="#__codelineno-97-38">38</a></span>
<span class="normal"><a href="#__codelineno-97-39">39</a></span>
<span class="normal"><a href="#__codelineno-97-40">40</a></span>
<span class="normal"><a href="#__codelineno-97-41">41</a></span>
<span class="normal"><a href="#__codelineno-97-42">42</a></span>
<span class="normal"><a href="#__codelineno-97-43">43</a></span>
<span class="normal"><a href="#__codelineno-97-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1"></a>Liste des clients :
<a id="__codelineno-97-2" name="__codelineno-97-2"></a>Client[35,Mr,Jules,Martin,00000118981]
<a id="__codelineno-97-3" name="__codelineno-97-3"></a>Client[36,Mme,Christine,German,00000118982]
<a id="__codelineno-97-4" name="__codelineno-97-4"></a>Client[37,Mr,Jules,Jacquard,00000118983]
<a id="__codelineno-97-5" name="__codelineno-97-5"></a>Client[38,Melle,Brigitte,Bistrou,00000118984]
<a id="__codelineno-97-6" name="__codelineno-97-6"></a>Liste des médecins :
<a id="__codelineno-97-7" name="__codelineno-97-7"></a>Medecin[26,Mme,Marie,Pelissier,00000118985]
<a id="__codelineno-97-8" name="__codelineno-97-8"></a>Medecin[27,Mr,Jacques,Bromard,000001189110]
<a id="__codelineno-97-9" name="__codelineno-97-9"></a>Medecin[28,Mr,Philippe,Jandot,000001189123]
<a id="__codelineno-97-10" name="__codelineno-97-10"></a>Medecin[29,Melle,Justine,Jacquemot,000001189124]
<a id="__codelineno-97-11" name="__codelineno-97-11"></a>Liste des créneaux horaires du médecin Medecin[26,Mme,Marie,Pelissier,00000118985]
<a id="__codelineno-97-12" name="__codelineno-97-12"></a>Creneau[218,8,0,8,20, 26, 00000118986]
<a id="__codelineno-97-13" name="__codelineno-97-13"></a>Creneau[219,8,20,8,40, 26, 00000118987]
<a id="__codelineno-97-14" name="__codelineno-97-14"></a>Creneau[220,8,40,9,0, 26, 00000118988]
<a id="__codelineno-97-15" name="__codelineno-97-15"></a>Creneau[221,9,0,9,20, 26, 00000118989]
<a id="__codelineno-97-16" name="__codelineno-97-16"></a>Creneau[222,9,20,9,40, 26, 00000118990]
<a id="__codelineno-97-17" name="__codelineno-97-17"></a>Creneau[223,9,40,10,0, 26, 00000118991]
<a id="__codelineno-97-18" name="__codelineno-97-18"></a>Creneau[224,10,0,10,20, 26, 00000118992]
<a id="__codelineno-97-19" name="__codelineno-97-19"></a>Creneau[225,10,20,10,40, 26, 00000118993]
<a id="__codelineno-97-20" name="__codelineno-97-20"></a>Creneau[226,10,40,11,0, 26, 00000118994]
<a id="__codelineno-97-21" name="__codelineno-97-21"></a>Creneau[227,11,0,11,20, 26, 00000118995]
<a id="__codelineno-97-22" name="__codelineno-97-22"></a>Creneau[228,11,20,11,40, 26, 00000118996]
<a id="__codelineno-97-23" name="__codelineno-97-23"></a>Creneau[229,11,40,12,0, 26, 00000118997]
<a id="__codelineno-97-24" name="__codelineno-97-24"></a>Creneau[230,14,0,14,20, 26, 00000118998]
<a id="__codelineno-97-25" name="__codelineno-97-25"></a>Creneau[231,14,20,14,40, 26, 00000118999]
<a id="__codelineno-97-26" name="__codelineno-97-26"></a>Creneau[232,14,40,15,0, 26, 000001189100]
<a id="__codelineno-97-27" name="__codelineno-97-27"></a>Creneau[233,15,0,15,20, 26, 000001189101]
<a id="__codelineno-97-28" name="__codelineno-97-28"></a>Creneau[234,15,20,15,40, 26, 000001189102]
<a id="__codelineno-97-29" name="__codelineno-97-29"></a>Creneau[235,15,40,16,0, 26, 000001189103]
<a id="__codelineno-97-30" name="__codelineno-97-30"></a>Creneau[236,16,0,16,20, 26, 000001189104]
<a id="__codelineno-97-31" name="__codelineno-97-31"></a>Creneau[237,16,20,16,40, 26, 000001189105]
<a id="__codelineno-97-32" name="__codelineno-97-32"></a>Creneau[238,16,40,17,0, 26, 000001189106]
<a id="__codelineno-97-33" name="__codelineno-97-33"></a>Creneau[239,17,0,17,20, 26, 000001189107]
<a id="__codelineno-97-34" name="__codelineno-97-34"></a>Creneau[240,17,20,17,40, 26, 000001189108]
<a id="__codelineno-97-35" name="__codelineno-97-35"></a>Creneau[241,17,40,18,0, 26, 000001189109]
<a id="__codelineno-97-36" name="__codelineno-97-36"></a>Liste des RV du médecin Medecin[26,Mme,Marie,Pelissier,00000118985], le 23/11/2013 :
<a id="__codelineno-97-37" name="__codelineno-97-37"></a>Ajout d&#39;un RV au médecin Medecin[26,Mme,Marie,Pelissier,00000118985] avec client  Client[35,Mr,Jules,Martin,00000118981] le 23/11/2013
<a id="__codelineno-97-38" name="__codelineno-97-38"></a>Rdv ajouté
<a id="__codelineno-97-39" name="__codelineno-97-39"></a>Liste des RV du médecin Medecin[26,Mme,Marie,Pelissier,00000118985], le 23/11/2013 :
<a id="__codelineno-97-40" name="__codelineno-97-40"></a>Rv[28,23/11/2013 00:00:00,35,218,00000289145]
<a id="__codelineno-97-41" name="__codelineno-97-41"></a>Ajout d&#39;un RV dans un créneau déjà occupé
<a id="__codelineno-97-42" name="__codelineno-97-42"></a>L&#39;erreur suivante s&#39;est produite : RdvMedecinsException[7,AjouterRv,Une erreur s&#39;est produite lors de la mise à jour des entrées. Pour plus d&#39;informations, consultez l&#39;exception interne.]
<a id="__codelineno-97-43" name="__codelineno-97-43"></a>Suppression du RV n° 28
<a id="__codelineno-97-44" name="__codelineno-97-44"></a>Liste des RV du médecin Medecin[26,Mme,Marie,Pelissier,00000118985], le 23/11/2013 :
</code></pre></div></td></tr></table></div>
<p>Les résultats sont conformes à ce qui était attendu. On considèrera désormais que notre couche [DAO] est valide. Le tutoriel pourrait s&#x27;arrêter là. Nous avons montré jusqu&#x27;à maintenant :</p>
<ul>
<li>les bases de l&#x27;ORM Entity Framework 5 ;</li>
<li>une couche [DAO] utilisant cet ORM.</li>
</ul>
<p>Rappelons notre étude de cas décrite au début de ce document. Nous partons d&#x27;une application existante à l&#x27;architecture suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F60000012E26745CFD.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.561cm;" /></td></tr></table>

<p>que nous voulons transformer en celle-ci :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005E60000011896541584.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.337cm;" /></td></tr></table>

<p>où EF5 a remplacé NHibernate. Nous venons de construire la couche [DAO2]. En fait elle ne présente pas la même interface que la couche [DAO1] dont l&#x27;interface était plus réduite :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-98-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-98-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-98-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-98-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-98-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-98-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-98-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-98-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-98-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-98-10">10</a></span>
<span class="normal"><a href="#__codelineno-98-11">11</a></span>
<span class="normal"><a href="#__codelineno-98-12">12</a></span>
<span class="normal"><a href="#__codelineno-98-13">13</a></span>
<span class="normal"><a href="#__codelineno-98-14">14</a></span>
<span class="normal"><a href="#__codelineno-98-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1"></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">interface</span><span class="w"> </span><span class="n">IDao</span>
<a id="__codelineno-98-2" name="__codelineno-98-2"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-98-3" name="__codelineno-98-3"></a><span class="w">    </span><span class="c1">// liste des clients</span>
<a id="__codelineno-98-4" name="__codelineno-98-4"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllClients</span><span class="p">();</span>
<a id="__codelineno-98-5" name="__codelineno-98-5"></a><span class="w">    </span><span class="c1">// liste des médecins</span>
<a id="__codelineno-98-6" name="__codelineno-98-6"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Medecin</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAllMedecins</span><span class="p">();</span>
<a id="__codelineno-98-7" name="__codelineno-98-7"></a><span class="w">    </span><span class="c1">// liste des créneaux horaires d&#39;un médecin</span>
<a id="__codelineno-98-8" name="__codelineno-98-8"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Creneau</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetCreneauxMedecin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">);</span>
<a id="__codelineno-98-9" name="__codelineno-98-9"></a><span class="w">    </span><span class="c1">// liste des RV d&#39;un médecin donné, un jour donné</span>
<a id="__codelineno-98-10" name="__codelineno-98-10"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Rv</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetRvMedecinJour</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idMedecin</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">);</span>
<a id="__codelineno-98-11" name="__codelineno-98-11"></a><span class="w">    </span><span class="c1">// ajouter un RV</span>
<a id="__codelineno-98-12" name="__codelineno-98-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">AjouterRv</span><span class="p">(</span><span class="n">DateTime</span><span class="w"> </span><span class="n">jour</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idCreneau</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idClient</span><span class="p">);</span>
<a id="__codelineno-98-13" name="__codelineno-98-13"></a><span class="w">    </span><span class="c1">// supprimer un RV</span>
<a id="__codelineno-98-14" name="__codelineno-98-14"></a><span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">SupprimerRv</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idRv</span><span class="p">);</span>
<a id="__codelineno-98-15" name="__codelineno-98-15"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La couche [DAO2] a rajouté à cette interface la méthode :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-99-1">1</a></span>
<span class="normal"><a href="#__codelineno-99-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1"></a><span class="c1">// trouver une entité T via sa clé primaire</span>
<a id="__codelineno-99-2" name="__codelineno-99-2"></a><span class="n">T</span><span class="w"> </span><span class="n">Find</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">class</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>L&#x27;ajout de cette méthode vient du fait que l&#x27;ORM EF 5 travaille par défaut en mode <strong>Lazy Loading</strong>. Les entités arrivent dans la couche [ASP.NET] sans leurs dépendances. La méthode ci-dessus nous permet de les récupérer si on en a besoin et dans certains cas on en a besoin. NHibernate travaille également par défaut en mode <strong>Lazy Loading </strong>mais je l&#x27;avais utilisé en mode <strong>Eager Loading</strong>. Les entités arrivaient dans la couche [ASP.NET] avec leurs dépendances.</p>
<p>Nous allons terminer le portage de l&#x27;application ASP.NET / NHibernate vers l&#x27;application ASP.NET / EF 5. Mais comme cela ne concerne plus EF5, nous ne commenterons pas le code web. Nous expliquerons simplement comment mettre en place l&#x27;application web et la tester. Celle-ci est disponible sur le site de ce tutoriel.</p>
<h3 id="366-generation-de-la-dll-de-la-couche-dao">3.6.6. Génération de la DLL de la couche [DAO]</h3>
<p>Dans l&#x27;architecture suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005EC00000127EBBF3A8C.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.503cm;" /></td></tr></table>

<p>la couche [ASP.NET] aura à sa disposition les couches à sa droite sous la forme de DLL. Nous construisons donc la DLL de la couche [DAO].</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000062B000001989B0B14B0.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.65cm;" /></td></tr></table>

<ul>
<li>en [1], on sélectionne le programme de test et en [2] on ne l&#x27;inclut pas dans la DLL qui va être générée ;</li>
<li>en [3], dans les propriétés du projet, on indique que l&#x27;assembly à créer est une DLL ;</li>
<li>en [4], dans le menu de VS, on indique qu&#x27;on va générer un assembly de type [Release] qui contient moins d&#x27;informations qu&#x27;un assembly de type [Debug] ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000608000000BCA6A60594.png" style="display:inline-block; margin:4px;width:17.999cm;height:2.191cm;" /></td></tr></table>

<ul>
<li>en [5], on régénère l&#x27;assembly du projet. La DLL va être générée ;</li>
<li>en [6], on fait afficher tous les fichiers du projet ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004D30000011B743A33DF.png" style="display:inline-block; margin:4px;width:16.339cm;height:3.745cm;" /></td></tr></table>

<ul>
<li>en [7], la DLL du projet de la couche [DAO]. C&#x27;est celle-ci que le projet web ASP.NET utilisera ;</li>
<li>en [8], nous rafraîchissons l&#x27;affichage du projet ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005490000015AFC781DD1.png" style="display:inline-block; margin:4px;width:17.9cm;height:4.577cm;" /></td></tr></table>

<ul>
<li>en [9], les DLL du dossier [Release] sont rassemblées dans un dossier [lib] externe [10]. C&#x27;est là que le projet web ira chercher ses références.</li>
</ul>
<h3 id="367-la-couche-aspnet">3.6.7. La couche [ASP.NET]</h3>
<p>Nous allons ici expliquer le portage de l&#x27;application [ASP.NET / NHibernate] vers l&#x27;application [ASP.NET / EF 5]. Nous allons travailler avec Visual Studio Express 2012 pour le web disponible gratuitement à l&#x27;URL [http://www.microsoft.com/visualstudio/fra/downloads].</p>
<p>Nous allons travailler à partir du projet web existant créé avec VS 2010.</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005C8000001700FBAF2DC.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.475cm;" /></td></tr></table>

<ul>
<li>en [1], on ouvre le projet existant :</li>
<li>en [2], le projet chargé a les références suivantes [3] :</li>
<li>[NHibernate] est la DLL du framework NHibernate,</li>
<li>[Spring.Core] est la DLL du framework Spring.net,</li>
<li>[log4net] est la DLL du framework de logs log4net. Ce framework est utilisé par Spring.net,</li>
<li>[MySql.Data] est le pilote ADO.NET du SGBD MySQL,</li>
<li>[rdvmedecins] est la DLL de la couche [DAO] construite avec NHibernate ;</li>
<li>en [4], nous changeons le nom du projet et en [5], nous supprimons les références précédentes ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005C30000015BA45325A7.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.233cm;" /></td></tr></table>

<ul>
<li>en [6], nous ajoutons des références au projet ;</li>
<li>en [7], dans l&#x27;assistant nous utilisons l&#x27;option [Parcourir] ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005DB00000161DB1ADB95.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.239cm;" /></td></tr></table>

<ul>
<li>en [8], nous sélectionnons toutes les DLL du projet n° 2 mises précédemment dans le dossier [lib] ;</li>
<li>en [9], un récapitulatif que nous validons ;</li>
<li>en [10], le projet web avec ses nouvelles références.</li>
</ul>
<p>Ceci fait, le projet se présente de la façon suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000604000001C00A5207C6.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.235cm;" /></td></tr></table>

<ul>
<li>en [1], le code de gestion des pages web est réparti sur les deux fichiers [Global.asax] et [Default.aspx]. Du code utilitaire a été placé dans le dossier [Entites]. Enfin l&#x27;application est configurée par le fichier [Web.config] ;</li>
<li>en [2], nous générons l&#x27;assembly du projet ;</li>
<li>en [3], des erreurs apparaissent.</li>
</ul>
<p>Examinons les erreurs, par exemple la suivante :</p>
<p><img src="images/100000000000023E00000036268F11B3.png" style="width:10.629cm;height:1cm;" alt="Image" /></p>
<p>et son explication :</p>
<p><img src="images/10000000000002F8000000261CB8CE55.png" style="width:14.079cm;height:0.7cm;" alt="Image" /></p>
<p>Le type de [medecin.Id] est <strong>int?</strong> alors que la méthode [GetCreneauxMedecin] est de type <strong>int</strong>. Il faut donc un <em>cast</em>. Cette erreur est récurrente dans tout le code car les entités du projet ASP.NET / NHibernate avaient des clés primaires de type <strong>int</strong> alors que celles du projet ASP.NET / EF 5 sont de type <strong>int?</strong>. On corrige toutes les erreurs de ce type et on régénère le projet. Il n&#x27;y en a alors plus.</p>
<p>Il nous reste un détail à régler avant d&#x27;exécuter le projet : l&#x27;instanciation de la couche [DAO] par le framework Spring. Celle-ci est faite dans [Global.asax] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-100-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-100-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-100-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-100-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-100-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-100-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-100-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-100-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-100-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-100-10">10</a></span>
<span class="normal"><a href="#__codelineno-100-11">11</a></span>
<span class="normal"><a href="#__codelineno-100-12">12</a></span>
<span class="normal"><a href="#__codelineno-100-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1"></a><span class="k">protected</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Application_Start</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">EventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-100-2" name="__codelineno-100-2"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-100-3" name="__codelineno-100-3"></a><span class="w">      </span><span class="c1">// on met en cache certaines données de la base de données</span>
<a id="__codelineno-100-4" name="__codelineno-100-4"></a><span class="w">      </span><span class="k">try</span>
<a id="__codelineno-100-5" name="__codelineno-100-5"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-100-6" name="__codelineno-100-6"></a><span class="w">        </span><span class="c1">// instanciation couche [dao]</span>
<a id="__codelineno-100-7" name="__codelineno-100-7"></a><span class="w">        </span><span class="n">Dao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextRegistry</span><span class="p">.</span><span class="n">GetContext</span><span class="p">().</span><span class="n">GetObject</span><span class="p">(</span><span class="s">&quot;rdvmedecinsDao&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">IDao</span><span class="p">;</span>
<a id="__codelineno-100-8" name="__codelineno-100-8"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-100-9" name="__codelineno-100-9"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-100-10" name="__codelineno-100-10"></a><span class="w">      </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<a id="__codelineno-100-11" name="__codelineno-100-11"></a><span class="w">      </span><span class="p">{...</span>
<a id="__codelineno-100-12" name="__codelineno-100-12"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-100-13" name="__codelineno-100-13"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Dans le programme de test de la couche [DAO], celui-ci instanciait la couche [DAO] de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-101-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1"></a>dao = ContextRegistry.GetContext().GetObject(&quot;rdvmedecinsDao&quot;) as IDao;
</code></pre></div></td></tr></table></div>
<p>Les deux méthodes sont identiques. On se rappelle que cette instanciation de la couche [DAO] s&#x27;appuyait sur une configuration faite dans [App.config]. On remplace alors le contenu actuel [Web.config] du projet web par celui de [App.config] du projet de la couche [DAO] afin d&#x27;avoir la même configuration.</p>
<p>Nous sommes prêts pour une première exécution. La page d&#x27;accueil est affichée [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005F9000001CCA4879DA4.png" style="display:inline-block; margin:4px;width:17.999cm;height:5.413cm;" /></td></tr></table>

<ul>
<li>en [2], on entre un jour de rendez-vous et on valide ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000033F000002B657F264AB.png" style="display:inline-block; margin:4px;width:10.994cm;height:9.181cm;" /></td></tr></table>

<ul>
<li>en [3], une erreur.</li>
</ul>
<p>Lorsqu&#x27;on examine le texte d&#x27;erreur affiché par la page, on s&#x27;aperçoit que l&#x27;exception signalée est celle du <strong>Lazy Loading</strong> : on a essayé de charger une dépendance d&#x27;un objet alors que le contexte de persistance qui le gère a été fermé. L&#x27;objet est maintenant dans un état &quot;<strong> détaché </strong>&quot;. Cette erreur est due au fait que par que NHibernate avait été utilisé en mode <strong>Eager Loading</strong> alors que EF 5 travaille par défaut en <strong>Lazy Loading</strong>. Sur la ligne en rouge ci-dessus :</p>
<ul>
<li><strong>rdv</strong> représente un objet [Rv] qui a été chargé sans ses dépendances ;</li>
<li>pour évaluer <strong>rdv.Creneau.Id</strong>, l&#x27;application essaie de charger la dépendance <strong>rdv.Creneau</strong>. Mais comme on n&#x27;est plus dans le contexte, ce n&#x27;est pas possible, d&#x27;où l&#x27;exception.</li>
</ul>
<p>Ici, la solution est simple. Ligne 108, On crée une entrée dans un dictionnaire avec pour clé la clé primaire du créneau d&#x27;un rendez-vous. Or il se trouve que l&#x27;entité [Rv] encapsule la clé primaire du créneau associé. On écrit donc :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-102-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1"></a>        dicoRvPris[(int)rdv.CreneauId] = rdv;
</code></pre></div></td></tr></table></div>
<p>Nous réessayons l&#x27;exécution. Cette fois-ci l&#x27;erreur est la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004D30000016193C9E2E8.png" style="display:inline-block; margin:4px;width:16.339cm;height:4.671cm;" /></td></tr></table>

<p>L&#x27;erreur est analogue. Ligne 132, on essaie de charger la dépendance [Client] d&#x27;un objet [Rv] dans la couche ASP.NET, donc hors contexte. Il faut aller chercher l&#x27;objet [Client] en base. C&#x27;est pour remédier à ce problème, que l&#x27;interface [IDao] a été enrichie de la méthode suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-103-1">1</a></span>
<span class="normal"><a href="#__codelineno-103-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1"></a><span class="w">    </span><span class="c1">// trouver une entité T via sa clé primaire</span>
<a id="__codelineno-103-2" name="__codelineno-103-2"></a><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">Find</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">class</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>Elle va permettre d&#x27;aller chercher les dépendances. Ainsi la ligne erronée ci-dessus va être réécrite de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-104-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1"></a><span class="w">        </span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Global</span><span class="p">.</span><span class="n">Dao</span><span class="p">.</span><span class="n">Find</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="p">(</span><span class="n">agenda</span><span class="p">.</span><span class="n">Creneaux</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rdv</span><span class="p">.</span><span class="n">ClientId</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>De nouveau on notera l&#x27;intérêt que les entités embarquent leurs clés étrangères. Ici, l&#x27;entité [Rv] nous donne accès à la clé étrangère de la dépendance [Creneau] associée. Ces deux corrections faites, l&#x27;application marche. Le lecteur est invité à tester l&#x27;application [RdvMedecins-SqlServer-03] présente dans les téléchargements des exemples du site web de cet article.</p>
<h2 id="37-conclusion">3.7. Conclusion</h2>
<p>Nous avons mené à bien le portage d&#x27;une application ASP.NET / NHibernate :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005EA0000011D6F289F86.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.388cm;" /></td></tr></table>

<p>vers une application ASP.NET / EF 5 :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000005EB0000012167A2EA92.png" style="display:inline-block; margin:4px;width:17.999cm;height:3.433cm;" /></td></tr></table>

<p>Alors que cette architecture aurait du nous permettre de garder intacte la couche [ASP.NET], nous avons du la modifier pour deux raisons :</p>
<ul>
<li>les entités n&#x27;étaient pas exactement les mêmes. Le type des clés primaires des entités NHibernate était <strong>int</strong> alors que celui de EF 5 était <strong>int?</strong>. Cela nous a amenés à introduire des <em>cast</em> dans le code web ;</li>
<li>le mode de chargement des entités n&#x27;était pas le même pour les deux ORM : <strong>Eager Loading</strong> pour NHibernate, <strong>Lazy loading</strong> pour EF 5. Cela nous a amenés à enrichir l&#x27;interface de la couche [DAO] avec une méthode générique permettant d&#x27;aller chercher une entité via sa clé primaire.</li>
</ul>
<p>Néanmoins, le portage s&#x27;est révélé plutôt simple justifiant de nouveau, si besoin était, l&#x27;architecture en couches et l&#x27;injection de dépendances avec Spring ou un autre framework d&#x27;injection de dépendances.</p>
<p>Nous allons mesurer maintenant l&#x27;impact d&#x27;un changement de SGBD sur l&#x27;architecture précédente. Nous allons porter l&#x27;ensemble des projets précédents vers quatre autres SGBD :</p>
<ul>
<li>Oracle Database Express Edition 11<em>g</em> Release 2 ;</li>
<li>MySQL 5.5.28 ;</li>
<li>PostgreSQL 9.2.1 ;</li>
<li>Firebird 2.1. </li>
</ul>
<p>Les codes ne vont plus changer. Seuls les éléments suivants vont changer :</p>
<ul>
<li>la définition dans les entités du champ utilisé pour contrôler la concurrence d&#x27;accès à une entité ;</li>
<li>les fichiers de configuration [App.config] ou [Web.config] ;</li>
</ul>
<p>Nous ne commenterons que les éléments qui changent.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours-tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "navigation.expand", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>